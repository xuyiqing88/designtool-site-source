<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini AI Pro - 智能对话、识图与创作</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="menu.js" defer></script>
    <style>
        :root {
            --main-color: #5a64ff;
            --btcolor: linear-gradient(113deg, #4c73ff, #6a52ff);
            --text1: #1a1d2e;
            --text2: #4a4e6d;
            --text3: #8d8fa3;
            --line: #e2e4f0;
            --mainbg: #F4F6F9;
            --btactive: #e5e8ff;
            --lightbg: #f8f9ff;
            --shadow: #55537512;
            --card-bg: #ffffff;
            --blur: rgba(255, 255, 255, 0.5);
            --button: #5a64ff24;
            --secondary-tab-active: #eef0ff;
            --secondary-tab-hover: #f6f7ff;
            --user-msg-bg: #eef0ff;
            --ai-msg-bg: #ffffff;
            --success-color: #2ecc71;
            --error-color: #e74c3c;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'HarmonyOS_Sans', 'Microsoft YaHei', 'Arial Unicode MS', sans-serif;
        }

        body {
            background: var(--mainbg);
            color: var(--text1);
            transition: background 0.3s ease;
	        align-items: center;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            border-radius: 24px;
            overflow: hidden;
        }

        header {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 25px 35px 0;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo h1 {
            font-size: 1.8rem;
            font-weight: 700;
            background: var(--btcolor);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        .logo i {
            font-size: 30px;
            background: var(--btcolor);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: pulse 2s infinite;
        }

        .header-actions {
            display: flex;
    	    gap: 12px;
    	    position: fixed;
    	    top: 20px;
    	    right: 20px;
	        z-index: 999;
        }

        .settings-btn {
            background: var(--card-bg);
            border: 1px solid var(--line);
            color: var(--text2);
            font-size: 18px;
            cursor: pointer;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
	        padding: 10px;
	        box-shadow: 0 4px 14px var(--shadow);
        }

        .settings-btn:hover {
            background: var(--btactive);
            color: var(--main-color);
            transform: translateY(-2px);
        }

        .tabs {
            display: flex;
            background: var(--btactive);
            max-width: 500px;
            margin: 25px auto;
            border-radius: 30px;
            padding: 4px;
        }

        .tab-btn {
            flex: 1;
            padding: 10px 25px;
            background: none;
            border: none;
            color: var(--text2);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            justify-content: center;
            border-radius: 26px;
            z-index: 1;
	        box-shadow: none;
        }

        .tab-btn.active {
            color: var(--main-color);
            background: var(--card-bg);
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
        }

        .tab-content {
            min-height: 500px;
            padding: 0 30px 30px;
	        min-width: 880px;
        }

        .tab-pane { display: none; }
        .tab-pane.active { display: block; animation: fadeIn 0.5s ease; }

        .secondary-tabs {
            display: flex;
            background: transparent; /* Changed for underline style */
            border-radius: 0; /* Changed for underline style */
            margin-bottom: 20px;
            padding: 0 4px; /* Adjusted padding */
            border: none; /* Changed for underline style */
        }

        .secondary-tab-btn {
            flex: 1;
            padding: 10px 15px;
            background: none;
            border: none;
            color: var(--text2);
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;	
            justify-content: center;
            border-radius: 0; /* Changed for underline style */
            box-shadow: none;
            position: relative;
        }

        .secondary-tab-btn::after {
            content: '';
            position: absolute;
            left: 50%;
            bottom: -1px; /* Position under the border */
            transform: translateX(-50%);
            width: 0;
            height: 3px;
            background: var(--main-color);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .secondary-tab-btn.active {
            background: transparent; /* Changed for underline style */
            color: var(--main-color);
            font-weight: 600;
            box-shadow: none; /* Changed for underline style */
        }

        .secondary-tab-btn.active::after {
            width: 50%; /* Adjust width of the underline */
        }

        .secondary-tab-btn:hover {
            color: var(--main-color);
        }
        .secondary-tab-btn:not(.active):hover::after {
            width: 40%; /* Smaller underline on hover for non-active tabs */
        }

        .secondary-tab-pane { display: none; }
        .secondary-tab-pane.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .panel {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .panel h2 {
            font-size: 20px;
            margin-bottom: 10px;
            color: var(--text1);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .panel-description {
            color: var(--text2);
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.6;
        }

        .panel h2 i {
            color: var(--main-color);
        }

        .panel-title-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .reset-btn {
            background: var(--mainbg);
            color: var(--text2);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 13px;
            border: 1px solid var(--line);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
		    font-weight: 500;
        }

        .reset-btn:hover {
            background: var(--button);
            transform: translateY(-1px);
        }
        
        textarea, input[type="text"], input[type="password"], select {
            width: 100%;
            padding: 16px 16px 58px;
            border-radius: 8px;
            border: 1px solid var(--line);
            background: var(--mainbg);
            color: var(--text1);
            font-size: 16px;
            resize: vertical;
            transition: all 0.3s;
        }
        textarea { min-height: 160px; }

        textarea:focus, input[type="text"]:focus, input[type="password"]:focus, select:focus {
            outline: none;
            border-color: var(--main-color);
            box-shadow: 0 0 0 3px rgba(89, 99, 255, 0.15);
        }
        
        .input-wrapper {
            position: relative;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        button {
            padding: 10px 24px;
            border-radius: 12px;
            border: none;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
        }

        .btn-primary {
            background: var(--btcolor);
            color: white;
            box-shadow: 0 4px 15px rgba(89, 99, 255, 0.25);
        }

        .btn-primary:hover {
            opacity: 0.92;
            transform: translateY(-3px);
            box-shadow: 0 7px 18px rgba(89, 99, 255, 0.35);
        }

        .btn-secondary {
            background: var(--card-bg);
            color: var(--text2);
            border: 1px solid var(--line);
        }

        .btn-secondary:hover {
            background: var(--btactive);
            color: var(--main-color);
            transform: translateY(-2px);
        }
        
        #clearChatBtn:hover, #clearExpandBtn:hover {
             color: #e74c3c;
             border-color: #f5c8c4;
        }

        .btn-disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        .upload-container {
            position: relative;
            border: 2px dashed var(--line);
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--mainbg);
            min-height: 240px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .upload-container:hover {
            border-color: var(--main-color);
            background: var(--btactive);
        }

        .upload-icon {
            font-size: 48px;
            color: var(--main-color);
            margin-bottom: 18px;
            opacity: 0.7;
        }

        .upload-container p { color: var(--text3); font-size: 16px; }

        #imagePreview {
            max-width: 100%;
            max-height: 320px;
            border-radius: 12px;
            display: none;
            object-fit: contain;
            margin: 0 auto;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .close-preview {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            width: 34px;
            height: 34px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            font-size: 18px;
            transition: all 0.3s;
        }

        .close-preview:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: rotate(90deg);
        }

        .response-area {
            margin-top: 30px;
            border-radius: 10px;
            border: 1px solid var(--line);
            min-height: 160px;
            max-height: 400px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
	    height: 100%;
        }

        .response-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--line);
	        padding: 12px 20px;
	        background: var(--card-bg);
            border-radius: 16px 16px 0 0;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .response-header h3 {
            color: var(--text1);
            font-size: 17px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .response-header h3 i { color: var(--main-color); }

        .copy-btn {
            background: none;
            border: none;
            color: var(--text2);
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 8px;
            background: var(--mainbg);
            transition: all 0.3s;
        }

        .copy-btn:hover {
            background: var(--btactive);
            color: var(--main-color);
            transform: translateY(-1px);
        }

        .response-content {
            color: var(--text2);
            line-height: 1.7;
            font-size: 15px;
	        margin: 20px;
            flex-grow: 1;
        }

        .settings-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 520px;
            z-index: 1000;
            display: none;
            padding: 20px;
            border: 1px solid var(--line);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 999;
            display: none;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .settings-header h2 {
            color: var(--text1);
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .settings-header h2 i { color: var(--main-color); }

        .close-btn {
            background: var(--card-bg);
            color: var(--text2);
            font-size: 20px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .settings-item { margin-bottom: 28px; }

        .settings-item label {
            display: block;
            margin-bottom: 10px;
            color: var(--text1);
            font-weight: 500;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
	justify-content: space-between;
        }
        .settings-item select {
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%238d8fa3' class='bi bi-chevron-down' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
        }


        .settings-item input, .settings-item textarea, .settings-item select {
            width: 100%;
            padding: 8px 18px;
            border-radius: 6px;
            font-size: 15px;
        }
        .settings-item textarea { min-height: 130px; }

        .settings-footer {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 25px;
        }
        
        .alert {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            padding: 16px 35px;
            border-radius: 12px;
            color: white;
            box-shadow: 0 8px 25px var(--shadow);
            z-index: 1001;
            animation: fadeInOut 3s forwards;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .alert.success { background: var(--success-color); }
        .alert.error { background: var(--error-color); }


        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -20px); }
            10% { opacity: 1; transform: translate(-50%, 0); }
            90% { opacity: 1; transform: translate(-50%, 0); }
            100% { opacity: 0; transform: translate(-50%, -20px); }
        }

        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: 8px;
            box-shadow: 0 0 8px;
        }
        
        .status-online { background-color: var(--success-color); color: var(--success-color); }
        .status-offline { background-color: var(--error-color); color: var(--error-color); }

        .chat-history {
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: var(--mainbg);
            border-radius: 10px;
        }
        
        .history-placeholder {
            color: var(--text3);
            text-align: center;
            padding: 40px;
            font-style: italic;
            opacity: 0.7;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 15px;
            height: 100%;
        }
        .history-placeholder i { font-size: 32px; }
        
        .message {
            display: flex;
            gap: 15px;
            max-width: 85%;
            animation: fadeIn 0.4s ease;
        }
        
        .user-message { align-self: flex-end; flex-direction: row-reverse; }
        .ai-message { align-self: flex-start; }
        
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--btactive);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--main-color);
            font-size: 18px;
            flex-shrink: 0;
        }

        .message-bubble {
            padding: 16px 20px;
            border-radius: 12px;
            word-break: break-word; /* Ensure long words break */
        }

        .user-message .message-bubble {
            background: var(--user-msg-bg);
            border-top-right-radius: 4px;
        }
        
        .ai-message .message-bubble {
            background: var(--ai-msg-bg);
            border-top-left-radius: 4px;
        }

        .ai-message.initial .message-bubble {
            background: radial-gradient(185% 45% at 100% 0%, #e6008100, #ffffff), linear-gradient(90deg, #D0EFFF, #d4dcff, #ffd9f2);
        }

        .ai-message.initial .message-content strong {
            font-size: 1.1em; /* Make text larger */
            font-weight: bold; /* Make text bold */
        }
        
        .message-content {
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
            font-size: 15px;
        }
        .message-content img {
            max-width: 100%;
            border-radius: 10px;
            margin-top: 10px;
            cursor: pointer;
        }
        
        .message-footer {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-top: 12px;
            gap: 15px;
        }
        
        .message-time { font-size: 12px; color: var(--text3); }
        
        .copy-message-btn {
            background: none; border: none;
            color: var(--text3);
            font-size: 14px; cursor: pointer;
            display: flex; align-items: center;
            gap: 4px; padding: 4px;
            border-radius: 6px;
            transition: all 0.3s;
        }
        .message-bubble:hover .copy-message-btn { opacity: 1; }
        .copy-message-btn:hover { color: var(--main-color); }
        
        /* Chat Input Area */
        .chat-input-area {
            position: relative;
            margin-top: 10px;
        }
        .chat-input-area .btn-group {
            position: absolute;
            right: 10px;
            bottom: 0;
            transform: translateY(-50%);
            margin: 0;
            gap: 8px;
        }
        .chat-input-area .btn-group button {
            padding: 8px;
            width: 40px;
            height: 40px;
            border-radius: 10px;
	background: none;
    border: none;
        }
        
        #chatFilePreview {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            padding: 8px;
            background-color: var(--mainbg);
            border-radius: 8px;
            display: none; /* Initially hidden */
        }
        #chatFilePreview img {
            width: 40px; height: 40px;
            object-fit: cover;
            border-radius: 6px;
        }
        #chatFilePreview span {
            font-size: 13px;
            color: var(--text2);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        #removeChatFile {
            font-size: 16px;
            margin-left: auto;
            color: var(--text3);
            cursor: pointer;
        }

        /* AI Vision Layout */
        .vision-layout {
            display: grid;
            gap: 25px;
            grid-template-columns: 0.65fr 1.5fr;
        }

        .vision-layout > div {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .vision-layout .upload-container {
            margin-bottom: 0; /* Remove margin from upload container */
        }

        .vision-layout .response-area {
            margin-top: 0; /* Remove margin from response area */
        }

        .vision-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-bottom: 10px;
            margin-right: 10px;
        }
        

        @media (max-width: 768px) {
            .container { border-radius: 20px; }
            header { padding: 20px; margin-top: 40px; }
            .logo h1 { font-size: 1.6rem; }
            button { padding: 14px; }
            .tab-content { padding: 0; min-width: 100%; }
            .tabs { margin: 20px; }
            .panel { padding: 14px; }
            
            .btn-group { flex-direction: row; } /* Keep horizontal on mobile */
            
            .secondary-tabs { flex-direction: row; gap: 5px; }
            
            .message { max-width: 95%; }
	.chat-history {    height: 260px;     padding: 12px;}

            .vision-layout {
                flex-direction: column;
		display: flex;
            }
	.upload-container {min-height: 190px;}
	.settings-modal {padding: 10px;}
        }
    </style>
</head>
<script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "0fa9d31287314fffb488e27ef3d5c9d7"}'></script>
<body>
<div id="global-sidebar"></div>
    <div class="container">
            <div class="header-actions">
                <button class="settings-btn" id="settingsBtn" title="打开设置">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        <header>
            <div class="logo">
                <h1>Gemini AI Pro <span class="status-indicator" id="apiStatus"></span></h1>
            </div>

        </header>
        
        <div class="tabs">
            <button class="tab-btn active" data-tab="chat">
                <i class="fas fa-comments" style="margin-right: 8px;"></i> AI对话
            </button>
            <button class="tab-btn" data-tab="vision">
                <i class="fas fa-image" style="margin-right: 8px;"></i> AI视觉
            </button>
        </div>
        
        <div class="tab-content">
            <div class="tab-pane active" id="chatTab">
                <div class="panel">
                    <div class="secondary-tabs">
                        <button class="secondary-tab-btn active" data-subtab="conversation" data-parent="chat">自由对话
                        </button>
                        <button class="secondary-tab-btn" data-subtab="prompt" data-parent="chat">提示词扩写
                        </button>
                    </div>
                
                    <div class="secondary-tab-pane active" id="conversationSubTab">
                        <h2 style="display: none;">自由对话</h2>
                        <p class="panel-description">
                            与Gemini进行自由对话，获取帮助、解答问题或进行创意交流。您还可以上传图片进行多模态对话。
                        </p>
                        
                        <div class="chat-history scrollable" id="chatHistory">
                            <div class="message ai-message initial">
                                <div class="message-avatar"><i class="fas fa-robot"></i></div>
                                <div class="message-bubble">
                                    <div class="message-content"><strong>您好 👏🏻😊<br>我是您身边的智能助手</strong><br>我可以为您答疑解惑，尽情创造，快来体验吧~</div>
                                </div>
                            </div>
                        </div>

                        <div id="chatFilePreview">
                            <img id="chatFilePreviewImg" src="" alt="preview">
                            <span id="chatFilePreviewName"></span>
                            <i class="fas fa-times-circle" id="removeChatFile" title="移除文件"></i>
                        </div>
                        
                        <div class="chat-input-area">
                            <textarea id="chatInput" placeholder="输入您的问题或想法（按Enter发送，Shift+Enter换行）" rows="1"></textarea>
                            <div class="btn-group">
                                <button class="btn-secondary" id="uploadChatFileBtn" title="上传图片">
                                    <i class="fas fa-paperclip"></i>
                                </button>
                                 <button class="btn-secondary" id="clearChatBtn" title="清空对话历史">
                                    <i class="fas fa-eraser"></i>
                                </button>
                                <button class="btn-primary" id="sendBtn" title="发送消息" style="width: 62px; background: var(--btcolor);">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                        <input type="file" id="chatFileUpload" accept="image/*" style="display: none;">
                    </div>

                    <div class="secondary-tab-pane" id="promptSubTab">
                         <h2 style="display: none;">提示词扩写</h2>
                        <p class="panel-description">
                            输入您的原始提示词，Gemini将为您扩展优化，生成更适合AI绘画、更具想象力的详细描述。
                        </p>
                        <div class="chat-input-area">
                             <textarea id="promptInput" placeholder="在此输入您的原始提示词..."></textarea>
                             <div class="btn-group">
                                <button class="btn-secondary" id="clearExpandBtn">
                                    <i class="fas fa-eraser"></i>
                                </button>
                                <button class="btn-primary" id="expandBtn" style="width: 62px; background: var(--btcolor);">
                                    <i class="fas fa-wand-magic-sparkles"></i>
                                </button>
                            </div>
                        </div>
                        <input type="file" id="promptFileUpload" accept="image/*" style="display: none;">
                    </div>
                </div>
            </div>
            
            <div class="tab-pane" id="visionTab">
                <div class="panel">
                    <div id="image-analysisSubTab">
                        <h2><i class="fas fa-search-plus"></i> 图像分析</h2>
                        <p class="panel-description">
                            上传图片，Gemini将自动分析图像内容并生成详细的描述提示词。
                        </p>
                        <div class="vision-layout">
                            <div>
                                <div class="upload-container" id="uploadArea">
                                    <div id="uploadContent">
                                        <i class="fas fa-cloud-upload-alt upload-icon"></i>
                                        <p>拖放图片到此处或<br><b>点击上传</b></p>
                                    </div>
                                    <img id="imagePreview" alt="预览图片">
                                    <div class="close-preview" id="closePreview" style="display: none;">
                                        <i class="fas fa-times"></i>
                                    </div>
                                    <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                                </div>

                            </div>
                            <div>
                                <div class="response-area" id="visionResponseArea">
                                    <div class="response-header">
                                        <h3> Gemini分析结果</h3>
                                        <button class="copy-btn" id="copyVisionBtn" title="复制结果">
                                            <i class="fas fa-copy"></i> 复制
                                        </button>
                                    </div>
                                    <div class="response-content" id="visionResponse">
                                        图片上传后将自动分析...
                                    </div>
                                    <div class="btn-group vision-buttons">
                                        <button class="btn-primary" id="regenerateVisionBtn">
                                            <i class="fas fa-sync-alt"></i> 重新生成
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="modalOverlay"></div>
    
    <div class="settings-modal" id="settingsModal">
        <div class="settings-header">
            <h2>设置</h2>
            <button class="close-btn" id="closeSettings">&times;</button>
        </div>

        <div style="max-height: 60vh; overflow-y: auto; padding: 0 10px;">
            <div class="settings-item">
                <label for="apiKey">Gemini API 密钥</label>
                <input type="password" id="apiKey" placeholder="输入您的Gemini API密钥">
                <p style="color: var(--text3); font-size: 13px; margin-top: 8px;">
                    密钥只保存在您的浏览器中，不会被发送到任何服务器。
                </p>
            </div>
            
             <div class="settings-item">
                <label for="modelSelection">模型选择</label>
                <select id="modelSelection">
                    <option value="gemini-1.5-flash-latest">Gemini 1.5 Flash (快速/经济)</option>
                    <option value="gemini-2.5-pro">Gemini 2.5 Pro (强大/稳定)</option>
			<option value="gemini-2.5-flash">Gemini 2.5 flash (快速)</option>
                </select>
                 <p style="color: var(--text3); font-size: 13px; margin-top: 8px;">
                    选择用于所有AI功能的模型。两者均支持多模态。
                </p>
            </div>

            <div class="settings-item">
                <label for="promptTemplate">
                    <div class="panel-title-wrapper">
                        提示词扩写模板
			</div>
                        <button class="reset-btn" id="resetPromptBtn">
                            <i class="fas fa-undo"></i> 恢复默认
                        </button>
                    
                </label>
                <textarea id="promptTemplate"></textarea>
            </div>
            
            <div class="settings-item">
                <label for="visionTemplate">
                    <div class="panel-title-wrapper">
                        图像识别模板
			</div>
                        <button class="reset-btn" id="resetVisionBtn">
                            <i class="fas fa-undo"></i> 恢复默认
                        </button>
                    
                </label>
                <textarea id="visionTemplate"></textarea>
            </div>
        </div>

        <div class="settings-footer">
            <button class="btn-secondary" id="cancelSettings">取消</button>
            <button class="btn-primary" id="saveSettings">保存设置</button>
        </div>
    </div>
    
    <script>
    // 默认设置
    const defaultPromptTemplate = "As a prompt optimization expert, enhance the user's original prompt to be more detailed and expressive for an image generation model. Add rich details while keeping the core concept. The final prompt should be suitable for models like Stable Diffusion or Midjourney.";
    const defaultVisionTemplate = "Describe the uploaded image in detail, covering the main subjects, setting, colors, style, and atmosphere. Then, based on your description, generate a high-quality, detailed prompt suitable for an image generation model.";
    
    // DOM元素
    document.addEventListener('DOMContentLoaded', () => {
        // 全局元素
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const modalOverlay = document.getElementById('modalOverlay');
        const closeSettings = document.getElementById('closeSettings');
        const cancelSettings = document.getElementById('cancelSettings');
        const saveSettings = document.getElementById('saveSettings');
        const apiStatus = document.getElementById('apiStatus');

        // 设置面板元素
        const apiKeyInput = document.getElementById('apiKey');
        const modelSelection = document.getElementById('modelSelection');
        const promptTemplateInput = document.getElementById('promptTemplate');
        const visionTemplateInput = document.getElementById('visionTemplate');
        const resetPromptBtn = document.getElementById('resetPromptBtn');
        const resetVisionBtn = document.getElementById('resetVisionBtn');

        // 标签页
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabPanes = document.querySelectorAll('.tab-pane');
        const secondaryTabBtns = document.querySelectorAll('.secondary-tab-btn');
        const secondaryTabPanes = document.querySelectorAll('.secondary-tab-pane');

        // 对话功能元素
        const expandBtn = document.getElementById('expandBtn');
        const clearExpandBtn = document.getElementById('clearExpandBtn');
        const promptInput = document.getElementById('promptInput');
        const sendBtn = document.getElementById('sendBtn');
        const clearChatBtn = document.getElementById('clearChatBtn');
        const chatInput = document.getElementById('chatInput');
        const chatHistory = document.getElementById('chatHistory');
        const uploadChatFileBtn = document.getElementById('uploadChatFileBtn');
        const chatFileUpload = document.getElementById('chatFileUpload');
        const chatFilePreview = document.getElementById('chatFilePreview');
        const chatFilePreviewImg = document.getElementById('chatFilePreviewImg');
        const chatFilePreviewName = document.getElementById('chatFilePreviewName');
        const removeChatFile = document.getElementById('removeChatFile');

        // 视觉功能元素
        const uploadArea = document.getElementById('uploadArea');
        const uploadContent = document.getElementById('uploadContent');
        const imageUpload = document.getElementById('imageUpload');
        const imagePreview = document.getElementById('imagePreview');
        const closePreview = document.getElementById('closePreview');
        const visionResponse = document.getElementById('visionResponse');
        const copyVisionBtn = document.getElementById('copyVisionBtn');
        const regenerateVisionBtn = document.getElementById('regenerateVisionBtn'); // Added regenerate button

        // 状态变量
        let apiHistory = [];
        let displayHistory = [];
        let chatUploadedFile = null; // 用于存储待上传的聊天文件
        let visionUploadedFile = null; // Store the file for regeneration
        let tempSettings = {}; // 用于临时存储设置
        let lastRequestTime = 0;
        const REQUEST_INTERVAL = 2000; // 2秒请求间隔

        // --- 初始化 ---
        loadSettings();
        checkApiStatus();
        setupEventListeners();

        // --- 事件监听器设置 ---
        function setupEventListeners() {
            // 设置模态框
            settingsBtn.addEventListener('click', openSettingsModal);
            closeSettings.addEventListener('click', closeModal);
            cancelSettings.addEventListener('click', closeModal);
            modalOverlay.addEventListener('click', closeModal);
            saveSettings.addEventListener('click', saveAndCloseSettings);

            // 模板重置
            resetPromptBtn.addEventListener('click', () => promptTemplateInput.value = defaultPromptTemplate);
            resetVisionBtn.addEventListener('click', () => visionTemplateInput.value = defaultVisionTemplate);
            
            // 标签页切换
            tabBtns.forEach(btn => btn.addEventListener('click', () => switchTab(btn, tabBtns, tabPanes, 'tab')));
            // FIX ISSUE #3: Scope the secondary panes selection to the parent tab pane.
            secondaryTabBtns.forEach(btn => btn.addEventListener('click', () => switchTab(btn, document.querySelectorAll(`.secondary-tab-btn[data-parent="${btn.dataset.parent}"]`), btn.closest('.tab-pane').querySelectorAll('.secondary-tab-pane'), 'subtab')));

            // 提示词扩写
            expandBtn.addEventListener('click', handleExpandPrompt);
            clearExpandBtn.addEventListener('click', () => promptInput.value = '');
            promptInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    expandBtn.click();
                }
            });

            // 自由对话
            sendBtn.addEventListener('click', handleSendMessage);
            clearChatBtn.addEventListener('click', clearChat);
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendBtn.click();
                }
            });

            // 对话中上传文件
            uploadChatFileBtn.addEventListener('click', () => chatFileUpload.click());
            chatFileUpload.addEventListener('change', handleChatFileSelect);
            removeChatFile.addEventListener('click', removeChatUploadedFile);

            // 图像分析
            uploadArea.addEventListener('click', () => imageUpload.click());
            imageUpload.addEventListener('change', handleVisionFileSelect);
            closePreview.addEventListener('click', resetVisionUpload);
            copyVisionBtn.addEventListener('click', copyVisionResult);
            regenerateVisionBtn.addEventListener('click', handleRegenerateVision); // Added regenerate event listener

            // 图像分析拖放
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => uploadArea.classList.add('highlight'), false);
            });
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('highlight'), false);
            });
            uploadArea.addEventListener('drop', handleDrop, false);

            // 对话历史中的复制按钮 (事件委托)
            document.addEventListener('click', (e) => {
                const copyBtn = e.target.closest('.copy-message-btn');
                if (copyBtn) {
                    const messageContent = copyBtn.closest('.message-bubble').querySelector('.message-content').innerText;
                    navigator.clipboard.writeText(messageContent).then(() => {
                        showAlert('已复制消息内容', 'success');
                    });
                }
            });
        }

        // --- 核心功能函数 ---
        
        function switchTab(clickedBtn, allBtns, allPanes, paneIdPrefix) {
            allBtns.forEach(b => b.classList.remove('active'));
            allPanes.forEach(pane => pane.classList.remove('active'));
            
            clickedBtn.classList.add('active');
            const targetPane = document.getElementById(`${clickedBtn.dataset[paneIdPrefix]}SubTab`) || document.getElementById(`${clickedBtn.dataset[paneIdPrefix]}Tab`);
            if (targetPane) {
                targetPane.classList.add('active');
            }
        }
        
        async function handleExpandPrompt() {
            const prompt = promptInput.value.trim();
            if (!prompt) return showAlert('请输入要扩写的提示词', 'error');
            if (!checkRequestFrequency()) return;

            const template = localStorage.getItem('promptTemplate') || defaultPromptTemplate;
            const fullPrompt = `${template}\n\nOriginal Prompt: ${prompt}`;
            
            setButtonLoading(expandBtn, true, '');
            try {
                const contents = [{ role: "user", parts: [{ text: fullPrompt }] }];
                const expandedPrompt = await callGeminiApi(contents);
                promptInput.value = expandedPrompt;
                showAlert('提示词扩写完成！', 'success');
            } catch (error) {
                showAlert(`扩写失败: ${error.message}`, 'error');
            } finally {
                setButtonLoading(expandBtn, false, '<i class="fas fa-wand-magic-sparkles"></i>');
            }
        }

        async function handleSendMessage() {
            const message = chatInput.value.trim();
            if (!message && !chatUploadedFile) return showAlert('请输入消息或上传图片', 'error');
            if (!checkRequestFrequency()) return;

            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // Prepare user message (may contain text and image)
            const userParts = [];
            if (message) userParts.push({ text: message });
            if (chatUploadedFile) {
                userParts.push({
                    inline_data: {
                        mime_type: chatUploadedFile.mime,
                        data: chatUploadedFile.base64
                    }
                });
            }
            
            // Update history
            displayHistory.push({
                role: 'user', content: message, timestamp,
                image: chatUploadedFile ? `data:${chatUploadedFile.mime};base64,${chatUploadedFile.base64}` : null
            });
            apiHistory.push({ role: "user", parts: userParts });

            renderChatHistory();
            chatInput.value = '';
            removeChatUploadedFile(); // Clear after sending
            
            setButtonLoading(sendBtn, true, '');

            try {
                const response = await callGeminiApi(apiHistory);
                
                const aiTimestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                displayHistory.push({ role: 'ai', content: response, timestamp: aiTimestamp });
                apiHistory.push({ role: "model", parts: [{ text: response }] });
                
                renderChatHistory();
            } catch (error) {
                showAlert(`发送失败: ${error.message}`, 'error');
                renderChatHistory(); // Re-render to show current state after error
            } finally {
                setButtonLoading(sendBtn, false, '<i class="fas fa-paper-plane"></i>');
            }
        }

        function clearChat() {
            apiHistory = [];
            displayHistory = [];
            // Add the default AI message back after clearing
            displayHistory.push({
                role: 'ai',
                content: '<strong>您好 👏🏻😊<br>我是您身边的智能助手</strong><br>我可以为您答疑解惑，尽情创造，快来体验吧~',
                timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                initial: true // Mark as initial message
            });
            renderChatHistory();
            showAlert('对话历史已清空', 'success');
        }

        async function handleVisionFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                visionUploadedFile = file; // Store the file
                await processAndAnalyzeImage(file);
            }
        }

        async function handleRegenerateVision() {
            if (!visionUploadedFile) {
                showAlert('请先上传图片', 'error');
                return;
            }
            await processAndAnalyzeImage(visionUploadedFile);
        }

        async function processAndAnalyzeImage(file) {
             if (!checkRequestFrequency()) {
                imageUpload.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = async (event) => {
                imagePreview.src = event.target.result;
                imagePreview.style.display = 'block';
                closePreview.style.display = 'flex';
                uploadContent.style.display = 'none';

                visionResponse.textContent = '正在分析图片...';
                
                try {
                    const template = localStorage.getItem('visionTemplate') || defaultVisionTemplate;
                    const base64Image = event.target.result.split(',')[1];
                    const mimeType = file.type;

                    const contents = [{
                        parts: [
                            { text: template },
                            { inline_data: { mime_type: mimeType, data: base64Image } }
                        ]
                    }];

                    const analysis = await callGeminiApi(contents);
                    visionResponse.textContent = analysis;
                    showAlert('图片分析完成！', 'success');
                } catch (error) {
                    showAlert(`分析失败: ${error.message}`, 'error');
                    visionResponse.textContent = '分析失败，请重试。';
                }
            };
            reader.readAsDataURL(file);
        }
        
        function resetVisionUpload(e) {
            if (e) e.stopPropagation();
            imagePreview.style.display = 'none';
            closePreview.style.display = 'none';
            imagePreview.src = '';
            imageUpload.value = '';
            uploadContent.style.display = 'block';
            visionResponse.textContent = '图片上传后将自动分析...';
            visionUploadedFile = null; // Clear the stored file
        }

        function copyVisionResult() {
            const text = visionResponse.textContent;
            if (text && text !== '图片上传后将自动分析...') {
                navigator.clipboard.writeText(text).then(() => showAlert('已复制到剪贴板！', 'success'));
            } else {
                showAlert('没有可复制的内容', 'error');
            }
        }
        
        // --- 设置管理 ---
        function loadSettings() {
            const settings = {
                apiKey: localStorage.getItem('apiKey') || '',
                model: localStorage.getItem('geminiModel') || 'gemini-1.5-flash-latest',
                promptTemplate: localStorage.getItem('promptTemplate') || defaultPromptTemplate,
                visionTemplate: localStorage.getItem('visionTemplate') || defaultVisionTemplate,
            };

            apiKeyInput.value = settings.apiKey;
            modelSelection.value = settings.model;
            promptTemplateInput.value = settings.promptTemplate;
            visionTemplateInput.value = settings.visionTemplate;
        }

        function openSettingsModal() {
            // Save current form state to temporary variables
            tempSettings = {
                apiKey: apiKeyInput.value,
                model: modelSelection.value,
                promptTemplate: promptTemplateInput.value,
                visionTemplate: visionTemplateInput.value,
            };
            settingsModal.style.display = 'block';
            modalOverlay.style.display = 'block';
        }
        
        function closeModal() {
            // Restore settings from temporary variables
            apiKeyInput.value = tempSettings.apiKey;
            modelSelection.value = tempSettings.model;
            promptTemplateInput.value = tempSettings.promptTemplate;
            visionTemplateInput.value = tempSettings.visionTemplate;
            
            settingsModal.style.display = 'none';
            modalOverlay.style.display = 'none';
        }

        function saveAndCloseSettings() {
            localStorage.setItem('apiKey', apiKeyInput.value);
            localStorage.setItem('geminiModel', modelSelection.value);
            localStorage.setItem('promptTemplate', promptTemplateInput.value);
            localStorage.setItem('visionTemplate', visionTemplateInput.value);
            
            checkApiStatus();
            showAlert('设置已保存！', 'success');
            
            settingsModal.style.display = 'none';
            modalOverlay.style.display = 'none';
        }

        // --- Render and UI Update ---

        function renderChatHistory() {
            chatHistory.innerHTML = '';
            
            displayHistory.forEach(msg => {
                const messageContainer = document.createElement('div');
                // Apply 'initial' class only to the first AI message if it's marked as such
                messageContainer.className = `message ${msg.role}-message ${msg.initial ? 'initial' : ''}`;
                
                const avatarIcon = msg.role === 'user' ? 'fa-user' : 'fa-robot';
                const imageContent = msg.image ? `<img src="${msg.image}" alt="uploaded content" style="max-width: 100%; border-radius: 10px; margin-top: 10px;">` : '';

                messageContainer.innerHTML = `
                    <div class="message-avatar"><i class="fas ${avatarIcon}"></i></div>
                    <div class="message-bubble">
                        <div class="message-content">${msg.content}${imageContent}</div>
                        <div class="message-footer">
                            <span class="message-time">${msg.timestamp}</span>
                            ${msg.role === 'ai' ? `<button class="copy-message-btn" title="复制"><i class="fas fa-copy"></i></button>` : ''}
                        </div>
                    </div>
                `;
                chatHistory.appendChild(messageContainer);
            });
            
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        function showAlert(message, type = 'success') {
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
            alert.innerHTML = `<i class="fas ${icon}"></i> ${message}`;
            document.body.appendChild(alert);
            
            setTimeout(() => alert.remove(), 3000);
        }

        function setButtonLoading(button, isLoading, loadingText) {
            button.disabled = isLoading;
            if (isLoading) {
                button.classList.add('btn-disabled');
                // Store original content only if it hasn't been stored yet
                if (!button.dataset.originalContent) {
                    button.dataset.originalContent = button.innerHTML;
                }
                button.innerHTML = `<span class="loader"></span> ${loadingText || ''}`;
            } else {
                button.classList.remove('btn-disabled');
                // Restore original content, and then clear it
                if(button.dataset.originalContent) {
                    button.innerHTML = button.dataset.originalContent;
                    button.dataset.originalContent = '';
                }
            }
        }
        
        // --- API Call ---

        async function callGeminiApi(contents) {
            const apiKey = localStorage.getItem('apiKey');
            const model = localStorage.getItem('geminiModel') || 'gemini-1.5-flash-latest';
            if (!apiKey) throw new Error('请先在设置中填写您的Gemini API密钥');

            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: contents,
                    generationConfig: {
                        temperature: 0.7,
                        maxOutputTokens: 2048
                    }
                })
            });

            const data = await response.json();

            if (!response.ok || !data.candidates) {
                console.error('API Error:', data);
                throw new Error(data.error?.message || 'API请求失败，请检查密钥或网络连接');
            }

            return data.candidates[0].content.parts[0].text;
        }

        async function checkApiStatus() {
            const apiKey = localStorage.getItem('apiKey');
            if (!apiKey) {
                updateApiStatus(false, '未设置API密钥');
                return;
            }
            
            try {
                // Use a very simple request to test the connection
                await callGeminiApi([{ role: "user", parts: [{ text: "Hello" }] }]);
                updateApiStatus(true, 'API连接正常');
            } catch (error) {
                updateApiStatus(false, `API连接失败: ${error.message}`);
            }
        }
        
        function updateApiStatus(isOnline, title) {
            apiStatus.className = `status-indicator status-${isOnline ? 'online' : 'offline'}`;
            apiStatus.title = title;
        }

        // --- Helper and Drag & Drop Functions ---

        function handleChatFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                chatUploadedFile = {
                    base64: event.target.result.split(',')[1],
                    mime: file.type,
                    name: file.name
                };
                chatFilePreviewImg.src = event.target.result;
                chatFilePreviewName.textContent = file.name;
                chatFilePreview.style.display = 'flex';
            };
            reader.readAsDataURL(file);
        }

        function removeChatUploadedFile() {
            chatUploadedFile = null;
            chatFileUpload.value = ''; // Clear file input
            chatFilePreview.style.display = 'none';
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleDrop(e) {
            let dt = e.dataTransfer;
            let file = dt.files[0];
            if (file && file.type.startsWith('image/')) {
                 visionUploadedFile = file; // Store the file
                 processAndAnalyzeImage(file);
            }
        }

        function checkRequestFrequency() {
            const now = Date.now();
            if (now - lastRequestTime < REQUEST_INTERVAL) {
                showAlert('操作过于频繁，请稍后再试', 'error');
                return false;
            }
            lastRequestTime = now;
            return true;
        }

        // Initialize chat history with the default message
        clearChat(); // This function now correctly initializes the history with the default message
    });
</script>
</body>
</html>