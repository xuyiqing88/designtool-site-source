<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PBR全流程贴图生成器 - 一键生成法线/置换/AO/反射/光泽度贴图（GPU加速+3D预览）</title>
    <script src="https://cdn.jsdelivr.net/npm/utif@3.1.0/UTIF.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script src="menu.js" defer></script>
    <link rel="icon" href="img/gongjuxiang.svg" type="image/svg">

     <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        :root {
            --main-color: #8080FF;
            --reverse-color: #FF8A65;
            --bg-background: #242428;
            --btcolor: linear-gradient(to left, #6450ff, #8f56fa);
            --text1: #fff;
            --text2: #c7d1e2;
            --text3: #969dbb;
            --line: #7878784d;
            --mainbg: #2e2e33d9;
            --shadow: #8080ff99;
            --btbg: #babac5;
            --lightbg: #36363b;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1b1c;
            min-height: 100vh;
            overflow-x: hidden;
            color: var(--text2);
        }
        .icon {
    display: inline-block;
    width: 1.2em;
    height: 1.2em;
    fill: currentColor;
}
	.under {
		display: grid; 
		grid-template-columns: 1fr 1fr;
		font-size: 0.9rem;
		padding: 0 16px;
	}
        .topgroup {
            gap: 10px;
            display: flex;
            position: fixed;
            margin-top: 20px;
            left: 20px;
            background: #2b2b2f;
            border-radius: 30px;
            padding: 4px;
            z-index: 999;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        .home-icon {
            font-size: 40px;
            cursor: pointer;
            transition: all 0.3s;
            padding: 8px; 
            border-radius: 50%;
            width: 1em; 
            height: 1em;
            vertical-align: -0.15em;
            overflow: hidden;
        }
        .topgroup:hover {
            background:#36363b;
        }
        .kuang {
            background: var(--lightbg);
            border-radius: 8px;
            border: 1px solid var(--line);
        }
        .scrib{
            color: var(--text3); 
            font-size: 0.9rem;
            margin-left: 10px;
            font-weight: 400;
        }
        .canshu {
            background: #2b2b2f;
            padding: 0 6px;
            border-radius: 4px;
        }
        .line {
            width: 100%;
            height: 1px;
            background: var(--line);
        }
        .line2 {
            width: 100%;
            height: 1px;
            background: #0a0a14b3;
        }
        .container {
            max-width: 1300px;
            margin: 0 auto;
            padding: 20px;
	display: flex;
    flex-direction: column;
    gap: 10px;
        }
        
        header {
            text-align: center;
            position: relative;
            overflow: hidden;
            padding: 0 20px;
	    margin-bottom: 10px;
        }
        
        h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: var(--main-color);
            letter-spacing: 1px;
            position: relative;
	    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
	margin-top: 20px;
        }
        
        .header-subtitle {
            color: var(--text3);
            font-size: 0.9rem;
            max-width: 800px;
            margin: 0 auto
        }
        
        .content-n {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        
        .panel {
            background: var(--mainbg);
            border-radius: 10px;
            padding: 20px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
            height: 100%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .panel h2 {
            font-size: 1rem;
            margin-bottom: 25px;
            color: var(--text1);
            display: flex;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--line);
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            padding: 10px 16px;
            justify-content: space-between;
        }
        

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        label {
            color: var(--text2);
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.95rem;
	justify-content: space-between;
        }
        
        input[type="range"] {
            width: 100%;
            height: 6px;
            background: var(--main-color);
            border-radius: 5px;
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid var(--main-color);
            transition: all 0.2s ease;
            box-shadow: 0 0 8px rgba(128, 128, 255, 0.6);
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }
        
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--main-color);
            cursor: pointer;
        }
        
        .btn-group {
            display: flex;
            gap: 15px;
            grid-column: 1 / -1;
            margin: 16px 0 20px 0;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        button {
            background: none;
            color: #fff;
            border: none;
            padding: 16px 20px;
            border-radius: 30px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            position: relative;
            overflow: hidden;
            height: 40px;
	    width: 30%;
        }
        
        button:hover {
            box-shadow: 0px 8px 10px var(--bg-background);
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        #downloadMapBtn {
            background: var(--btcolor);
            color: #fff;
        }
        
        #downloadMapBtn:hover {
            box-shadow: 0 10px 16px -6px var(--shadow);
        }
        
        .canvas-container {
            position: relative;
            background: rgba(10, 10, 20, 0.7);
            border-radius: 8px;
            overflow: hidden;
            min-height: 270px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(128, 128, 255, 0.1);
            width: 100%;
        }
        
        .canvas-container:hover {
            border-color: var(--main-color);
        }
        
        canvas {
            max-width: 100%;
            max-height: 320px;
            background: #111;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.6);
            image-rendering: -moz-crisp-edges;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            -ms-interpolation-mode: nearest-neighbor;
            transition: transform 0.3s ease;
        }
        
        canvas:hover {
            transform: scale(1.015);
        }
        
        .placeholder {
            color: var(--text2);
            text-align: center;
            padding: 40px;
            font-size: 1rem;
            line-height: 1.7;
        }
        
        .placeholder svg {
            font-size: 3.5rem;
            display: block;
            margin-bottom: 25px;
            color: var(--text2);
            text-shadow: 0 0 15px rgba(128, 128, 255, 0.4);
        }
        
        .value-display {
            display: flex;
            justify-content: space-between;
            font-size: 1rem;
            color: #90caf9;
            background: rgba(0, 0, 40, 0.5);
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid var(--line);
            color: var(--text3);
            font-size: 1rem;
        }
        
        .example-images {
            display: flex;
            gap: 20px;
            margin-right: 20px;
            flex-direction: column;
        }
        
        .example-image {
            width: 70px;
            height: 70px;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            opacity: 0.9;
            transition: all 0.3s ease;
            border: 2px solid var(--line);
            position: relative;
        }
        
        .example-image:hover {
            opacity: 1;
            transform: translateY(-7px);
            border-color: #8080FF;
            box-shadow: 0 8px 20px rgba(128, 128, 255, 0.6);
        }
        
        .example-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .example-image .label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(0deg, #242424, transparent);
            color: white;
            text-align: center;
            font-size: 0.8rem;
        }
        
        .progress-container {
            display: none;
            z-index: 999;
            position: fixed;
            padding: 10px 20px;
            margin: 0 auto;
            width: 30%;
            background: var(--line);
            border-radius: 10px;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            left: 0;
            right: 0;
            top: 50px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }
        
        .progress-bar {
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00c853, #76ff03);
            width: 0%;
            transition: width 0.4s ease;
            border-radius: 6px;
        }
        
        .quality-indicator {
            display: flex;
            justify-content: space-between;
            font-size: 0.95rem;
            color: var(--text2);
            margin-bottom: 10px;
        }
        
        .param-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--text3);
        }
        
        .section-title {
            text-align: center;
            margin: 20px 0 15px;
            color: #bbdefb;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .file-upload-area {
            background: var(--bg-background);
            border-radius: 10px;
            padding: 20px;
            border: 2px dashed var(--line);
            text-align: center;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .file-upload-area:hover {
            border-color: var(--main-color);
            background: rgba(0, 0, 30, 0.4);
        }
        
        .file-upload-area label {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            font-size: 1rem;
	justify-content: center;
        }
        
        .file-upload-area svg {
            font-size: 3rem;
            color: #454559;
            transition: all 0.3s ease;
	    margin-right: 10px;
        }
        
        .file-upload-area:hover svg {
            color: var(--main-color);
        }
        
        .info-text {
            background: rgba(10, 10, 20, 0.6);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 0.95rem;
            color: var(--text3);
            line-height: 1.7;
        }
        
        .info-text svg {
            color: var(--main-color);
            margin-right: 8px;
        }
        
        .panel-title {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            justify-content: space-between;
            margin-top: 16px;
        }
        
        .panel-title h2 {
            margin: 0;
            padding-bottom: 0;
            border: none;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
        }
        
        .close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }
        
        .close:hover,
        .close:focus {
            color: #8080FF;
            text-decoration: none;
        }
        
        .drag-over {
            border-color: var(--main-color) !important;
            background: rgba(128, 128, 255, 0.1) !important;
        }
        
        .reverse-info {
            background: rgba(255, 138, 101, 0.1);
            border-left: 4px solid var(--reverse-color);
            padding: 15px;
            border-radius: 0 8px 8px 0;
            margin-top: 15px;
            font-size: 0.9rem;
        }
        
        .algorithm-info {
            display: flex;
            flex-direction: row;
            gap: 10px;
            margin-top: 15px;
            align-items: center;
        }
        
        .algorithm-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .algorithm-option input[type="radio"] {
            accent-color:var(--main-color);
        }
        
        .algorithm-option label {
            cursor: pointer;
            font-size: 0.9rem;
        }
        .algorithm-option label:hover {
            color: var(--main-color);
        }
        .algorithm-description {
            font-size: 0.8rem;
            color: var(--text3);
            padding-left: 28px;
            margin-top: 4px;
        }
        
        .format-badge {
            background: rgba(128, 128, 255, 0.2);
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 0.8rem;
            margin-left: 8px;
        }
        
        .drag-hint {
            position: absolute;
            bottom: 15px;
            left: 0;
            right: 0;
            text-align: center;
            color: var(--text3);
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .mode-toggle {
            display: flex;
            justify-content: center;
        }
        
        .toggle-btn {
            border: 1px solid var(--btbg);
            color: var(--btbg);
            padding: 6px 19px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .toggle-btn.active {
            background: var(--btbg);
            color: #000;
        }
        
        .toggle-btn:hover {
            background: var(--btbg);
            color: #000;
        }
        
        .perf-info {
            background: var(--lightbg);
            padding: 10px;
            border-radius: 8px;
            margin-top: 16px;
            text-align: center;
            font-size: 0.9rem;
            display: flex;
    justify-content: center;
    align-items: center;
    gap: 4px;
        }
        
        .value-input {
            background: var(--bg-background);
            border: 1px solid #454559;
            color: var(--text1);
            border-radius: 4px;
            padding: 6px 8px;
            width: 70px;
            text-align: center;
            font-size: 0.95rem;
            outline: none;
        }
        
        .value-input:focus {
            border-color: var(--main-color);
            box-shadow: 0 0 5px rgba(128, 128, 255, 0.5);
        }
        
        .size-toggle {
            display: flex;
            gap: 10px;
        }
        
        .size-toggle .toggle-btn {
            border-radius: 30px;
            padding: 4px 12px;
            font-size: 0.8rem;
        }
        
        #preview3dContainer {
            position: relative;
            width: 100%;
            height: 320px;
            background: #111;
            border-radius: 8px;
            overflow: hidden;
            display: none;
            margin-top: 20px;
        }
        
        #preview3dContainer canvas {
            width: 100%;
            height: 100%;
            display: block;
            border-radius: 8px;
        }
        
        .preview-controls {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 10;
            display: flex;
        }
        
        .preview-controls .toggle-btn {
            padding: 4px 10px;
            font-size: 0.75rem;
            margin-right: -1px;
        }
        
        .preview-hint {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text3);
            font-size: 0.9rem;
            text-align: center;
            max-width: 80%;
        }

        .preview-ready {
            display: block !important;
        }
        
        .progress-fill {
            transition: width 0.3s ease-out;
        }

        /* 新增样式 for tabs */
        .map-type-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 16px;
            background-color: var(--bg-background);
            padding: 5px;
            border-radius: 8px;
        }
        .tab-btn {
            flex-grow: 1;
            padding: 8px 5px;
            cursor: pointer;
            border-radius: 6px;
            border: none;
            background: transparent;
            color: var(--text2);
            font-size: 0.9rem;
            transition: background-color 0.3s, color 0.3s;
            text-align: center;
	height: auto;
        }
        .tab-btn:hover {
            background-color: var(--lightbg);
        }
        .tab-btn.active {
                background-color: var(--btbg);
    		color: var(--lightbg);
            font-weight: bold;
        }
        .param-panel {
            display: none; /* Hide all panels by default */
        }
        .param-panel.active {
            display: block; /* Show active panel */
        }
        /* End of new styles */


        @media (max-width: 768px) {
	.progress-container {
		width: 80%;}
	.panel-title {
	flex-wrap: wrap;
    	gap: 8px;}
	.example-image {    
	width: 60px;
    	height: 60px;}
            .content-n {
		    display: flex;
	    	flex-direction: column;
		    padding: 0;}
	.under {
		grid-template-columns: 1fr;
	}
	.container {
		    padding: 20px 0;
		}
            .panel {
                padding: 20px 15px;
                min-width: auto;
            }

            .scrib {
		}
            .controls {
                padding: 15px;
                gap: 8px;
	grid-template-columns: 1fr;
            }
            .example-images {
		gap: 10px;
    		margin-right: 10px;
		}
            button {
                padding: 14px;
                font-size: 0.88rem;
                min-width: auto;
                width: 80%;
	        height: 38px;
            }
        .toggle-btn{
            font-size: 0.88rem;
        }
	.algorithm-option {
	    padding: 8px 14px;}
        .map-type-tabs {
        }
        .tab-btn {
            font-size: 0.8rem;
	padding: 4px 5px;
        }
        }
    </style>
</head>
<body>
<svg width="0" height="0" class="hidden">
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="circle-exclamation-solid-full">
    <path d="M320 576C178.6 576 64 461.4 64 320C64 178.6 178.6 64 320 64C461.4 64 576 178.6 576 320C576 461.4 461.4 576 320 576zM320 384C302.3 384 288 398.3 288 416C288 433.7 302.3 448 320 448C337.7 448 352 433.7 352 416C352 398.3 337.7 384 320 384zM320 192C301.8 192 287.3 207.5 288.6 225.7L296 329.7C296.9 342.3 307.4 352 319.9 352C332.5 352 342.9 342.3 343.8 329.7L351.2 225.7C352.5 207.5 338.1 192 319.8 192z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="cloud-arrow-up-solid-full">
    <path d="M176 544C96.5 544 32 479.5 32 400C32 336.6 73 282.8 129.9 263.5C128.6 255.8 128 248 128 240C128 160.5 192.5 96 272 96C327.4 96 375.5 127.3 399.6 173.1C413.8 164.8 430.4 160 448 160C501 160 544 203 544 256C544 271.7 540.2 286.6 533.5 299.7C577.5 320 608 364.4 608 416C608 486.7 550.7 544 480 544L176 544zM337 255C327.6 245.6 312.4 245.6 303.1 255L231.1 327C221.7 336.4 221.7 351.6 231.1 360.9C240.5 370.2 255.7 370.3 265 360.9L296 329.9L296 432C296 445.3 306.7 456 320 456C333.3 456 344 445.3 344 432L344 329.9L375 360.9C384.4 370.3 399.6 370.3 408.9 360.9C418.2 351.5 418.3 336.3 408.9 327L336.9 255z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="cube-solid-full">
    <path d="M288.3 61.5C308.1 50.1 332.5 50.1 352.3 61.5L528.2 163C548 174.4 560.2 195.6 560.2 218.4L560.2 421.4C560.2 444.3 548 465.4 528.2 476.8L352.3 578.5C332.5 589.9 308.1 589.9 288.3 578.5L112.5 477C92.7 465.6 80.5 444.4 80.5 421.6L80.5 218.6C80.5 195.7 92.7 174.6 112.5 163.2L288.3 61.5zM496.1 421.5L496.1 255.4L352.3 338.4L352.3 504.5L496.1 421.5z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="download-solid-full">
    <path d="M352 96C352 78.3 337.7 64 320 64C302.3 64 288 78.3 288 96L288 306.7L246.6 265.3C234.1 252.8 213.8 252.8 201.3 265.3C188.8 277.8 188.8 298.1 201.3 310.6L297.3 406.6C309.8 419.1 330.1 419.1 342.6 406.6L438.6 310.6C451.1 298.1 451.1 277.8 438.6 265.3C426.1 252.8 405.8 252.8 393.3 265.3L352 306.7L352 96zM160 384C124.7 384 96 412.7 96 448L96 480C96 515.3 124.7 544 160 544L480 544C515.3 544 544 515.3 544 480L544 448C544 412.7 515.3 384 480 384L433.1 384L376.5 440.6C345.3 471.8 294.6 471.8 263.4 440.6L206.9 384L160 384zM464 440C477.3 440 488 450.7 488 464C488 477.3 477.3 488 464 488C450.7 488 440 477.3 440 464C440 450.7 450.7 440 464 440z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="rotate-right-solid-full">
    <path d="M552 256L408 256C398.3 256 389.5 250.2 385.8 241.2C382.1 232.2 384.1 221.9 391 215L437.7 168.3C362.4 109.7 253.4 115 184.2 184.2C109.2 259.2 109.2 380.7 184.2 455.7C259.2 530.7 380.7 530.7 455.7 455.7C463.9 447.5 471.2 438.8 477.6 429.6C487.7 415.1 507.7 411.6 522.2 421.7C536.7 431.8 540.2 451.8 530.1 466.3C521.6 478.5 511.9 490.1 501 501C401 601 238.9 601 139 501C39.1 401 39 239 139 139C233.3 44.7 382.7 39.4 483.3 122.8L535 71C541.9 64.1 552.2 62.1 561.2 65.8C570.2 69.5 576 78.3 576 88L576 232C576 245.3 565.3 256 552 256z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="rotate-solid-full">
    <path d="M544.1 256L552 256C565.3 256 576 245.3 576 232L576 88C576 78.3 570.2 69.5 561.2 65.8C552.2 62.1 541.9 64.2 535 71L483.3 122.8C439 86.1 382 64 320 64C191 64 84.3 159.4 66.6 283.5C64.1 301 76.2 317.2 93.7 319.7C111.2 322.2 127.4 310 129.9 292.6C143.2 199.5 223.3 128 320 128C364.4 128 405.2 143 437.7 168.3L391 215C384.1 221.9 382.1 232.2 385.8 241.2C389.5 250.2 398.3 256 408 256L544.1 256zM573.5 356.5C576 339 563.8 322.8 546.4 320.3C529 317.8 512.7 330 510.2 347.4C496.9 440.4 416.8 511.9 320.1 511.9C275.7 511.9 234.9 496.9 202.4 471.6L249 425C255.9 418.1 257.9 407.8 254.2 398.8C250.5 389.8 241.7 384 232 384L88 384C74.7 384 64 394.7 64 408L64 552C64 561.7 69.8 570.5 78.8 574.2C87.8 577.9 98.1 575.8 105 569L156.8 517.2C201 553.9 258 576 320 576C449 576 555.7 480.6 573.4 356.5z"></path>
  </symbol>
</svg>
    <div class="container">
        <header>
            <h1>PBR全流程贴图生成器 <span class="format-badge">法线/置换/AO等</span></h1>
            <p class="header-subtitle">上传灰度图，一键生成多种PBR贴图。法线/AO模式支持GPU加速处理，法线模式支持3D预览</p>
        </header>
        
        <div class="content-n">
            <div class="progress-container" id="progressContainer">
                <div class="quality-indicator">
                    <span><svg class="icon"><use xlink:href="#rotate-solid-full"></use></svg>处理中...</span>
                    <span id="progressPercent">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>

            <div class="panel">
                <div id="cpuGpuToggleContainer">
                    <div class="mode-toggle">
                        <div class="toggle-btn active" style="border-radius: 30px 0 0 30px;" id="cpuModeBtn">CPU模式 (高精)</div>
                        <div class="toggle-btn" style="border-radius: 0 30px 30px 0;" id="gpuModeBtn">GPU模式 (超快)</div>
                    </div>
                    <div class="perf-info" id="perfInfo">
                        <svg class="icon"><use xlink:href="#circle-exclamation-solid-full"></use></svg>
                        <span>当前模式：<span id="currentMode">CPU模式</span> | 处理时间：<span id="processingTime">0</span>ms</span>
                    </div>
                </div>
                <div class="panel-title">
                    <h2>输入图像<span class="scrib">上传灰度或彩色图像</span></h2>               
                </div>
                
                <div class="file-upload-area" id="inputUploadArea">
                    <label for="fileInput">
                        <svg class="icon"><use xlink:href="#cloud-arrow-up-solid-full"></use></svg>
				<div>点击选择文件或拖放图像到此处</div>
                        	<div style="font-size: 0.9rem; color: var(--text3);">支持 JPG, PNG, BMP, TIFF, WEBP 等格式</div>
                        <div style="display: flex; flex-direction: column; align-items: flex-start;">
				
			</div>
                    </label>
                    <input type="file" id="fileInput" accept="image/*" style="display: none;">
                </div>
                <div class="line2"></div>
                <div class="panel-title"> 
                    <h2>示例图像 <span class="scrib">点击左侧图标可预览</span></h2>
                </div>
                
                <div style="display: flex; flex-direction: row;">
                    <div class="example-images">
                        <div class="example-image" data-img="bricks">
                            <img src="data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3e%3crect width='100' height='100' fill='%23333'/%3e%3crect x='0' y='0' width='100' height='10' fill='%23999'/%3e%3crect x='0' y='20' width='100' height='10' fill='%23999'/%3e%3crect x='0' y='40' width='100' height='10' fill='%23999'/%3e%3crect x='0' y='60' width='100' height='10' fill='%23999'/%3e%3crect x='0' y='80' width='100' height='10' fill='%23999'/%3e%3c/svg%3e" alt="砖块">
                            <div class="label">砖块</div>
                        </div>
                        <div class="example-image" data-img="cobblestone">
                            <img src="data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3e%3crect width='100' height='100' fill='%23333'/%3e%3cellipse cx='30' cy='30' rx='15' ry='15' fill='%23999'/%3e%3cellipse cx='70' cy='30' rx='15' ry='15' fill='%23999'/%3e%3cellipse cx='30' cy='70' rx='15' ry='15' fill='%23999'/%3e%3cellipse cx='70' cy='70' rx='15' ry='15' fill='%23999'/%3e%3cellipse cx='50' cy='50' rx='20' ry='20' fill='%23ccc'/%3e%3c/svg%3e" alt="鹅卵石">
                            <div class="label">鹅卵石</div>
                        </div>
                        <div class="example-image" data-img="metal">
                            <img src="data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3e%3crect width='100' height='100' fill='%23333'/%3e%3crect x='10' y='10' width='80' height='80' fill='%23666'/%3e%3crect x='20' y='20' width='60' height='60' fill='%23999'/%3e%3crect x='30' y='30' width='40' height='40' fill='%23ccc'/%3e%3c/svg%3e" alt="金属板">
                            <div class="label">金属板</div>
                        </div>
                        <div class="example-image" data-img="rock">
                            <img src="data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3e%3crect width='100' height='100' fill='%23333'/%3e%3cpath d='M20,30 Q40,10 60,30 Q80,50 60,70 Q40,90 20,70 Q10,50 20,30' fill='%23999'/%3e%3c/svg%3e" alt="岩石">
                            <div class="label">岩石</div>
                        </div>
                    </div>
                    
                    <div class="canvas-container" id="inputCanvasContainer">
                        <canvas id="inputCanvas"></canvas>
                        <div id="inputPlaceholder" class="placeholder">
                            <svg class="icon"><use xlink:href="#cloud-arrow-up-solid-full"></use></svg>
                            请上传灰度图或选择示例图像
                        </div>
                    </div>
                </div>

                <div style="display: flex; justify-content: center; margin: 15px 0;">
                    <button id="downloadGrayBtn" class="button" style="background: var(--btcolor);">
                        <svg class="icon"><use xlink:href="#download-solid-full"></use></svg>下载灰度图
                    </button>
                </div>

            </div>
            
            <div class="panel">
                <div class="map-type-tabs">
                    <button class="tab-btn active" data-map-type="normal">nor法线</button>
                    <button class="tab-btn" data-map-type="displacement">disp置换/凹凸</button>
                    <button class="tab-btn" data-map-type="ao">AO(OCC)</button>
                    <button class="tab-btn" data-map-type="reflection">ref反射</button>
                    <button class="tab-btn" data-map-type="glossiness">gloss光泽度</button>
                </div>

                <div id="normalParams" class="param-panel active">
                    <div class="panel-title" style="margin-top: 0;">
                        <h2>法线参数设置<span class="scrib">强度和方向调节</span></h2>
                    </div>
                    <div class="kuang">
                        <div class="controls">
                            <div class="control-group">
                                <label for="strengthSlider">法线强度: 
                                    <input type="text" id="strengthValue" class="value-input" value="0.10">
                                </label>
                                <input type="range" id="strengthSlider" min="0.01" max="0.5" step="0.01" value="0.10">
                                <div class="param-info">
                                    <span class="canshu">柔和</span>
                                    <span class="canshu">强烈</span>
                                </div>
                            </div>
                            <div class="control-group">
                                <label for="blurSlider">模糊程度: 
                                    <input type="text" id="blurValue" class="value-input" value="0.0">
                                </label>
                                <input type="range" id="blurSlider" min="0" max="5" step="0.1" value="0">
                                <div class="param-info">
                                    <span class="canshu">锐利</span>
                                    <span class="canshu">模糊</span>
                                </div>
                            </div>
                        </div>
                        <div class="line"></div>
                        <div class="controls" style="display: flex;">
                            <div class="control-group"><label for="invertX"><input type="checkbox" id="invertX"> 反转X方向</label></div>
                            <div class="control-group"><label for="invertY"><input type="checkbox" id="invertY" checked> 反转Y方向</label></div>
                            <div class="control-group"><label for="highQuality"><input type="checkbox" id="highQuality" checked> 高质量模式</label></div>
                        </div>
                    </div>
                </div>

                <div id="displacementParams" class="param-panel">
                     <div class="panel-title" style="margin-top: 0;">
                        <h2>置换参数设置<span class="scrib">控制高度和细节</span></h2>
                    </div>
                    <div class="kuang">
                        <div class="controls">
                            <div class="control-group">
                                <label>强度: <input type="text" id="dispStrengthValue" class="value-input" value="1.0"></label>
                                <input type="range" id="dispStrengthSlider" min="0" max="2" step="0.05" value="1.0">
                                <div class="param-info">
				<span class="canshu">弱</span>
				<span class="canshu">强</span></div>
                            </div>
                            <div class="control-group">
                                <label>细节层次: <input type="text" id="dispLevelValue" class="value-input" value="0.5"></label>
                                <input type="range" id="dispLevelSlider" min="0" max="1" step="0.05" value="0.5">
                                <div class="param-info"><span class="canshu">低</span><span class="canshu">高</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="aoParams" class="param-panel">
                    <div class="panel-title" style="margin-top: 0;">
                        <h2>AO参数设置<span class="scrib">控制遮蔽效果</span></h2>
                    </div>
                    <div class="kuang">
                        <div class="controls">
                            <div class="control-group">
                                <label>强度: <input type="text" id="aoStrengthValue" class="value-input" value="1.0"></label>
                                <input type="range" id="aoStrengthSlider" min="0" max="5" step="0.1" value="1.0">
                                <div class="param-info">
				<span class="canshu">弱</span>
				<span class="canshu">强</span></div>
                            </div>
                            <div class="control-group">
                                <label>范围: <input type="text" id="aoSpreadValue" class="value-input" value="10"></label>
                                <input type="range" id="aoSpreadSlider" min="1" max="50" step="1" value="10">
                                <div class="param-info">
				<span class="canshu">小</span>
				<span class="canshu">大</span></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="reflectionParams" class="param-panel">
                    <div class="panel-title" style="margin-top: 0;">
                        <h2>反射参数设置<span class="scrib">控制反射强度</span></h2>
                    </div>
                    <div class="kuang">
                        <div class="controls">
                            <div class="control-group">
                                <label>强度: <input type="text" id="reflectStrengthValue" class="value-input" value="1.0"></label>
                                <input type="range" id="reflectStrengthSlider" min="0" max="2" step="0.05" value="1.0">
                                 <div class="param-info">
				<span class="canshu">弱</span>
				<span class="canshu">强</span></div>
                            </div>
                            <div class="control-group">
                                <label>对比度: <input type="text" id="reflectContrastValue" class="value-input" value="1.0"></label>
                                <input type="range" id="reflectContrastSlider" min="0" max="3" step="0.05" value="1.0">
                                <div class="param-info">
				<span class="canshu">低</span>
				<span class="canshu">高</span></div>
                            </div>
                        </div>
                         <div class="line"></div>
                        <div class="controls" style="display: flex;">
                             <div class="control-group"><label><input type="checkbox" id="reflectInvert"> 反相</label></div>
                        </div>
                    </div>
                </div>
                
                <div id="glossinessParams" class="param-panel">
                     <div class="panel-title" style="margin-top: 0;">
                        <h2>光泽度参数设置<span class="scrib">控制表面光滑度</span></h2>
                    </div>
                    <div class="kuang">
                         <div class="controls">
                            <div class="control-group">
                                <label>强度: <input type="text" id="glossStrengthValue" class="value-input" value="1.0"></label>
                                <input type="range" id="glossStrengthSlider" min="0" max="2" step="0.05" value="1.0">
                                <div class="param-info">
				<span class="canshu">弱</span>
				<span class="canshu">强</span></div>
                            </div>
                            <div class="control-group">
                                <label>对比度: <input type="text" id="glossContrastValue" class="value-input" value="1.0"></label>
                                <input type="range" id="glossContrastSlider" min="0" max="3" step="0.05" value="1.0">
                                <div class="param-info">
				<span class="canshu">低</span>
				<span class="canshu">高</span></div>
                            </div>
                        </div>
                        <div class="line"></div>
                        <div class="controls" style="display: flex;">
                           <div class="control-group"><label><input type="checkbox" id="glossInvert" checked> 反相</label></div>
                        </div>
                    </div>
                </div>


                <div class="btn-group">
                    <button id="resetParamsBtn" class="toggle-btn">
                        <svg class="icon"><use xlink:href="#rotate-right-solid-full"></use></svg> 重置参数
                    </button>

                    <button id="downloadMapBtn">
                        <svg class="icon"><use xlink:href="#download-solid-full"></use></svg>
                    <span>下载法线图</span>
                    </button>
                </div>
                
                <div class="mode-toggle" style="width: 100%;" id="previewModeToggle">
                    <div class="toggle-btn active" id="normalPreviewBtn" style="width: 50%; border-radius: 30px 0 0 30px;">2D预览</div>
                    <div class="toggle-btn" id="modelPreviewBtn" style="width: 50%; border-radius: 0 30px 30px 0;">3D模型预览</div>
                </div>
                
                <div class="panel-title" style="justify-content: space-between;" id="outputPreviewTitleContainer"> 
                    <h2 id="previewTitle">法线图预览<span class="scrib">支持大小图切换</span></h2>
                    
                   <div class="size-toggle">
                        <div class="toggle-btn active" id="smallSizeBtn">小图</div>
                        <div class="toggle-btn" id="largeSizeBtn">大图</div>
                    </div>
                </div>

                <div class="canvas-container" id="outputCanvasContainer">
                    <canvas id="outputCanvas"></canvas>
                    <div id="outputPlaceholder" class="placeholder">
                        生成的贴图将显示在这里
                    </div>
                </div>
                
                <div id="preview3dContainer">
                    <div class="preview-hint" id="previewHint">
                        <svg class="icon"><use xlink:href="#cube-solid-full"></use></svg>
                        <p>使用鼠标左键旋转模型，滚轮缩放</p>
                    </div>
                    <div class="preview-controls">
                        <div class="toggle-btn active" data-shape="box" style="border-radius: 8px 0 0 8px;">立方体</div>
                        <div class="toggle-btn" data-shape="sphere">球体</div>
                        <div class="toggle-btn" data-shape="cylinder">圆柱</div>
                        <div class="toggle-btn" data-shape="torus" style="border-radius: 0 8px 8px 0;">圆环</div>
                    </div>
                </div>
                
                <div id="reverseSection">
                    <div class="panel-title">
                        <h2>反推灰度图<span class="scrib">拖拽上传法线图反推出灰度图</span></h2>
                        <button id="reverseBtn" class="toggle-btn" style="font-size: 14px; height: 38px; width: 120px;">
                            一键反推
                        </button>
                    </div>

                    <div class="kuang" style="display: flex; align-items: center; padding-left: 20px;">反推算法
                        <div class="algorithm-option">
                            <input type="radio" id="poissonAlgorithm" name="algorithm" value="poisson" checked>
                            <label for="poissonAlgorithm">Poisson重建算法 (推荐)</label>
                        </div>
                        
                        <div class="algorithm-option">
                            <input type="radio" id="simpleAlgorithm" name="algorithm" value="simple">
                            <label for="simpleAlgorithm">简单累加算法 (旧版)</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    <div class="panel">
<h2>通道贴图对应关系</h2>
	<div class="under">
	<li>diff-漫反射（COL）</li>
	<li>nor-法线（NRM）</li>
	<li>disp-置换（DIS）</li>
	<li>AO-环境吸收（OCC）</li>
	<li>reflection/specular-反射/高光（REF）</li>
	<li>glossiness-光泽度</li>
	<li>bump/height-黑白凹凸、高度图</li>
	<li>metalness-金属度（Metallic）</li>
	<li>roungh-粗糙度（金属度的粗糙度）</li>
	<li>curvature-曲率</li>
	</div>
</div>
	
    </div>

    <div id="inputModal" class="modal">
        <span class="close">&times;</span>
        <img class="modal-content" id="inputModalImg">
    </div>
    
    <div id="outputModal" class="modal">
        <span class="close">&times;</span>
        <img class="modal-content" id="outputModalImg">
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        //  !!! ↓↓↓ 请将这里替换为您自己部署好的 Worker URL ↓↓↓ !!!
        const WORKER_URL = 'https://pbr-map.xuyiqing2012.workers.dev';

        // 获取所有需要的DOM元素
        const fileInput = document.getElementById('fileInput');
        const inputCanvas = document.getElementById('inputCanvas');
        const outputCanvas = document.getElementById('outputCanvas');
        const inputPlaceholder = document.getElementById('inputPlaceholder');
        const outputPlaceholder = document.getElementById('outputPlaceholder');
        const downloadMapBtn = document.getElementById('downloadMapBtn');
        const downloadMapBtnText = downloadMapBtn.querySelector('span');
        const resetParamsBtn = document.getElementById('resetParamsBtn');
        const reverseBtn = document.getElementById('reverseBtn');
        const exampleImages = document.querySelectorAll('.example-image');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressPercent = document.getElementById('progressPercent');
        const inputUploadArea = document.getElementById('inputUploadArea');
        const smallSizeBtn = document.getElementById('smallSizeBtn');
        const largeSizeBtn = document.getElementById('largeSizeBtn');
        const outputCanvasContainer = document.getElementById('outputCanvasContainer');
        const previewTitle = document.getElementById('previewTitle');
        const reverseSection = document.getElementById('reverseSection');
        const previewModeToggle = document.getElementById('previewModeToggle');
        const outputPreviewTitleContainer = document.getElementById('outputPreviewTitleContainer');
        const normalPreviewBtn = document.getElementById('normalPreviewBtn');
        const modelPreviewBtn = document.getElementById('modelPreviewBtn');
        const preview3dContainer = document.getElementById('preview3dContainer');
        const previewHint = document.getElementById('previewHint');
        const shapeButtons = document.querySelectorAll('.preview-controls .toggle-btn');
        const inputModal = document.getElementById('inputModal');
        const outputModal = document.getElementById('outputModal');
        const inputModalImg = document.getElementById('inputModalImg');
        const outputModalImg = document.getElementById('outputModalImg');
        const closeBtns = document.querySelectorAll('.close');
        const inputCanvasContainer = document.getElementById('inputCanvasContainer');
        const mapTypeTabs = document.querySelectorAll('.tab-btn');
        const paramPanels = document.querySelectorAll('.param-panel');
        const strengthSlider = document.getElementById('strengthSlider');
        const blurSlider = document.getElementById('blurSlider');
        const strengthValueInput = document.getElementById('strengthValue');
        const blurValueInput = document.getElementById('blurValue');
        const invertX = document.getElementById('invertX');
        const invertY = document.getElementById('invertY');
        const highQuality = document.getElementById('highQuality');
        const dispStrengthSlider = document.getElementById('dispStrengthSlider');
        const dispLevelSlider = document.getElementById('dispLevelSlider');
        const dispStrengthValue = document.getElementById('dispStrengthValue');
        const dispLevelValue = document.getElementById('dispLevelValue');
        const aoStrengthSlider = document.getElementById('aoStrengthSlider');
        const aoSpreadSlider = document.getElementById('aoSpreadSlider');
        const aoStrengthValue = document.getElementById('aoStrengthValue');
        const aoSpreadValue = document.getElementById('aoSpreadValue');
        const reflectStrengthSlider = document.getElementById('reflectStrengthSlider');
        const reflectContrastSlider = document.getElementById('reflectContrastSlider');
        const reflectInvert = document.getElementById('reflectInvert');
        const reflectStrengthValue = document.getElementById('reflectStrengthValue');
        const reflectContrastValue = document.getElementById('reflectContrastValue');
        const glossStrengthSlider = document.getElementById('glossStrengthSlider');
        const glossContrastSlider = document.getElementById('glossContrastSlider');
        const glossInvert = document.getElementById('glossInvert');
        const glossStrengthValue = document.getElementById('glossStrengthValue');
        const glossContrastValue = document.getElementById('glossContrastValue');

        // 全局变量
        let currentMapType = 'normal';
        let originalWidth = 0;
        let originalHeight = 0;
        let currentImageData = null;
        let updateTimeout = null;
        let scene, camera, renderer, mesh, controls;
        let currentNormalMap = null;
        let currentShape = 'box';
        let is3dPreviewActive = false;
        let isThreeInitialized = false;
        let animationId = null;


        // =================================================================
        // ===== 新增: 与后端 Worker 通信的核心函数 =====
        // =================================================================
        async function callWorker(imageData, params) {
            progressContainer.style.display = 'block';
            progressFill.style.width = '10%';
            progressPercent.textContent = '上传中...';

            // 使用一个临时Canvas将ImageData转换为PNG格式的Blob，这是最高效的传输方式
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = imageData.width;
            tempCanvas.height = imageData.height;
            tempCanvas.getContext('2d').putImageData(imageData, 0, 0);
            
            const blob = await new Promise(resolve => tempCanvas.toBlob(resolve, 'image/png'));
            
            const formData = new FormData();
            formData.append('image', blob, 'input.png');
            formData.append('params', JSON.stringify(params));

            try {
                const response = await fetch(WORKER_URL, {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    throw new Error(`服务器错误: ${await response.text()}`);
                }

                progressFill.style.width = '70%';
                progressPercent.textContent = '下载中...';

                const resultBuffer = await response.arrayBuffer();
                const resultPixelData = new Uint8ClampedArray(resultBuffer);
                
                // Worker返回的数据不包含宽高，我们从params中获取
                const resultImageData = new ImageData(resultPixelData, params.width, params.height);
                
                // 将返回的像素数据绘制到输出Canvas上
                outputCanvas.width = params.width;
                outputCanvas.height = params.height;
                outputCanvas.getContext('2d').putImageData(resultImageData, 0, 0);

                outputPlaceholder.style.display = 'none';
                outputCanvas.style.display = 'block';
                progressFill.style.width = '100%';
                progressPercent.textContent = '完成';

            } catch (error) {
                console.error('调用 Worker 失败:', error);
                alert('图像处理失败: ' + error.message);
                progressPercent.textContent = '失败';
            } finally {
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                }, 1500);
            }
        }


        // =================================================================
        // ===== 改造后的主逻辑函数 =====
        // =================================================================
        function scheduleMapUpdate() {
            if (updateTimeout) clearTimeout(updateTimeout);
            updateTimeout = setTimeout(() => {
                if (currentImageData) generateMap();
            }, 300);
        }

        function generateMap() {
            if (!currentImageData) return;

            // 根据用户要求，AO模式保留在前端计算
            if (currentMapType === 'ao') {
                convertToAOMap(); // 这个函数被保留在下面
                return;
            }
            
            // 对于其他所有模式，收集参数并调用 Worker
            // 注意：因为worker解码后才知道图片宽高，所以把宽高信息也一并传入
            const params = {
                mapType: currentMapType,
                width: originalWidth,
                height: originalHeight,
                // 收集所有相关参数
                strength: parseFloat(strengthSlider.value),
                blur: parseFloat(blurSlider.value),
                invertX: invertX.checked,
                invertY: invertY.checked,
                highQuality: highQuality.checked,
                dispStrength: parseFloat(dispStrengthSlider.value),
                dispLevel: parseFloat(dispLevelSlider.value),
                reflectStrength: parseFloat(reflectStrengthSlider.value),
                reflectContrast: parseFloat(reflectContrastSlider.value),
                reflectInvert: reflectInvert.checked,
                glossStrength: parseFloat(glossStrengthSlider.value),
                glossContrast: parseFloat(glossContrastSlider.value),
                glossInvert: glossInvert.checked,
            };
            
            // 注意：这里的currentImageData是完整的ImageData对象
            callWorker(currentImageData, params).then(() => {
                // 当worker返回结果并绘制完成后，如果是法线模式且3D预览激活，则更新
                if (is3dPreviewActive && currentMapType === 'normal') {
                    update3dPreview();
                }
            });
        }


        // =================================================================
        // ===== 保留在前端的 AO 计算函数 =====
        // =================================================================
        function convertToAOMap() {
            const strength = parseFloat(aoStrengthSlider.value);
            const spread = parseInt(aoSpreadSlider.value);
            const inputData = currentImageData.data;
            const width = originalWidth;
            const height = originalHeight;
            const heightMap = new Float32Array(width * height);

            for (let i = 0; i < heightMap.length; i++) {
                heightMap[i] = (inputData[i * 4] + inputData[i * 4 + 1] + inputData[i * 4 + 2]) / 3;
            }

            outputCanvas.width = width;
            outputCanvas.height = height;
            const outputCtx = outputCanvas.getContext('2d');
            const outputImageData = outputCtx.createImageData(width, height);
            const outputData = outputImageData.data;

            progressContainer.style.display = 'block';
            let y = 0;
            const chunkSize = 10;

            function processChunk() {
                const endY = Math.min(y + chunkSize, height);
                for (; y < endY; y++) {
                    for (let x = 0; x < width; x++) {
                        const centerIdx = y * width + x;
                        const centerHeight = heightMap[centerIdx];
                        let occlusion = 0;

                        for (let j = -spread; j <= spread; j++) {
                            for (let i = -spread; i <= spread; i++) {
                                if (i === 0 && j === 0) continue;

                                const sampleX = Math.max(0, Math.min(width - 1, x + i));
                                const sampleY = Math.max(0, Math.min(height - 1, y + j));
                                const sampleIdx = sampleY * width + sampleX;
                                const sampleHeight = heightMap[sampleIdx];

                                const heightDiff = sampleHeight - centerHeight;
                                if (heightDiff > 0) {
                                    const dist = Math.sqrt(i * i + j * j);
                                    occlusion += heightDiff / (dist * dist + 1);
                                }
                            }
                        }
                        const aoValue = 255 - Math.min(255, occlusion * strength);
                        const outIdx = centerIdx * 4;
                        outputData[outIdx] = aoValue;
                        outputData[outIdx + 1] = aoValue;
                        outputData[outIdx + 2] = aoValue;
                        outputData[outIdx + 3] = 255;
                    }
                }
                const percent = Math.round((y / height) * 100);
                progressFill.style.width = `${percent}%`;
                progressPercent.textContent = `${percent}%`;
                if (y < height) {
                    setTimeout(processChunk, 0);
                } else {
                    outputCtx.putImageData(outputImageData, 0, 0);
                    outputPlaceholder.style.display = 'none';
                    outputCanvas.style.display = 'block';
                    setTimeout(() => { progressContainer.style.display = 'none'; }, 500);
                }
            }
            processChunk();
        }

        // =================================================================
        // ===== 所有 UI 控制 和 事件绑定 =====
        // =================================================================
        function updateUIAfterTabSwitch() {
            let mapName = "法线";
            switch(currentMapType) {
                case 'displacement': mapName = '置换'; break;
                case 'ao': mapName = 'AO'; break;
                case 'reflection': mapName = '反射'; break;
                case 'glossiness': mapName = '光泽度'; break;
            }

            previewTitle.childNodes[0].nodeValue = `${mapName}图预览`;
            downloadMapBtnText.textContent = `下载${mapName}图`;
            
            const isNormalMode = currentMapType === 'normal';
            reverseSection.style.display = isNormalMode ? 'block' : 'none';
            previewModeToggle.style.display = isNormalMode ? 'flex' : 'none';

            if (!isNormalMode && is3dPreviewActive) {
                normalPreviewBtn.click();
            }
            if (!isNormalMode) {
                outputPreviewTitleContainer.style.display = 'flex';
                outputCanvasContainer.style.display = 'flex';
            }
            
            const cpuGpuToggle = document.getElementById('cpuGpuToggleContainer');
            if (cpuGpuToggle) cpuGpuToggle.style.display = 'none';

            scheduleMapUpdate();
        }

        mapTypeTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                mapTypeTabs.forEach(t => t.classList.remove('active'));
                paramPanels.forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                currentMapType = tab.dataset.mapType;
                const activePanel = document.getElementById(`${currentMapType}Params`);
                if (activePanel) activePanel.classList.add('active');
                updateUIAfterTabSwitch();
            });
        });

        function bindSliderToInput(slider, input, scheduleUpdate, isFloat = true) {
            slider.addEventListener('input', () => {
                input.value = slider.value;
                if(scheduleUpdate) scheduleUpdate();
            });
            input.addEventListener('input', () => {
                let value = isFloat ? parseFloat(input.value) : parseInt(input.value);
                if (isNaN(value)) return;
                slider.value = value;
                if(scheduleUpdate) scheduleUpdate();
            });
        }

        bindSliderToInput(strengthSlider, strengthValueInput, scheduleMapUpdate);
        bindSliderToInput(blurSlider, blurValueInput, scheduleMapUpdate);
        bindSliderToInput(dispStrengthSlider, dispStrengthValue, scheduleMapUpdate);
        bindSliderToInput(dispLevelSlider, dispLevelValue, scheduleMapUpdate);
        bindSliderToInput(aoStrengthSlider, aoStrengthValue, scheduleMapUpdate);
        bindSliderToInput(aoSpreadSlider, aoSpreadValue, scheduleMapUpdate, false);
        bindSliderToInput(reflectStrengthSlider, reflectStrengthValue, scheduleMapUpdate);
        bindSliderToInput(reflectContrastSlider, reflectContrastValue, scheduleMapUpdate);
        bindSliderToInput(glossStrengthSlider, glossStrengthValue, scheduleMapUpdate);
        bindSliderToInput(glossContrastSlider, glossContrastValue, scheduleMapUpdate);

        [invertX, invertY, highQuality, reflectInvert, glossInvert].forEach(checkbox => {
            checkbox.addEventListener('change', scheduleMapUpdate);
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) loadImageFile(file);
        });

        function loadImageFile(file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    originalWidth = img.width;
                    originalHeight = img.height;
                    inputCanvas.width = originalWidth;
                    inputCanvas.height = originalHeight;
                    const ctx = inputCanvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    inputPlaceholder.style.display = 'none';
                    inputCanvas.style.display = 'block';
                    currentImageData = ctx.getImageData(0, 0, originalWidth, originalHeight);
                    scheduleMapUpdate();
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        function generateExampleImage(type) {
            const ctx = inputCanvas.getContext('2d');
            const width = 512;
            const height = 512;
            inputCanvas.width = width;
            inputCanvas.height = height;
            originalWidth = width;
            originalHeight = height;
            ctx.clearRect(0, 0, width, height);

            switch (type) {
                case 'bricks': drawBricks(ctx, width, height); break;
                case 'cobblestone': drawCobblestone(ctx, width, height); break;
                case 'metal': drawMetal(ctx, width, height); break;
                case 'rock': drawRock(ctx, width, height); break;
            }
            inputPlaceholder.style.display = 'none';
            inputCanvas.style.display = 'block';
            currentImageData = ctx.getImageData(0, 0, width, height);
        }

        function drawBricks(ctx, width, height) {
            ctx.fillStyle = '#333'; ctx.fillRect(0, 0, width, height);
            const brickWidth = width / 8, brickHeight = height / 16;
            ctx.fillStyle = '#999';
            for (let y = 0; y < height; y += brickHeight) {
                for (let x = 0; x < width; x += brickWidth) {
                    const offset = (y / brickHeight) % 2 === 0 ? 0 : brickWidth / 2;
                    ctx.fillRect(x + offset, y, brickWidth - 4, brickHeight - 4);
                }
            }
        }
        function drawCobblestone(ctx, width, height) {
            ctx.fillStyle = '#333'; ctx.fillRect(0, 0, width, height);
            const stoneSize = width / 8; ctx.fillStyle = '#999';
            for (let y = stoneSize / 2; y < height; y += stoneSize) {
                for (let x = stoneSize / 2; x < width; x += stoneSize) {
                    ctx.beginPath(); ctx.arc(x, y, stoneSize / 2.5, 0, Math.PI * 2); ctx.fill();
                }
            }
        }
        function drawMetal(ctx, width, height) {
            ctx.fillStyle = '#333'; ctx.fillRect(0, 0, width, height);
            const cellSize = width / 8; ctx.fillStyle = '#666';
            for (let y = 0; y < height; y += cellSize) {
                for (let x = 0; x < width; x += cellSize) {
                    ctx.fillRect(x, y, cellSize, cellSize);
                    ctx.fillStyle = '#999'; ctx.fillRect(x + 4, y + 4, cellSize - 8, cellSize - 8);
                    ctx.fillStyle = '#ccc'; ctx.fillRect(x + 8, y + 8, cellSize - 16, cellSize - 16);
                    ctx.fillStyle = '#666';
                }
            }
        }
        function drawRock(ctx, width, height) {
            ctx.fillStyle = '#333'; ctx.fillRect(0, 0, width, height);
            ctx.fillStyle = '#999'; ctx.beginPath(); ctx.ellipse(width/2, height/2, width/3, height/3, 0, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#777';
            for (let i = 0; i < 20; i++) {
                const angle = Math.random() * Math.PI * 2, radius = Math.random() * width/4;
                const x = width/2 + Math.cos(angle) * radius, y = height/2 + Math.sin(angle) * radius;
                const size = 5 + Math.random() * 15;
                ctx.beginPath(); ctx.arc(x, y, size, 0, Math.PI * 2); ctx.fill();
            }
        }

        function setupDragAndDrop() {
            inputUploadArea.addEventListener('dragover', (e) => { e.preventDefault(); inputUploadArea.classList.add('drag-over'); });
            inputUploadArea.addEventListener('dragleave', () => { inputUploadArea.classList.remove('drag-over'); });
            inputUploadArea.addEventListener('drop', (e) => {
                e.preventDefault(); inputUploadArea.classList.remove('drag-over');
                if (e.dataTransfer.files.length) loadImageFile(e.dataTransfer.files[0]);
            });
        }
        setupDragAndDrop();

        resetParamsBtn.addEventListener('click', () => {
            strengthSlider.value = 0.10; strengthValueInput.value = '0.10';
            blurSlider.value = 0; blurValueInput.value = '0.0';
            invertX.checked = false; invertY.checked = true; highQuality.checked = true;
            dispStrengthSlider.value = 1.0; dispStrengthValue.value = '1.0';
            dispLevelSlider.value = 0.5; dispLevelValue.value = '0.5';
            aoStrengthSlider.value = 1.0; aoStrengthValue.value = '1.0';
            aoSpreadSlider.value = 10; aoSpreadValue.value = '10';
            reflectStrengthSlider.value = 1.0; reflectStrengthValue.value = '1.0';
            reflectContrastSlider.value = 1.0; reflectContrastValue.value = '1.0';
            reflectInvert.checked = false;
            glossStrengthSlider.value = 1.0; glossStrengthValue.value = '1.0';
            glossContrastSlider.value = 1.0; glossContrastValue.value = '1.0';
            glossInvert.checked = true;
            scheduleMapUpdate();
        });

        downloadMapBtn.addEventListener('click', () => {
            if (outputCanvas.style.display === 'none') { alert('请先生成贴图'); return; }
            const link = document.createElement('a');
            link.download = `${currentMapType}-map.png`;
            link.href = outputCanvas.toDataURL('image/png');
            link.click();
        });
        document.getElementById('downloadGrayBtn').addEventListener('click', () => {
            if (inputCanvas.style.display === 'none') { alert('请先上传或生成灰度图'); return; }
            const link = document.createElement('a');
            link.download = 'height-map.png';
            link.href = inputCanvas.toDataURL('image/png');
            link.click();
        });
        
        // --- 3D 预览相关函数和事件绑定 ---
        function initThreeScene() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1b1c);
            camera = new THREE.PerspectiveCamera(75, preview3dContainer.clientWidth / preview3dContainer.clientHeight, 0.1, 1000);
            camera.position.z = 3;
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(preview3dContainer.clientWidth, preview3dContainer.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            preview3dContainer.appendChild(renderer.domElement);
            const ambientLight = new THREE.AmbientLight(0x404040); scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1); directionalLight.position.set(1, 1, 1); scene.add(directionalLight);
            const pointLight1 = new THREE.PointLight(0xffe7db, 1, 100); pointLight1.position.set(5, 5, 5); scene.add(pointLight1);
            const pointLight2 = new THREE.PointLight(0xadb7ff, 1, 100); pointLight2.position.set(-5, -5, -5); scene.add(pointLight2);
            createMesh('box');
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true; controls.dampingFactor = 0.05;
            window.addEventListener('resize', () => { if (is3dPreviewActive) updateRendererSize(); });
            isThreeInitialized = true;
        }
        function updateRendererSize() {
            if (!renderer || !preview3dContainer) return;
            const width = preview3dContainer.clientWidth, height = preview3dContainer.clientHeight;
            if (width === 0 || height === 0) return;
            camera.aspect = width / height; camera.updateProjectionMatrix();
            renderer.setSize(width, height);
        }
        function createMesh(shape) {
            currentShape = shape;
            if (mesh) scene.remove(mesh);
            let geometry;
            switch(shape) {
                case 'sphere': geometry = new THREE.SphereGeometry(1.5, 32, 32); break;
                case 'cylinder': geometry = new THREE.CylinderGeometry(1, 1, 2, 32); break;
                case 'torus': geometry = new THREE.TorusGeometry(1.5, 0.5, 16, 100); break;
                default: geometry = new THREE.BoxGeometry(2, 2, 2); break;
            }
            const material = new THREE.MeshPhongMaterial({ color: 0x808080, shininess: 30, side: THREE.DoubleSide });
            if (currentNormalMap) { material.normalMap = currentNormalMap; material.normalScale.set(1, 1); }
            mesh = new THREE.Mesh(geometry, material);
            scene.add(mesh);
        }
        function updateNormalMap(texture) {
            if (!mesh) return;
            currentNormalMap = texture;
            if (mesh.material) { mesh.material.normalMap = texture; mesh.material.needsUpdate = true; }
        }
        function animate() {
            animationId = requestAnimationFrame(animate);
            if (controls) controls.update();
            if (mesh && is3dPreviewActive) { mesh.rotation.x += 0.002; mesh.rotation.y += 0.003; }
            renderer.render(scene, camera);
        }
        function update3dPreview() {
            if (!outputCanvas.style.display || outputCanvas.style.display === 'none' || currentMapType !== 'normal') return;
            const texture = new THREE.CanvasTexture(outputCanvas);
            texture.needsUpdate = true;
            updateNormalMap(texture);
            previewHint.style.display = 'none';
        }
        normalPreviewBtn.addEventListener('click', () => {
            normalPreviewBtn.classList.add('active'); modelPreviewBtn.classList.remove('active');
            outputCanvasContainer.style.display = 'flex'; outputPreviewTitleContainer.style.display = 'flex';
            preview3dContainer.style.display = 'none'; is3dPreviewActive = false;
        });
        modelPreviewBtn.addEventListener('click', () => {
            if(currentMapType !== 'normal') return;
            modelPreviewBtn.classList.add('active'); normalPreviewBtn.classList.remove('active');
            outputCanvasContainer.style.display = 'none'; outputPreviewTitleContainer.style.display = 'none';
            preview3dContainer.style.display = 'block'; is3dPreviewActive = true;
            if (!isThreeInitialized) { initThreeScene(); animate(); }
            else { if (!animationId) animate(); }
            updateRendererSize();
            if (outputCanvas.style.display !== 'none') { update3dPreview(); previewHint.style.display = 'none'; }
            else { previewHint.style.display = 'block'; }
        });
        shapeButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                shapeButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active'); createMesh(btn.dataset.shape);
            });
        });

        // --- 其他UI事件绑定 ---
        reverseBtn.addEventListener('click', () => {
            if (outputCanvas.style.display === 'none' || currentMapType !== 'normal') {
                alert('请先生成一个法线图才能进行反推。'); return;
            }
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = outputCanvas.width;
            tempCanvas.height = outputCanvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(outputCanvas, 0, 0);
            const normalImageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
            const params = { mapType: 'reverse' };
            alert('正在请求服务器进行反推计算...');
            callWorker(normalImageData, params).then(() => {
                const inputCtx = inputCanvas.getContext('2d');
                inputCanvas.width = outputCanvas.width;
                inputCanvas.height = outputCanvas.height;
                inputCtx.drawImage(outputCanvas, 0, 0);
                originalWidth = inputCanvas.width;
                originalHeight = inputCanvas.height;
                currentImageData = inputCtx.getImageData(0, 0, originalWidth, originalHeight);
                alert('反推成功！新的高度图已显示在左侧输入区。');
                scheduleMapUpdate();
            });
        });

        exampleImages.forEach(img => {
            img.addEventListener('click', () => {
                const imgType = img.dataset.img;
                generateExampleImage(imgType);
                scheduleMapUpdate();
            });
        });
        
        smallSizeBtn.addEventListener('click', () => {
            smallSizeBtn.classList.add('active'); largeSizeBtn.classList.remove('active');
            outputCanvasContainer.style.maxHeight = '320px'; outputCanvas.style.maxHeight = '320px';
        });
        largeSizeBtn.addEventListener('click', () => {
            largeSizeBtn.classList.add('active'); smallSizeBtn.classList.remove('active');
            outputCanvasContainer.style.maxHeight = '600px'; outputCanvas.style.maxHeight = '600px';
        });

        inputCanvasContainer.addEventListener('click', () => {
            if (inputCanvas.style.display === 'none') return;
            inputModalImg.src = inputCanvas.toDataURL('image/png');
            inputModal.style.display = 'flex';
        });
        outputCanvasContainer.addEventListener('click', () => {
            if (outputCanvas.style.display === 'none') return;
            outputModalImg.src = outputCanvas.toDataURL('image/png');
            outputModal.style.display = 'flex';
        });
        closeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                inputModal.style.display = 'none'; outputModal.style.display = 'none';
            });
        });
        window.addEventListener('click', (e) => {
            if (e.target === inputModal) inputModal.style.display = 'none';
            if (e.target === outputModal) outputModal.style.display = 'none';
        });

        // 页面初始化
        updateUIAfterTabSwitch();
        generateExampleImage('bricks');
        setTimeout(() => {
            scheduleMapUpdate();
        }, 500);
    });
</script>
</body>
</html>