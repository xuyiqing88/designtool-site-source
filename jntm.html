<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>鸡你太美 - ikun躲避球</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="menu.js" defer></script>
    <link rel="icon" href="img/gongjuxiang.svg" type="image/svg">
    <script defer src="https://cloud.umami.is/script.js" data-website-id="5a2e10cd-bf73-47df-be48-079c9ba7783c" data-domains="designtool.site"></script>
    <style>
        /* 保持原有的CSS样式 */
        * {
	margin: 0;
	padding: 0;
	box-sizing: border-box;
	user-select: none;
}

body {
	background: #f5f7ff;
	display: flex;
	justify-content: center;
	align-items: center;
	min-height: 100vh;
	overflow: hidden;
	color: white;
}

.game-container {
	position: relative;
	width: 100%;
	max-width: 1200px;
	border-radius: 20px;
	overflow: hidden;
	backdrop-filter: blur(10px);
}

.game-header {
	text-align: center;
	margin-bottom: 20px;
}

.game-title {
	font-size: 1.8rem;
	margin-bottom: 10px;
	color: #fff;
	text-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
	font-weight: 700;
	letter-spacing: 2px;
	background: linear-gradient(113deg, #6472ff, #8352ff);
	-webkit-background-clip: text;
	background-clip: text;
	color: transparent;
	animation: title-pulse 2s infinite alternate;
	margin-top: 10px;
}

@keyframes title-pulse {
	0% {
		text-shadow: 0 0 10px #6472ff06;
	}

	100% {
		text-shadow: 0 0 20px #6472ff87, 0 0 30px #8352ff87;
	}
}

.game-stats {
	display: none;
	justify-content: space-between;
	font-size: 1.2rem;
	margin-top: 10px;
	background: rgba(0, 0, 0, 0.3);
	padding: 10px 20px;
	border-radius: 10px;
	margin-bottom: 10px;
}

#score {
	color: #fff;
	font-weight: bold;
	font-size: 1.4rem;
}

#speed {
	color: #5a64ff;
	font-weight: bold;
	font-size: 1.4rem;
}

.canvas-container {
	position: relative;
	width: 100%;
	height: 80vh;
	overflow: hidden;
	border-radius: 10px;
	border: 4px solid #5a64ff7a;
}

canvas {
	display: block;
}

.game-controls {
	display: flex;
	justify-content: center;
	padding: 10px;
	gap: 10px;
    position: absolute;
    top: 0;
    right: 10px;
}

.btn {
	padding: 12px 30px;
	font-size: 1.2rem;
	border: none;
	border-radius: 50px;
	cursor: pointer;
	transition: all 0.3s;
	font-weight: 600;
	display: flex;
	align-items: center;
	gap: 10px;
	position: relative;
	margin-top: 10px;
}

.btn:active {
	transform: translateY(5px);
	box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

#toggle-btn {
	background: linear-gradient(113deg, #6472ff, #8352ff);
	color: white;
	font-size: 1rem;
}

#reset-btn {
	background: #6db9db;
	color: white;
}

.screen {
	position: absolute;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	display: flex;
	flex-direction: column;
	justify-content: center;
	align-items: center;
	background: rgba(0, 0, 0, 0.65);
	z-index: 10;
	text-align: center;
	padding: 20px;
}

#start-screen h2 {
	font-size: 3rem;
	margin-bottom: 30px;
	color: #fff;
	text-shadow: 0 0 15px #6472ff87;
	animation: title-bounce 1s infinite alternate;
}

@keyframes title-bounce {
	0% {
		transform: translateY(-5px);
	}

	100% {
		transform: translateY(5px);
	}
}

#start-screen p {
	font-size: 1.1rem;
	max-width: 600px;
	margin-bottom: 30px;
	line-height: 1.6;
	color: #e0e0ff;
	text-shadow: 0 0 5px rgba(0, 0, 255, 0.5);
}

.instructions {
	background: rgba(255, 255, 255, 0.1);
	border-radius: 15px;
	padding: 20px;
	margin: 20px 0;
	max-width: 500px;
}

.instructions h3 {
	color: #fff;
	margin-bottom: 15px;
	text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
}

.instructions ul {
	text-align: left;
	padding-left: 20px;
}

.instructions li {
	margin-bottom: 10px;
	line-height: 1.5;
	font-size: 0.9rem;
}

#game-over-screen {
	display: none;
}

#game-over-screen h2 {
	font-size: 2.5rem;
	color: #FF6B6B;
	margin-bottom: 20px;
	text-shadow: 0 0 15px rgba(255, 107, 107, 0.7);
	animation: game-over-pulse 0.5s infinite alternate;
}

@keyframes game-over-pulse {
	0% {
		transform: scale(1);
	}

	100% {
		transform: scale(1.05);
	}
}

#final-score {
	font-size: 2.5rem;
	color: #fff;
	margin: 20px 0;
	text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
}

.character-display {
	width: 120px;
	height: 120px;
	margin: 20px auto;
	border-radius: 50%;
	overflow: hidden;
	border: 5px solid #fff;
	box-shadow: 0 0 20px 6472ff;
	position: relative;
	background: #fff;
}

.character {
	width: 100%;
	height: 100%;
	background-size: cover;
	background-position: center;
}

.mobile-controls {
	display: none;
	position: absolute;
	bottom: 20px;
	left: 0;
	right: 0;
	justify-content: space-between;
	padding: 0 20px;
	z-index: 5;
}

.mobile-btn {
	width: 80px;
	height: 80px;
	border-radius: 50%;
	background: rgba(255, 255, 255, 0.2);
	display: flex;
	justify-content: center;
	align-items: center;
	font-size: 2rem;
	color: white;
	border: 3px solid rgba(255, 255, 255, 0.3);
	box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
	transition: all 0.2s;
}

.mobile-btn:active {
	transform: scale(0.9);
	background: rgba(255, 255, 255, 0.3);
}

.loader {
	position: fixed;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	background: rgba(0, 0, 0, 0.9);
	display: flex;
	flex-direction: column;
	justify-content: center;
	align-items: center;
	z-index: 1000;
	transition: opacity 0.5s;
}

.spinner {
	width: 80px;
	height: 80px;
	border: 8px solid #5a64ff;
	border-top: 8px solid #fff;
	border-radius: 50%;
	animation: spin 1s linear infinite;
	margin-bottom: 20px;
}

@keyframes spin {
	0% {
		transform: rotate(0deg);
	}

	100% {
		transform: rotate(360deg);
	}
}

.loader-text {
	color: #fff;
	font-size: 1.5rem;
	text-align: center;
	text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
}

@keyframes character-animation {
	0% {
		background-position: 0 0;
	}

	33% {
		background-position: -120px 0;
	}

	66% {
		background-position: -240px 0;
	}

	100% {
		background-position: 0 0;
	}
}

.character-animate {
	animation: character-animation 0.8s steps(3) infinite;
}

@media (max-width: 768px) {
	.game-title {
		font-size: 1.8rem;
	}

	.canvas-container {
        border:2px solid #5a64ff7a;
	}

	.mobile-controls {
		display: flex;
	}

	.mobile-btn {
		width: 70px;
		height: 70px;
		font-size: 1.5rem;
	}

	.game-controls {
		flex-direction: column;
		align-items: center;
		gap: 0;
		top: -8px;
    		right: 0px;
	}

	.btn {
		width: 100%;
		max-width: 300px;
		justify-content: center;
		font-size: 0.9rem;
		padding: 10px 20px;
	}
}

@media (max-width: 480px) {
	.game-title {
		font-size: 1.5rem;
	}

	#start-screen h2 {
		font-size: 1.8rem;
	}

	.mobile-btn {
		width: 60px;
		height: 60px;
		font-size: 1.2rem;
	}

	.instructions {
		padding: 15px;
		font-size: 0.8rem;
	}
}

        /* 最高记录和烟花效果样式 */
        .high-score-info {
            font-size: 1.2rem;
            color: #ffd700;
            margin-top: 10px;
            text-shadow: 0 0 8px rgba(255, 215, 0, 0.7);
        }
        .fireworks-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 20;
            display: none; /* 默认隐藏 */
        }
        /* 分享弹窗样式 */
        .share-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 100;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .share-content {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            max-width: 90%;
        }
        .share-content h3 {
            color: #333;
            margin-bottom: 10px;
        }
        #share-image-container {
            margin-bottom: 15px;
            display: inline-block;
        }
        .share-buttons button {
            padding: 8px 20px;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-size: 1rem;
            margin: 0 5px;
        }
        #download-btn { background-color: #6472ff; color: white; }
        #close-share-btn { background-color: #f44336; color: white; }
    </style>
</head>
<body>
    <div id="global-sidebar"></div>

    <div class="loader" id="loader">
        <div class="spinner"></div>
        <div class="loader-text">加载中... 请稍候</div>
    </div>
    
    <div class="game-container">
        <div class="game-header">
            <h1 class="game-title">鸡你太美 - ikun躲避球</h1>
            <p style="color: #4a4e6d;">左右移动坤坤躲避砸下来的篮球</p>
            <div class="game-stats" >
                <div>得分: <span id="score">0</span></div>
                <div>速度: <span id="speed">1.0x</span></div>
            </div>
        </div>
        
        <div class="canvas-container">
            <canvas id="gameCanvas" width="800" height="500"></canvas>
            
            <div class="mobile-controls">
                <div class="mobile-btn" id="left-btn"><i class="fas fa-arrow-left"></i></div>
                <div class="mobile-btn" id="right-btn"><i class="fas fa-arrow-right"></i></div>
            </div>
            
            <div class="fireworks-container" id="fireworks-container"></div>
            
            <div class="screen" id="start-screen">
                <h2>鸡你太美</h2>
                <div class="character-display">
                    <div id="start-character" class="character"></div>
                </div>
                
                <div class="instructions">
                    <h3>游戏说明</h3>
                    <ul>
                        <li>有小黑子要陷害坤坤，不要让坤坤变成Dead Man</li>
                        <li>快帮坤坤左右移动躲避砸下来的篮球，每躲过一个得1分</li>
                        <li>随着得分增加，篮球下落速度会变快</li>
                    </ul>
                </div>
                
                <button id="start-game-btn" class="btn">
                    <i class="fas fa-play"></i> 开始游戏
                </button>
            </div>
            
            <div class="screen" id="game-over-screen">
                <h2>游戏结束!</h2>
                <div class="character-display">
                    <div id="end-character" class="character"></div>
                </div>
                <p>最终得分</p>
                <div id="final-score">0</div>
                <p class="high-score-info">最高记录: <span id="high-score">0</span></p>
            <div style="display: flex; gap: 14px;">
		<button id="restart-btn" class="btn" style="width: auto;">
                    <i class="fas fa-redo"></i> 重新开始
                </button>
                <button id="share-btn" class="btn" style="width: auto;">
                    <i class="fas fa-share-alt"></i> 分享成绩
                </button>
	   </div>
            </div>
        <div class="game-controls">
            <button id="toggle-btn" class="btn">
                <i class="fas fa-play"></i> 
            </button>
            <button id="reset-btn" class="btn">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
        </div>
        

    </div>

    <div class="share-modal" id="share-modal">
        <div class="share-content">
            <h3>我的游戏成绩</h3>
            <div id="share-image-container">
                </div>
            <div class="share-buttons">
                <button id="download-btn"><i class="fas fa-download"></i> 下载图片</button>
                <button id="close-share-btn"><i class="fas fa-times"></i> 关闭</button>
            </div>
        </div>
    </div>

    <script>
        // 游戏配置
        const config = {
            playerWidth: 80,
            playerHeight: 100,
            speedIncreasePerPoint: 0.05,
            isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
            
            get ballSize() {
                return this.isMobile ? 30 : 60;
            },
            get initialBallSpeed() {
                return this.isMobile ? 1.5 : 2;
            },
            get ballSpawnRate() {
                // 修改：初始生成频率
                return this.isMobile ? 80 : 60;
            },
            get maxBalls() {
                return this.isMobile ? 8 : 10;
            }
        };
        
        // 游戏状态
        const gameState = {
            score: 0,
            highScore: 0,
            speed: 1.0,
            gameRunning: false,
            gameOver: false,
            playerHit: false,
            balls: [],
            frameCount: 0,
            player: {
                x: 0,
                y: 0,
                width: config.playerWidth,
                height: config.playerHeight,
                frames: [],
                currentFrame: 0,
                frameCount: 0,
                frameDelay: 8
            },
            resourcesLoaded: false,
            audioInitialized: false
        };
        
        // DOM元素
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('score');
        const speedElement = document.getElementById('speed');
        const finalScoreElement = document.getElementById('final-score');
        const startScreen = document.getElementById('start-screen');
        const gameOverScreen = document.getElementById('game-over-screen');
        const loader = document.getElementById('loader');
        const startCharacter = document.getElementById('start-character');
        const endCharacter = document.getElementById('end-character');
        const highScoreElement = document.getElementById('high-score');
        const fireworksContainer = document.getElementById('fireworks-container');
        const shareModal = document.getElementById('share-modal');
        const shareImageContainer = document.getElementById('share-image-container');
        const shareCanvas = document.createElement('canvas'); // 用于生成分享图片的画布
        
        // 按钮
        const startGameBtn = document.getElementById('start-game-btn');
        const toggleBtn = document.getElementById('toggle-btn');
        const resetBtn = document.getElementById('reset-btn');
        const restartBtn = document.getElementById('restart-btn');
        const leftBtn = document.getElementById('left-btn');
        const rightBtn = document.getElementById('right-btn');
        const shareBtn = document.getElementById('share-btn');
        const downloadBtn = document.getElementById('download-btn');
        const closeShareBtn = document.getElementById('close-share-btn');
        
        // 音频对象
        let hitSound, missSound;
        
        // ---- [修改] ----
        // 资源路径, 新增了二维码图片
        const resources = {
            background: 'img/game/crtl.png',
            ball: 'img/game/ball.png',
            qrCode: 'img/game/qrcode.png', // <-- 新增
            sounds: {
                hit: 'img/game/ji.MP3',
                miss: 'img/game/ngm.MP3'
            },
            playerFrames: [
                'img/game/tsk1.png',
                'img/game/tsk2.png',
                'img/game/tsk3.png'
            ],
            hitFrames: [
                'img/game/ngm1.png',
                'img/game/ngm2.png',
            ],
            gameOverPlayer: 'img/game/bixin.png'
        };
        // ---- [修改结束] ----
        
        // 加载图片资源
        function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = () => {
                    console.error(`无法加载图像: ${src}`);
                    resolve(null); // 返回null而不是reject，让游戏可以继续
                };
                img.src = src;
            });
        }
        
        // ---- [修改] ----
        // 预加载资源, 新增了对二维码图片的加载
        async function loadResources() {
            try {
                // 并行加载所有图片
                const [
                    bg, ball, qr, gameOverPlayer, 
                    pFrame1, pFrame2, pFrame3, 
                    hFrame1, hFrame2
                ] = await Promise.all([
                    loadImage(resources.background),
                    loadImage(resources.ball),
                    loadImage(resources.qrCode), // <-- 新增加载
                    loadImage(resources.gameOverPlayer),
                    loadImage(resources.playerFrames[0]),
                    loadImage(resources.playerFrames[1]),
                    loadImage(resources.playerFrames[2]),
                    loadImage(resources.hitFrames[0]),
                    loadImage(resources.hitFrames[1])
                ]);

                gameState.backgroundImage = bg;
                gameState.ballImage = ball;
                gameState.qrCodeImage = qr; // <-- 新增存储
                gameState.gameOverPlayerImage = gameOverPlayer;
                
                endCharacter.style.backgroundImage = `url('${resources.gameOverPlayer}')`;
                
                gameState.player.frames = [pFrame1, pFrame2, pFrame3];
                gameState.hitFrames = [hFrame1, hFrame2];
                
                startCharacter.style.backgroundImage = `url('${resources.playerFrames[0]}')`;
                
                // 确认所有必要的图片都加载成功
                if (!bg || !ball || !gameOverPlayer || !pFrame1) {
                    return false;
                }
                return true;
            } catch (error) {
                console.error("资源加载失败: ", error);
                return false;
            }
        }
        // ---- [修改结束] ----
        
        // 初始化音频
        function initAudio() {
            if (gameState.audioInitialized) return;
            
            try {
                hitSound = new Audio(resources.sounds.hit);
                missSound = new Audio(resources.sounds.miss);
                
                const silence = new Audio("data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAA");
                silence.volume = 0;
                silence.play().then(() => {
                    silence.pause();
                    silence.currentTime = 0;
                }).catch(e => {
                    console.log("静音音频播放失败:", e);
                });
                
                gameState.audioInitialized = true;
                console.log("音频初始化成功");
            } catch (e) {
                console.error("音频初始化失败:", e);
            }
        }
        
        // 初始化游戏
        function initGame() {
            if (config.isMobile) {
                gameState.player.width = 60;
                gameState.player.height = 75;
            } else {
                gameState.player.width = 80;
                gameState.player.height = 100;
            }
            gameState.player.x = canvas.width / 2 - gameState.player.width / 2;
            gameState.player.y = canvas.height - gameState.player.height - 20;
            
            gameState.score = 0;
            gameState.speed = 1.0;
            gameState.balls = [];
            gameState.frameCount = 0;
            gameState.gameOver = false;
            gameState.playerHit = false;
            
            scoreElement.textContent = gameState.score;
            speedElement.textContent = gameState.speed.toFixed(1) + 'x';
            highScoreElement.textContent = localStorage.getItem('highScore') || 0;
            
            gameOverScreen.style.display = 'none';
            fireworksContainer.style.display = 'none';
            
            drawGame();
        }
        
        // 开始/暂停游戏
        function toggleGame() {
            if (gameState.gameOver) {
                initGame();
                gameState.gameRunning = true;
                updateToggleButton();
                gameLoop();
                return;
            }
            
            gameState.gameRunning = !gameState.gameRunning;
            updateToggleButton();
            
            if (gameState.gameRunning) {
                gameLoop();
            }
        }
        
        // 更新切换按钮状态
        function updateToggleButton() {
            if (gameState.gameRunning) {
                toggleBtn.innerHTML = '<i class="fas fa-pause"></i> ';
            } else {
                toggleBtn.innerHTML = '<i class="fas fa-play"></i> ';
            }
        }
        
        // 重置游戏
        function resetGame() {
            initGame();
            gameState.gameRunning = false;
            updateToggleButton();
            startScreen.style.display = 'flex';
        }
        
        // 游戏结束
        function endGame() {
            gameState.gameRunning = false;
            gameState.gameOver = true;
            gameOverScreen.style.display = 'flex';
            finalScoreElement.textContent = gameState.score;
            updateToggleButton();

            if (config.isMobile) {
                shareBtn.style.display = 'flex';
            } else {
                shareBtn.style.display = 'none';
            }
            
            const currentHighScore = parseInt(localStorage.getItem('highScore') || 0);
            if (gameState.score > currentHighScore) {
                localStorage.setItem('highScore', gameState.score);
                highScoreElement.textContent = gameState.score + ' (新纪录!)';
                triggerFireworks();
            } else {
                highScoreElement.textContent = currentHighScore;
            }
            
            if (gameState.audioInitialized) {
                try {
                    missSound.currentTime = 0;
                    missSound.play().catch(e => console.log("音频播放失败:", e));
                } catch (e) {
                    console.error("播放失败:", e);
                }
            }
        }
        
        // 生成新篮球
        function spawnBall() {
            if (gameState.balls.length >= config.maxBalls) return;
            
            const ball = {
                x: Math.random() * (canvas.width - config.ballSize),
                y: -config.ballSize,
                width: config.ballSize,
                height: config.ballSize,
                speed: config.initialBallSpeed * gameState.speed
            };
            
            gameState.balls.push(ball);
        }
        
        // 更新玩家动画帧
        function updatePlayerAnimation() {
            if (gameState.playerHit) return;
            
            gameState.player.frameCount++;
            if (gameState.player.frameCount >= gameState.player.frameDelay) {
                gameState.player.frameCount = 0;
                gameState.player.currentFrame = (gameState.player.currentFrame + 1) % gameState.player.frames.length;
            }
        }
        
        // 更新篮球位置
        function updateBalls() {
            for (let i = gameState.balls.length - 1; i >= 0; i--) {
                const ball = gameState.balls[i];
                ball.y += ball.speed;
                
                const collisionPadding = config.isMobile ? 15 : 0;
                if (!gameState.playerHit && 
                    ball.x + ball.width - collisionPadding > gameState.player.x && 
                    ball.x + collisionPadding < gameState.player.x + gameState.player.width &&
                    ball.y + ball.height - collisionPadding > gameState.player.y && 
                    ball.y + collisionPadding < gameState.player.y + gameState.player.height) {
                    
                    gameState.playerHit = true;
                    setTimeout(endGame, 500);
                }
                
                if (ball.y > canvas.height) {
                    gameState.balls.splice(i, 1);
                    
                    if (!gameState.playerHit) {
                        gameState.score++;
                        gameState.speed = 1 + gameState.score * config.speedIncreasePerPoint;
                        speedElement.textContent = gameState.speed.toFixed(1) + 'x';
                        scoreElement.textContent = gameState.score;
                        
                        if (gameState.audioInitialized) {
                            try {
                                hitSound.currentTime = 0;
                                hitSound.play().catch(e => console.log("音频播放失败:", e));
                            } catch (e) {
                                console.error("播放失败:", e);
                            }
                        }
                    }
                }
            }
        }
        
        // 绘制游戏
        function drawGame() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (gameState.backgroundImage) {
                ctx.drawImage(gameState.backgroundImage, 0, 0, canvas.width, canvas.height);
            } else {
                ctx.fillStyle = '#1a1a2e';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            
            gameState.balls.forEach(ball => {
                if (gameState.ballImage) {
                    ctx.drawImage(gameState.ballImage, ball.x, ball.y, ball.width, ball.height);
                } else {
                    ctx.fillStyle = '#FF8C00';
                    ctx.beginPath();
                    ctx.arc(ball.x + ball.width/2, ball.y + ball.height/2, ball.width/2, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                ctx.beginPath();
                ctx.ellipse(
                    ball.x + ball.width/2, 
                    ball.y + ball.height + 5, 
                    ball.width/2 * 0.8, 
                    ball.height/10, 
                    0, 0, Math.PI * 2
                );
                ctx.fillStyle = 'rgba(0, 0, 0, 0)';
                ctx.fill();
            });
            
            if (!gameState.playerHit && gameState.player.frames.length > 0) {
                const frame = gameState.player.frames[gameState.player.currentFrame];
                if (frame) {
                    ctx.drawImage(
                        frame, 
                        gameState.player.x, 
                        gameState.player.y,
                        gameState.player.width,
                        gameState.player.height
                    );
                }
            } else if (gameState.hitFrames.length > 0) {
                const frame = gameState.hitFrames[gameState.player.currentFrame];
                if (frame) {
                    ctx.drawImage(
                        frame, 
                        gameState.player.x, 
                        gameState.player.y,
                        gameState.player.width,
                        gameState.player.height
                    );
                }
            }
            
            ctx.beginPath();
            ctx.ellipse(
                gameState.player.x + gameState.player.width / 2,
                gameState.player.y + gameState.player.height + 5,
                gameState.player.width / 2 * 0.8,
                gameState.player.height / 10,
                0, 0, Math.PI * 2
            );
            ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            ctx.fill();
            
            ctx.fillStyle = '#4a4e6d';
            ctx.font = '20px "Press Start 2P"';
            ctx.textAlign = 'left';
            ctx.fillText('得分: ' + gameState.score, 10, 30);
            
            ctx.fillText('速度: ' + gameState.speed.toFixed(1) + 'x', 10, 60);
        }
        
        // 游戏主循环
        function gameLoop() {
            if (!gameState.gameRunning) return;
            
            gameState.frameCount++;
            
            // --- [修改] ---
            // 随着速度增加，让篮球生成频率变快
            // 速度为1.0时，rate为 config.ballSpawnRate
            // 速度为2.0时，rate为 config.ballSpawnRate / 2
            // 速度越高，rate越小，生成越频繁
            const dynamicSpawnRate = Math.max(10, Math.floor(config.ballSpawnRate / gameState.speed));
            
            if (gameState.frameCount % dynamicSpawnRate === 0) {
                spawnBall();
            }
            // --- [修改结束] ---
            
            updatePlayerAnimation();
            updateBalls();
            drawGame();
            
            requestAnimationFrame(gameLoop);
        }
        
        // 事件监听
        function setupEventListeners() {
            startGameBtn.addEventListener('click', () => {
                if (!gameState.audioInitialized) initAudio();
                startScreen.style.display = 'none';
                gameState.gameRunning = true;
                updateToggleButton();
                gameLoop();
            });
            
            toggleBtn.addEventListener('click', toggleGame);
            resetBtn.addEventListener('click', resetGame);
            restartBtn.addEventListener('click', () => {
                initGame();
                gameState.gameRunning = true;
                updateToggleButton();
                gameLoop();
            });

            shareBtn.addEventListener('click', generateShareImage);
            downloadBtn.addEventListener('click', () => {
                const link = document.createElement('a');
                link.download = `鸡你太美-成绩_${gameState.score}.png`;
                link.href = shareCanvas.toDataURL("image/png");
                link.click();
            });
            closeShareBtn.addEventListener('click', () => {
                shareModal.style.display = 'none';
                shareImageContainer.innerHTML = '';
            });

            canvas.addEventListener('mousemove', (e) => {
                if (!gameState.gameRunning || gameState.playerHit) return;
                const rect = canvas.getBoundingClientRect();
                gameState.player.x = e.clientX - rect.left - gameState.player.width / 2;
                gameState.player.x = Math.max(0, Math.min(canvas.width - gameState.player.width, gameState.player.x));
            });
            
            canvas.addEventListener('touchmove', (e) => {
                if (!gameState.gameRunning || gameState.playerHit) return;
                e.preventDefault();
                const rect = canvas.getBoundingClientRect();
                const touch = e.touches[0];
                gameState.player.x = touch.clientX - rect.left - gameState.player.width / 2;
                gameState.player.x = Math.max(0, Math.min(canvas.width - gameState.player.width, gameState.player.x));
            });
            
            leftBtn.addEventListener('touchstart', () => {
                if (!gameState.gameRunning || gameState.playerHit) return;
                gameState.player.x = Math.max(0, gameState.player.x - 30);
            });
            
            rightBtn.addEventListener('touchstart', () => {
                if (!gameState.gameRunning || gameState.playerHit) return;
                gameState.player.x = Math.min(canvas.width - gameState.player.width, gameState.player.x + 30);
            });
            
            window.addEventListener('resize', resizeCanvas);
        }
        
        // 调整画布大小
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            
            if (gameState.player) {
                gameState.player.y = canvas.height - gameState.player.height - 20;
                gameState.player.x = Math.min(
                    Math.max(0, gameState.player.x),
                    canvas.width - gameState.player.width
                );
            }
        }
        
        // ---- [修改] ----
        // 生成分享图片, 现在使用预加载的静态二维码
        function generateShareImage() {
            const shareContext = shareCanvas.getContext('2d');
            const FONT = '"Press Start 2P", "Segoe UI", "Microsoft YaHei", sans-serif';

            // 设置分享画布尺寸
            const width = 600;
            const height = 800;
            shareCanvas.width = width;
            shareCanvas.height = height;

            // 绘制背景
            shareContext.fillStyle = '#1a1a2e';
            shareContext.fillRect(0, 0, width, height);

            // 绘制标题
            shareContext.fillStyle = '#ffd700';
            shareContext.font = `bold 40px ${FONT}`;
            shareContext.textAlign = 'center';
            shareContext.fillText('鸡你太美', width / 2, 80);
            shareContext.fillText('ikun躲避球', width / 2, 130);

            // 绘制成绩
            shareContext.fillStyle = '#fff';
            shareContext.font = `30px ${FONT}`;
            shareContext.fillText('我的最终得分', width / 2, 250);
            shareContext.font = `bold 80px ${FONT}`;
            shareContext.fillText(gameState.score, width / 2, 350);

            // 绘制最高记录
            shareContext.font = `20px ${FONT}`;
            const currentHighScore = localStorage.getItem('highScore') || 0;
            shareContext.fillStyle = '#8352ff';
            if (gameState.score > currentHighScore) {
                 shareContext.fillText('恭喜！打破最高记录！', width / 2, 420);
            }
            shareContext.fillText(`最高记录: ${currentHighScore}`, width / 2, 460);

            // 绘制坤坤头像
            if (gameState.gameOverPlayerImage) {
                const imgSize = 150;
                const imgX = (width - imgSize) / 2;
                const imgY = 500;
                shareContext.drawImage(gameState.gameOverPlayerImage, imgX, imgY, imgSize, imgSize);
            }
            
            // 绘制预加载好的二维码
            if (gameState.qrCodeImage) {
                const qrSize = 120;
                const qrX = (width - qrSize) / 2;
                const qrY = 660;
                shareContext.drawImage(gameState.qrCodeImage, qrX, qrY, qrSize, qrSize);
            } else {
                console.warn("二维码图片未加载，无法在分享图中显示。");
            }
            
            // 将生成的图片显示在弹窗中
            shareImageContainer.innerHTML = '';
            const img = new Image();
            img.src = shareCanvas.toDataURL("image/png");
            img.style.maxWidth = '100%';
            img.style.height = 'auto';
            shareImageContainer.appendChild(img);
            shareModal.style.display = 'flex';
        }
        // ---- [修改结束] ----

        // 烟花效果
        function triggerFireworks() {
            fireworksContainer.style.display = 'block';
            const numParticles = 50;
            const colors = ['#ff0000', '#ffff00', '#00ff00', '#00ffff', '#ff00ff'];
            for (let i = 0; i < numParticles; i++) {
                const particle = document.createElement('div');
                particle.style.position = 'absolute';
                particle.style.width = '10px';
                particle.style.height = '10px';
                particle.style.borderRadius = '50%';
                particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.top = `${Math.random() * 100}%`;
                particle.style.animation = `firework-blast ${Math.random() * 1 + 1}s ease-out forwards`;
                fireworksContainer.appendChild(particle);
            }
            setTimeout(() => {
                fireworksContainer.innerHTML = ''; // 清除烟花
                fireworksContainer.style.display = 'none';
            }, 3000); // 3秒后清除
        }
        
        // 初始化
        async function init() {
            loader.style.display = 'flex';
            try {
                const success = await loadResources();
                if (success) {
                    loader.style.opacity = '0';
                    setTimeout(() => {
                        loader.style.display = 'none';
                        resizeCanvas();
                        setupEventListeners();
                        
                        // 从localStorage读取最高分
                        gameState.highScore = parseInt(localStorage.getItem('highScore') || 0);
                        highScoreElement.textContent = gameState.highScore;

                        // 初始化游戏
                        initGame();
                        
                        startScreen.style.display = 'flex';
                        drawGame();
                    }, 500);
                } else {
                    throw new Error("关键资源加载失败，无法启动游戏。");
                }
            } catch (error) {
                console.error("初始化失败: ", error);
                loader.querySelector('.loader-text').textContent = "资源加载失败，请刷新页面重试";
            }
        }
        
        // 启动游戏
        window.onload = init;
    </script>
</body>
</html>