<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI助手 - 智能对话</title>
    <script src="menu.js" defer></script>
    <link rel="icon" href="img/gongjuxiang.svg" type="image/svg">
    <script defer src="https://cloud.umami.is/script.js" data-website-id="5a2e10cd-bf73-47df-be48-079c9ba7783c" data-domains="designtool.site"></script>
    <style>
        :root {
            --main-color: #5a64ff;
            --btcolor: linear-gradient(113deg, #4c73ff, #6a52ff);
            --text1: #1a1d2e;
            --text2: #4a4e6d;
            --text3: #8d8fa3;
            --line: #e2e4f0;
            --mainbg: #f9f9ff;
            --btactive: #e5e8ff;
            --lightbg: #f5f5f8;
            --shadow: #55537512;
            --card-bg: #ffffff;
            --blur: rgba(255, 255, 255, 0.5);
            --button: #5a64ff24;
            --secondary-tab-active: #eef0ff;
            --secondary-tab-hover: #f6f7ff;
            --user-msg-bg: #e2e5fd;
            --ai-msg-bg: #ffffff;
            --success-color: #2ecc71;
            --error-color: #e74c3c;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'HarmonyOS_Sans', 'Microsoft YaHei', 'Arial Unicode MS', sans-serif;
        }

        body {
            display: flex;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            background: linear-gradient(0deg, #bbb2ff, #7a6fff);
            color: var(--text1);
            transition: background 0.3s ease;
        }
        .icon {
            display: inline-block;
            width: 1.2em;
            height: 1.2em;
            fill: currentColor;
        }
        .message-file-attachment {
            display: flex;
            align-items: center;
            background: #fff;
            border-radius: 8px;
            border: 1px solid var(--line);
            padding: 8px;
            margin-top: 10px;
        }
        .message-file-attachment span {
            font-size: 14px;
            color: var(--text2);
        }
        .main-layout {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .sidebar {
            width: 250px;
            display: flex;
            flex-direction: column;
            padding: 25px 0;
            flex-shrink: 0;
	        margin-left: 60px;
        }

        .logo {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 0 25px 25px;
            border-bottom: 1px solid #00000012;
            margin-bottom: 20px;
	        flex-direction: column;
        }

        .logo h1 {
            font-size: 1.6rem;
            font-weight: 700;
	        color: #fff;
            letter-spacing: -0.5px;
	        margin-top: 20px;
        }

        .logo svg {
            font-size: 30px;
            background: var(--btcolor);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: pulse 2s infinite;
        }

        .tabs {
            display: flex;
            flex-direction: column;
            background: none;
            max-width: none;
            margin: 0;
            border-radius: 0;
            padding: 0 20px;
            gap: 10px;
        }

        .tab-btn {
            width: 100%;
            padding: 12px 20px;
            background: none;
            border: none;
            color: #fff;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            justify-content: flex-start;
            border-radius: 10px;
            z-index: 1;
            box-shadow: none;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tab-btn.active {
            box-shadow: none;
		    background: #00000012;
        }
        .tab-btn:hover:not(.active) {
            background: #00000012;
        }

        .main-content {
            flex-grow: 1;
            padding: 15px;
            overflow-y: hidden;
            min-width: 0;
            display: flex;
            flex-direction: column;
        }

        .tab-content {
            min-height: auto;
            padding: 0;
            min-width: auto;
            flex-grow: 1;
            display: flex;
        }

        .tab-pane { display: none; }
        .tab-pane.active { 
            display: flex; 
            flex-grow: 1;
            animation: fadeIn 0.5s ease;
        }

        .secondary-tabs {
            display: flex;
            background: transparent;
            border-radius: 0;
            margin-bottom: 20px;
            padding: 0 4px;
            border-bottom: 1px solid var(--line);
        }

        .secondary-tab-btn {
            flex: 1;
            padding: 0 15px 15px;
            background: none;
            border: none;
            color: var(--text2);
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;	
            justify-content: center;
            border-radius: 0;
            box-shadow: none;
            position: relative;
        }

        .secondary-tab-btn::after {
            content: '';
            position: absolute;
            left: 50%;
            bottom: -1px;
            transform: translateX(-50%);
            width: 0;
            height: 3px;
            background: var(--main-color);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .secondary-tab-btn.active {
            background: transparent;
            color: var(--main-color);
            font-weight: 600;
            box-shadow: none;
        }

        .secondary-tab-btn.active::after {
            width: 50%;
        }

        .secondary-tab-btn:hover {
            color: var(--main-color);
        }
        .secondary-tab-btn:not(.active):hover::after {
            width: 40%;
        }

        .secondary-tab-pane { 
            display: none; 
            flex: 1;
            flex-direction: column;
            max-height: calc(100vh - 100px);
	    }
        .secondary-tab-pane.active { 
	        display: flex; 
    	    overflow-y: auto;
	        overflow-x: hidden;
	    }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .panel {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        .panel h2 {
            font-size: 20px;
            margin-bottom: 10px;
            color: var(--text1);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .panel-description {
            color: var(--text2);
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.6;
        }
        .panel h2 svg {
            color: var(--main-color);
        }

        .panel-title-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .reset-btn {
            background: var(--mainbg);
            color: var(--text2);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 13px;
            border: 1px solid var(--line);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
		    font-weight: 500;
        }

        .reset-btn:hover {
            background: var(--button);
            transform: translateY(-1px);
        }
        
        textarea, input[type="text"], input[type="password"], select {
            width: 100%;
            padding: 16px 16px 38px 16px;
            border-radius:12px;
            border: 1px solid var(--line);
            background: var(--mainbg);
            color: var(--text1);
            font-size: 15px;
            resize: vertical;
            transition: all 0.3s;
        }
        textarea { min-height: 160px; }
        
        .settings-item textarea {
            padding: 8px 18px !important;
            min-height: 130px !important;
        }

        textarea:focus, input[type="text"]:focus, input[type="password"]:focus, select:focus {
            outline: none;
            border-color: var(--main-color);
        }
        
        .input-wrapper {
            position: relative;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }

        button {
            padding: 10px 24px;
            border-radius: 24px;
            border: none;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
        }

        .btn-primary {
            background: var(--btcolor);
            color: white;
            box-shadow: 0 4px 15px rgba(89, 99, 255, 0.25);
        }

        .btn-primary:hover {
            opacity: 0.92;
            box-shadow: 0 7px 18px rgba(89, 99, 255, 0.35);
        }

        .btn-secondary {
            background: var(--card-bg);
            color: var(--text2);
            border: 1px solid var(--line);
        }

        .btn-secondary:hover {
            background: var(--btactive);
            color: var(--main-color);
            transform: translateY(-2px);
        }
        
        #clearChatBtn:hover, #clearExpandBtn:hover {
             color: #e74c3c;
             border-color: #f5c8c4;
        }

        .btn-disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        .upload-container {
            position: relative;
            border: 2px dashed var(--line);
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--mainbg);
            min-height: 240px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .upload-container:hover {
            border-color: var(--main-color);
            background: var(--btactive);
        }

        .upload-icon {
            font-size: 48px;
            color: var(--main-color);
            margin-bottom: 18px;
            opacity: 0.7;
        }

        .upload-container p { color: var(--text3); font-size: 16px; }

        #imagePreview {
            max-width: 100%;
            max-height: 320px;
            border-radius: 12px;
            display: none;
            object-fit: contain;
            margin: 0 auto;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .close-preview {
            position: absolute;
            top: 12px;
            right: 12px;
            color: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            font-size: 30px;
            transition: all 0.3s;
        }

        .close-preview:hover {
            color: rgba(0, 0, 0, 0.9);
            transform: rotate(90deg);
        }

        .response-area {
            margin-top: 30px;
            border-radius: 10px;
            border: 1px solid var(--line);
            min-height: 160px;
            max-height: 400px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
	        height: 100%;
        }

        .response-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--line);
	        padding: 12px 20px;
	        background: var(--card-bg);
            border-radius: 16px 16px 0 0;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .response-header h3 {
            color: var(--text1);
            font-size: 17px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .response-header h3 svg { color: var(--main-color); }

        .copy-btn {
            background: none;
            border: none;
            color: var(--text2);
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 8px;
            background: var(--mainbg);
            transition: all 0.3s;
        }

        .copy-btn:hover {
            background: var(--btactive);
            color: var(--main-color);
            transform: translateY(-1px);
        }

        .response-content {
            color: var(--text2);
            line-height: 1.7;
            font-size: 15px;
	        margin: 20px;
            flex-grow: 1;
        }

        .settings-pane {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            width: 100%;
        }
        .settings-pane h2 {
            color: var(--text1);
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 25px;
        }
        .settings-pane h2 svg { color: var(--main-color); }

        .settings-item { margin-bottom: 18px; }

        .settings-item label {
            display: block;
            margin-bottom: 8px;
            color: var(--text1);
            font-weight: 500;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
	        justify-content: space-between;
        }
        .settings-item select {
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%238d8fa3' class='bi bi-chevron-down' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
        }


        .settings-item input, .settings-item textarea, .settings-item select {
            width: 100%;
            padding: 8px 18px;
            border-radius: 6px;
            font-size: 15px;
	        line-height: 1.5;
        }

        .settings-footer {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 25px;
        }
        
        .alert {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            padding: 16px 35px;
            border-radius: 12px;
            color: white;
            box-shadow: 0 8px 25px var(--shadow);
            z-index: 1001;
            animation: fadeInOut 3s forwards;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .alert.success { background: var(--success-color); }
        .alert.error { background: var(--error-color); }


        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -20px); }
            10% { opacity: 1; transform: translate(-50%, 0); }
            90% { opacity: 1; transform: translate(-50%, 0); }
            100% { opacity: 0; transform: translate(-50%, -20px); }
        }

        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: 8px;
            box-shadow: 0 0 8px;
        }
        
        .status-online { background-color: var(--success-color); color: var(--success-color); }
        .status-offline { background-color: var(--error-color); color: var(--error-color); }

        .chat-history {
            display: flex;
    	    flex-direction: column;
    	    gap: 20px;
    	    flex-grow: 1; 
    	    overflow-y: auto;
    	    border-radius: 4px 4px 10px 10px;
    	    margin-bottom: 10px;
        }
        .chat-history::-webkit-scrollbar {
            width: 10px; 
            height: 10px; 
        }
        .chat-history::-webkit-scrollbar-track {
            background: #ffffff00;
            border-radius: 6px;
        }
        .chat-history::-webkit-scrollbar-thumb {
            background: #dddde5;
            border-radius: 6px;
            border: 2px solid transparent;
            background-clip: content-box;
        }
        .chat-history::-webkit-scrollbar-thumb:hover {
            background: #a9a9b152;
        }
        .chat-history::-webkit-scrollbar-corner {
            background: #00ffd242;
        }
        .history-placeholder {
            color: var(--text3);
            text-align: center;
            padding: 40px;
            font-style: italic;
            opacity: 0.7;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 15px;
            height: 100%;
        }
        .history-placeholder svg { font-size: 32px; }
        
        .message {
            display: flex;
            gap: 15px;
            max-width: 85%;
            animation: fadeIn 0.4s ease;
        }
        
        .user-message { align-self: flex-end; flex-direction: row-reverse; }
        .ai-message { align-self: flex-start; }
        
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--lightbg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--main-color);
            font-size: 18px;
            flex-shrink: 0;
	        overflow: hidden;
        }

        .message-bubble {
            padding: 16px 20px;
            border-radius: 12px;
            word-break: break-word;
        }

        .user-message .message-bubble {
            background: var(--user-msg-bg);
            border-top-right-radius: 4px;
	        padding: 15px;
        }
        
        .ai-message .message-bubble {
            background: var(--lightbg);
            border-top-left-radius: 4px;
	        padding: 15px;
        }

        .ai-message.initial .message-bubble {
            background: radial-gradient(185% 45% at 100% 0%, #e6008100, #f9f9fe), linear-gradient(90deg, #D0EFFF, #d4dcff, #ffd9f2);
	        width: 480px;
        }

        .ai-message.initial .message-content strong {
            font-size: 1.25em;
            font-weight: bold;
	        line-height: 1.5;
        }
        
        .message-content {
            line-height: 1.3;
            white-space: pre-wrap;
            word-break: break-word;
            font-size: 15px;
        }

        .message-content strong {
            font-weight: 700;
        }

        .message-content h1,
        .message-content h2,
        .message-content h3,
        .message-content h4,
        .message-content h5,
        .message-content h6 {
            margin-top: 1em;
            margin-bottom: 0.5em;
            font-weight: bold;
            color: var(--text1);
        }

        .message-content h1 { font-size: 1.6em; }
        .message-content h2 { font-size: 1.4em; }
        .message-content h3 { font-size: 1.2em; }
        .message-content h4 { font-size: 1.1em; }
        .message-content h5 { font-size: 1em; }
        .message-content h6 { font-size: 0.9em; }

        .message-content ul,
        .message-content ol {
            margin-left: 20px;
            padding-left: 0;
            margin-bottom: 0;
        }

        .message-content ul li {
            list-style-type: disc;
            margin-bottom: 0;
        }

        .message-content ol li {
            list-style-type: decimal;
            margin-bottom: 0;
        }

        .message-content pre {
            background-color: var(--mainbg);
            border-radius: 8px;
            padding: 15px;
            overflow-x: auto;
            font-family: 'SF Mono', 'Cascadia Code', 'Fira Code', monospace;
            font-size: 0.9em;
            margin-top: 10px;
            margin-bottom: 10px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .message-content code {
            background-color: var(--lightbg);
            padding: 3px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', 'Cascadia Code', 'Fira Code', monospace;
            font-size: 0.9em;
            color: var(--text2);
        }

        .message-content pre code {
            background-color: transparent;
            padding: 0;
            border-radius: 0;
            color: inherit;
            white-space: pre; 
            word-break: break-word;
        }

        .message-content img {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            margin-top: 10px;
            cursor: pointer;
        }
        
        .message-footer {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-top: 5px;
            gap: 15px;
        }
        
        .message-time { font-size: 12px; color: var(--text3); }
        
        .copy-message-btn {
            background: none; border: none;
            color: var(--text3);
            font-size: 14px; cursor: pointer;
            display: flex; align-items: center;
            gap: 4px; padding: 4px;
            border-radius: 6px;
            transition: all 0.3s;
        }
        .message-bubble:hover .copy-message-btn { opacity: 1; }
        .copy-message-btn:hover { background: var(--lightbg);}
        
        /* Chat Input Area */
        .chat-input-area {
            position: relative;
        }
        .chat-input-area .btn-group {
            position: absolute;
            right: 10px;
            bottom: -5px;
            transform: translateY(-50%);
            margin: 0;
            gap: 8px;
        }
        .chat-input-area .btn-group button {
            padding: 8px;
            width: 40px;
            height: 40px;
	        background: none;
            border: none;
        }
        
        #chatFilePreview {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            padding: 8px;
            background-color: var(--mainbg);
            border-radius: 8px;
            display: none;
        }
        
        #chatFileDisplay {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            background-color: var(--lightbg);
            color: var(--text2);
            font-size: 20px;
            flex-shrink: 0;
        }

        #chatFileDisplay img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }

        #chatFileDisplay svg {
            font-size: 20px;
        }

        #chatFilePreview span {
            font-size: 13px;
            color: var(--text2);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        #removeChatFile {
            font-size: 16px;
            margin-left: auto;
            color: var(--text3);
            cursor: pointer;
        }

        /* AI Vision Layout */
        .vision-layout {
            display: grid;
            gap: 25px;
            grid-template-columns: 0.65fr 1.5fr;
        }

        .vision-layout > div {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .vision-layout .upload-container {
            margin-bottom: 0;
        }

        .vision-layout .response-area {
            margin-top: 0;
        }

        .vision-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-bottom: 10px;
            margin-right: 10px;
        }
        
        @media (max-width: 768px) {
            .main-layout { 
                flex-direction: column-reverse;
            }
            .ai-message.initial .message-bubble {
		        width: auto;
	        }
	        .secondary-tab-pane{
		        max-height: calc(100vh - 120px);
	        }
	        .settings-pane h2 {
		        justify-content: center;
            }
	        .settings-pane h2 svg {
		        display: none;
            }
	        .panel {padding: 16px;}
            .sidebar {
                width: 100%;
                height: auto;
                flex-direction: row;
                padding: 12px 0;
                border-right: none;
                justify-content: center;
                align-items: center;
	            margin-left: 0;
	            background: #fff;
	            box-shadow: 0 -2px 10px #0000000d;
	            position: fixed;
                bottom: 0;
                z-index: 999;
            }
	        textarea {min-height: 130px;}
	        .shezhik {
		        max-height: 72vh; 
	            padding-right: 10px;
            }
	        .message {
		        gap: 8px;
            }
            .chat-input-area {
	            margin-bottom: 10px;
            }
            .logo {
                display: none;
            }
            .tabs {
                flex-direction: row;
                gap: 5px;
                flex-grow: 1;
                justify-content: space-around;
            }
            .tab-btn {
                flex: 1;
                text-align: center;
                justify-content: center;
                margin-bottom: 0;
                font-size: 12px;
		        padding: 0;
		        gap: 4px;
	            flex-direction: column;
	            color: var(--text3);
	            font-weight: 400;
            }
            .tab-btn.active {
                color: var(--main-color);
		        background: none;
            }
            .tab-btn svg {
                margin-right: 4px;
		        font-size: 16px;
            }
	        .panel h2 {
		        justify-content: center;
            }
	        .panel h2 svg {
		        display: none;
            }
	        .settings-footer {
	            position: fixed;
                bottom: 60.5px;
                background: #fff;
                z-index: 998;
                width: 90%;
                padding: 10px 0;
            }
            body  {
                background: #fff;
            }
            .main-content {
                padding: 0;
                padding-bottom: 80px;
                min-height: calc(100vh - 80px);
            }
            .vision-layout {
                flex-direction: column;
		        display: flex;
            }
	        .upload-container {min-height: 190px;}
            .settings-pane {padding: 20px 10px 20px 20px;}
	        .message-avatar {
		        display: none;
            }
        }
    </style>
</head>
<body>
<svg width="0" height="0" class="hidden">
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="arrow-rotate-left-solid-full">
    <path d="M320 128C263.2 128 212.1 152.7 176.9 192L224 192C241.7 192 256 206.3 256 224C256 241.7 241.7 256 224 256L96 256C78.3 256 64 241.7 64 224L64 96C64 78.3 78.3 64 96 64C113.7 64 128 78.3 128 96L128 150.7C174.9 97.6 243.5 64 320 64C461.4 64 576 178.6 576 320C576 461.4 461.4 576 320 576C233 576 156.1 532.6 109.9 466.3C99.8 451.8 103.3 431.9 117.8 421.7C132.3 411.5 152.2 415.1 162.4 429.6C197.2 479.4 254.8 511.9 320 511.9C426 511.9 512 425.9 512 319.9C512 213.9 426 128 320 128z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="circle-xmark-solid-full">
    <path d="M320 576C461.4 576 576 461.4 576 320C576 178.6 461.4 64 320 64C178.6 64 64 178.6 64 320C64 461.4 178.6 576 320 576zM231 231C240.4 221.6 255.6 221.6 264.9 231L319.9 286L374.9 231C384.3 221.6 399.5 221.6 408.8 231C418.1 240.4 418.2 255.6 408.8 264.9L353.8 319.9L408.8 374.9C418.2 384.3 418.2 399.5 408.8 408.8C399.4 418.1 384.2 418.2 374.9 408.8L319.9 353.8L264.9 408.8C255.5 418.2 240.3 418.2 231 408.8C221.7 399.4 221.6 384.2 231 374.9L286 319.9L231 264.9C221.6 255.5 221.6 240.3 231 231z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="cloud-arrow-up-solid-full">
    <path d="M176 544C96.5 544 32 479.5 32 400C32 336.6 73 282.8 129.9 263.5C128.6 255.8 128 248 128 240C128 160.5 192.5 96 272 96C327.4 96 375.5 127.3 399.6 173.1C413.8 164.8 430.4 160 448 160C501 160 544 203 544 256C544 271.7 540.2 286.6 533.5 299.7C577.5 320 608 364.4 608 416C608 486.7 550.7 544 480 544L176 544zM337 255C327.6 245.6 312.4 245.6 303.1 255L231.1 327C221.7 336.4 221.7 351.6 231.1 360.9C240.5 370.2 255.7 370.3 265 360.9L296 329.9L296 432C296 445.3 306.7 456 320 456C333.3 456 344 445.3 344 432L344 329.9L375 360.9C384.4 370.3 399.6 370.3 408.9 360.9C418.2 351.5 418.3 336.3 408.9 327L336.9 255z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="comments-solid-full">
    <path d="M416 208C416 305.2 330 384 224 384C197.3 384 171.9 379 148.8 370L67.2 413.2C57.9 418.1 46.5 416.4 39 409C31.5 401.6 29.8 390.1 34.8 380.8L70.4 313.6C46.3 284.2 32 247.6 32 208C32 110.8 118 32 224 32C330 32 416 110.8 416 208zM416 576C321.9 576 243.6 513.9 227.2 432C347.2 430.5 451.5 345.1 463 229.3C546.3 248.5 608 317.6 608 400C608 439.6 593.7 476.2 569.6 505.6L605.2 572.8C610.1 582.1 608.4 593.5 601 601C593.6 608.5 582.1 610.2 572.8 605.2L491.2 562C468.1 571 442.7 576 416 576z"></path>
  </symbol>
  <symbol version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 16 16" id="copy">
    <title>复制@2x</title>
    <g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
      <g id="01首页" transform="translate(-862, -148)" stroke="#6F7189" stroke-width="1.25">
        <g id="矩形" transform="translate(800, 10)">
          <g id="编组-18" transform="translate(0, 70)">
            <g id="编组-5" transform="translate(20, -14)">
              <g id="编组-9" transform="translate(42, 0)">
                <g id="编组-12" transform="translate(0, 82)">
                  <g id="编组-23" transform="translate(1.5, 1)">
                    <rect id="矩形" x="4.125" y="0.625" width="8.75" height="8.75" rx="2"></rect>
                    <path d="M10,11.6587302 C10,12.6756354 9.17563541,13.5 8.15873016,13.5 L1.84126984,13.5 C0.824364588,13.5 0,12.6756354 0,11.6587302 L0,5.34126984 C0,4.32436459 0.824364588,3.5 1.84126984,3.5" id="路径" stroke-linecap="round" stroke-linejoin="round"></path>
                  </g>
                </g>
              </g>
            </g>
          </g>
        </g>
      </g>
    </g>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="eraser-solid-full">
    <path d="M210.5 480L333.5 480L398.8 414.7L225.3 241.2L98.6 367.9L210.6 479.9zM256 544L210.5 544C193.5 544 177.2 537.3 165.2 525.3L49 409C38.1 398.1 32 383.4 32 368C32 352.6 38.1 337.9 49 327L295 81C305.9 70.1 320.6 64 336 64C351.4 64 366.1 70.1 377 81L559 263C569.9 273.9 576 288.6 576 304C576 319.4 569.9 334.1 559 345L424 480L544 480C561.7 480 576 494.3 576 512C576 529.7 561.7 544 544 544L256 544z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="gear-solid-full">
    <path d="M259.1 73.5C262.1 58.7 275.2 48 290.4 48L350.2 48C365.4 48 378.5 58.7 381.5 73.5L396 143.5C410.1 149.5 423.3 157.2 435.3 166.3L503.1 143.8C517.5 139 533.3 145 540.9 158.2L570.8 210C578.4 223.2 575.7 239.8 564.3 249.9L511 297.3C511.9 304.7 512.3 312.3 512.3 320C512.3 327.7 511.8 335.3 511 342.7L564.4 390.2C575.8 400.3 578.4 417 570.9 430.1L541 481.9C533.4 495 517.6 501.1 503.2 496.3L435.4 473.8C423.3 482.9 410.1 490.5 396.1 496.6L381.7 566.5C378.6 581.4 365.5 592 350.4 592L290.6 592C275.4 592 262.3 581.3 259.3 566.5L244.9 496.6C230.8 490.6 217.7 482.9 205.6 473.8L137.5 496.3C123.1 501.1 107.3 495.1 99.7 481.9L69.8 430.1C62.2 416.9 64.9 400.3 76.3 390.2L129.7 342.7C128.8 335.3 128.4 327.7 128.4 320C128.4 312.3 128.9 304.7 129.7 297.3L76.3 249.8C64.9 239.7 62.3 223 69.8 209.9L99.7 158.1C107.3 144.9 123.1 138.9 137.5 143.7L205.3 166.2C217.4 157.1 230.6 149.5 244.6 143.4L259.1 73.5zM320.3 400C364.5 399.8 400.2 363.9 400 319.7C399.8 275.5 363.9 239.8 319.7 240C275.5 240.2 239.8 276.1 240 320.3C240.2 364.5 276.1 400.2 320.3 400z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="image-solid-full">
    <path d="M160 96C124.7 96 96 124.7 96 160L96 480C96 515.3 124.7 544 160 544L480 544C515.3 544 544 515.3 544 480L544 160C544 124.7 515.3 96 480 96L160 96zM224 176C250.5 176 272 197.5 272 224C272 250.5 250.5 272 224 272C197.5 272 176 250.5 176 224C176 197.5 197.5 176 224 176zM368 288C376.4 288 384.1 292.4 388.5 299.5L476.5 443.5C481 450.9 481.2 460.2 477 467.8C472.8 475.4 464.7 480 456 480L184 480C175.1 480 166.8 475 162.7 467.1C158.6 459.2 159.2 449.6 164.3 442.3L220.3 362.3C224.8 355.9 232.1 352.1 240 352.1C247.9 352.1 255.2 355.9 259.7 362.3L286.1 400.1L347.5 299.6C351.9 292.5 359.6 288.1 368 288.1z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="paper-plane-solid-full">
    <path d="M568.4 37.7C578.2 34.2 589 36.7 596.4 44C603.8 51.3 606.2 62.2 602.7 72L424.7 568.9C419.7 582.8 406.6 592 391.9 592C377.7 592 364.9 583.4 359.6 570.3L295.4 412.3C290.9 401.3 292.9 388.7 300.6 379.7L395.1 267.3C400.2 261.2 399.8 252.3 394.2 246.7C388.6 241.1 379.6 240.7 373.6 245.8L261.2 340.1C252.1 347.7 239.6 349.7 228.6 345.3L70.1 280.8C57 275.5 48.4 262.7 48.4 248.5C48.4 233.8 57.6 220.7 71.5 215.7L568.4 37.7z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="paperclip-solid-full">
    <path d="M288.6 76.8C344.8 20.6 436 20.6 492.2 76.8C548.4 133 548.4 224.2 492.2 280.4L328.2 444.4C293.8 478.8 238.1 478.8 203.7 444.4C169.3 410 169.3 354.3 203.7 319.9L356.5 167.3C369 154.8 389.3 154.8 401.8 167.3C414.3 179.8 414.3 200.1 401.8 212.6L249 365.3C239.6 374.7 239.6 389.9 249 399.2C258.4 408.5 273.6 408.6 282.9 399.2L446.9 235.2C478.1 204 478.1 153.3 446.9 122.1C415.7 90.9 365 90.9 333.8 122.1L169.8 286.1C116.7 339.2 116.7 425.3 169.8 478.4C222.9 531.5 309 531.5 362.1 478.4L492.3 348.3C504.8 335.8 525.1 335.8 537.6 348.3C550.1 360.8 550.1 381.1 537.6 393.6L407.4 523.6C329.3 601.7 202.7 601.7 124.6 523.6C46.5 445.5 46.5 318.9 124.6 240.8L288.6 76.8z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="play-solid-full">
    <path d="M187.2 100.9C174.8 94.1 159.8 94.4 147.6 101.6C135.4 108.8 128 121.9 128 136L128 504C128 518.1 135.5 531.2 147.6 538.4C159.7 545.6 174.8 545.9 187.2 539.1L523.2 355.1C536 348.1 544 334.6 544 320C544 305.4 536 291.9 523.2 284.9L187.2 100.9z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="rotate-solid-full">
    <path d="M544.1 256L552 256C565.3 256 576 245.3 576 232L576 88C576 78.3 570.2 69.5 561.2 65.8C552.2 62.1 541.9 64.2 535 71L483.3 122.8C439 86.1 382 64 320 64C191 64 84.3 159.4 66.6 283.5C64.1 301 76.2 317.2 93.7 319.7C111.2 322.2 127.4 310 129.9 292.6C143.2 199.5 223.3 128 320 128C364.4 128 405.2 143 437.7 168.3L391 215C384.1 221.9 382.1 232.2 385.8 241.2C389.5 250.2 398.3 256 408 256L544.1 256zM573.5 356.5C576 339 563.8 322.8 546.4 320.3C529 317.8 512.7 330 510.2 347.4C496.9 440.4 416.8 511.9 320.1 511.9C275.7 511.9 234.9 496.9 202.4 471.6L249 425C255.9 418.1 257.9 407.8 254.2 398.8C250.5 389.8 241.7 384 232 384L88 384C74.7 384 64 394.7 64 408L64 552C64 561.7 69.8 570.5 78.8 574.2C87.8 577.9 98.1 575.8 105 569L156.8 517.2C201 553.9 258 576 320 576C449 576 555.7 480.6 573.4 356.5z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="volume-high-solid-full">
    <path d="M533.6 96.5C523.3 88.1 508.2 89.7 499.8 100C491.4 110.3 493 125.4 503.3 133.8C557.5 177.8 592 244.8 592 320C592 395.2 557.5 462.2 503.3 506.3C493 514.7 491.5 529.8 499.8 540.1C508.1 550.4 523.3 551.9 533.6 543.6C598.5 490.7 640 410.2 640 320C640 229.8 598.5 149.2 533.6 96.5zM473.1 171C462.8 162.6 447.7 164.2 439.3 174.5C430.9 184.8 432.5 199.9 442.8 208.3C475.3 234.7 496 274.9 496 320C496 365.1 475.3 405.3 442.8 431.8C432.5 440.2 431 455.3 439.3 465.6C447.6 475.9 462.8 477.4 473.1 469.1C516.3 433.9 544 380.2 544 320.1C544 260 516.3 206.3 473.1 171.1zM412.6 245.5C402.3 237.1 387.2 238.7 378.8 249C370.4 259.3 372 274.4 382.3 282.8C393.1 291.6 400 305 400 320C400 335 393.1 348.4 382.3 357.3C372 365.7 370.5 380.8 378.8 391.1C387.1 401.4 402.3 402.9 412.6 394.6C434.1 376.9 448 350.1 448 320C448 289.9 434.1 263.1 412.6 245.5zM80 416L128 416L262.1 535.2C268.5 540.9 276.7 544 285.2 544C304.4 544 320 528.4 320 509.2L320 130.8C320 111.6 304.4 96 285.2 96C276.7 96 268.5 99.1 262.1 104.8L128 224L80 224C53.5 224 32 245.5 32 272L32 368C32 394.5 53.5 416 80 416z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="wand-magic-sparkles-solid-full">
    <path d="M295.4 37L310.2 73.8L347 88.6C350 89.8 352 92.8 352 96C352 99.2 350 102.2 347 103.4L310.2 118.2L295.4 155C294.2 158 291.2 160 288 160C284.8 160 281.8 158 280.6 155L265.8 118.2L229 103.4C226 102.2 224 99.2 224 96C224 92.8 226 89.8 229 88.6L265.8 73.8L280.6 37C281.8 34 284.8 32 288 32C291.2 32 294.2 34 295.4 37zM142.7 105.7L164.2 155.8L214.3 177.3C220.2 179.8 224 185.6 224 192C224 198.4 220.2 204.2 214.3 206.7L164.2 228.2L142.7 278.3C140.2 284.2 134.4 288 128 288C121.6 288 115.8 284.2 113.3 278.3L91.8 228.2L41.7 206.7C35.8 204.2 32 198.4 32 192C32 185.6 35.8 179.8 41.7 177.3L91.8 155.8L113.3 105.7C115.8 99.8 121.6 96 128 96C134.4 96 140.2 99.8 142.7 105.7zM496 368C502.4 368 508.2 371.8 510.7 377.7L532.2 427.8L582.3 449.3C588.2 451.8 592 457.6 592 464C592 470.4 588.2 476.2 582.3 478.7L532.2 500.2L510.7 550.3C508.2 556.2 502.4 560 496 560C489.6 560 483.8 556.2 481.3 550.3L459.8 500.2L409.7 478.7C403.8 476.2 400 470.4 400 464C400 457.6 403.8 451.8 409.7 449.3L459.8 427.8L481.3 377.7C483.8 371.8 489.6 368 496 368zM492 64C503 64 513.6 68.4 521.5 76.2L563.8 118.5C571.6 126.4 576 137 576 148C576 159 571.6 169.6 563.8 177.5L475.6 265.7L374.3 164.4L462.5 76.2C470.4 68.4 481 64 492 64zM76.2 462.5L340.4 198.3L441.7 299.6L177.5 563.8C169.6 571.6 159 576 148 576C137 576 126.4 571.6 118.5 563.8L76.2 521.5C68.4 513.6 64 503 64 492C64 481 68.4 470.4 76.2 462.5z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="glasses-solid-full">
    <path d="M175.3 160C161.3 160 148.8 169.2 144.7 182.6L102.4 320L256 320C273.7 320 288 334.3 288 352L352 352C352 334.3 366.3 320 384 320L537.6 320L495.3 182.6C491.2 169.2 478.8 160 464.7 160L432 160C414.3 160 400 145.7 400 128C400 110.3 414.3 96 432 96L464.7 96C506.8 96 544.1 123.5 556.5 163.8L601.9 311.3C606 324.5 608 338.2 608 352L608 448C608 501 565 544 512 544L448 544C395 544 352 501 352 448L352 416L288 416L288 448C288 501 245 544 192 544L128 544C75 544 32 501 32 448L32 352C32 338.2 34.1 324.5 38.1 311.3L83.5 163.8C95.9 123.5 133.1 96 175.3 96L208 96C225.7 96 240 110.3 240 128C240 145.7 225.7 160 208 160L175.3 160zM96 384L96 448C96 465.7 110.3 480 128 480L192 480C209.7 480 224 465.7 224 448L224 384L96 384zM512 480C529.7 480 544 465.7 544 448L544 384L416 384L416 448C416 465.7 430.3 480 448 480L512 480z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="up-right-from-square-solid-full">
    <path d="M354.4 83.8C359.4 71.8 371.1 64 384 64L544 64C561.7 64 576 78.3 576 96L576 256C576 268.9 568.2 280.6 556.2 285.6C544.2 290.6 530.5 287.8 521.3 278.7L464 221.3L310.6 374.6C298.1 387.1 277.8 387.1 265.3 374.6C252.8 362.1 252.8 341.8 265.3 329.3L418.7 176L361.4 118.6C352.2 109.4 349.5 95.7 354.5 83.7zM64 240C64 195.8 99.8 160 144 160L224 160C241.7 160 256 174.3 256 192C256 209.7 241.7 224 224 224L144 224C135.2 224 128 231.2 128 240L128 496C128 504.8 135.2 512 144 512L400 512C408.8 512 416 504.8 416 496L416 416C416 398.3 430.3 384 448 384C465.7 384 480 398.3 480 416L480 496C480 540.2 444.2 576 400 576L144 576C99.8 576 64 540.2 64 496L64 240z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="file-lines-solid-full">
    <path d="M128 128C128 92.7 156.7 64 192 64L341.5 64C358.5 64 374.8 70.7 386.8 82.7L493.3 189.3C505.3 201.3 512 217.6 512 234.6L512 512C512 547.3 483.3 576 448 576L192 576C156.7 576 128 547.3 128 512L128 128zM336 122.5L336 216C336 229.3 346.7 240 360 240L453.5 240L336 122.5zM248 320C234.7 320 224 330.7 224 344C224 357.3 234.7 368 248 368L392 368C405.3 368 416 357.3 416 344C416 330.7 405.3 320 392 320L248 320zM248 416C234.7 416 224 426.7 224 440C224 453.3 234.7 464 248 464L392 464C405.3 464 416 453.3 416 440C416 426.7 405.3 416 392 416L248 416z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="circle-check-solid-full">
    <path d="M320 576C178.6 576 64 461.4 64 320C64 178.6 178.6 64 320 64C461.4 64 576 178.6 576 320C576 461.4 461.4 576 320 576zM438 209.7C427.3 201.9 412.3 204.3 404.5 215L285.1 379.2L233 327.1C223.6 317.7 208.4 317.7 199.1 327.1C189.8 336.5 189.7 351.7 199.1 361L271.1 433C276.1 438 282.9 440.5 289.9 440C296.9 439.5 303.3 435.9 307.4 430.2L443.3 243.2C451.1 232.5 448.7 217.5 438 209.7z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="circle-exclamation-solid-full">
    <path d="M320 576C178.6 576 64 461.4 64 320C64 178.6 178.6 64 320 64C461.4 64 576 178.6 576 320C576 461.4 461.4 576 320 576zM320 384C302.3 384 288 398.3 288 416C288 433.7 302.3 448 320 448C337.7 448 352 433.7 352 416C352 398.3 337.7 384 320 384zM320 192C301.8 192 287.3 207.5 288.6 225.7L296 329.7C296.9 342.3 307.4 352 319.9 352C332.5 352 342.9 342.3 343.8 329.7L351.2 225.7C352.5 207.5 338.1 192 319.8 192z"></path>
  </symbol>
</svg>
    <div class="main-layout">
        <div class="sidebar">
		    <div class="logo">
                <h1>AI 数字人助手 <span class="status-indicator" id="apiStatus"></span></h1>
		        <p class="panel-description" style="color: #fff;">本站使用Gemini API。使用前需在设置里填写。</p>
            </div>
            
            <div class="tabs">
                <button class="tab-btn active" data-tab="chat">
                    <svg class="icon"><use xlink:href="#comments-solid-full"></use></svg>AI对话
                </button>
                <button class="tab-btn" data-tab="vision">
                    <svg class="icon"><use xlink:href="#image-solid-full"></use></svg>AI图像
                </button>
                <button class="tab-btn" data-tab="settings">
                    <svg class="icon"><use xlink:href="#gear-solid-full"></use></svg> API设置
                </button>
            </div>
        </div>
        
        <div class="main-content">
            <div class="tab-content">
                <div class="tab-pane active" id="chatTab">
                    <div class="panel">
                        <div class="secondary-tabs">
                            <button class="secondary-tab-btn active" data-subtab="conversation" data-parent="chat">自由对话</button>
                            <button class="secondary-tab-btn" data-subtab="prompt" data-parent="chat">提示词扩写</button>
                        </div>
                    
                        <div class="secondary-tab-pane active" id="conversationSubTab">
                            <h2 style="display: none;">自由对话</h2>
                            <div class="chat-history scrollable" id="chatHistory">
                                </div>

                            <div id="chatFilePreview">
                                <div id="chatFileDisplay">
                                    <img id="chatFilePreviewImg" src="" alt="preview" style="display: none;">
                                    <i id="chatFileIcon" class="fas fa-file-alt" style="display: none;"></i>
                                </div>
                                <span id="chatFilePreviewName"></span>
                                <svg class="icon" id="removeChatFile" title="移除文件"><use xlink:href="#circle-xmark-solid-full"></use></svg>
                            </div>
                            
                            <div class="chat-input-area">
                                <textarea id="chatInput" placeholder="输入您的问题或想法（按Enter发送，Shift+Enter换行。支持图片、pdf、txt格式上传）" rows="1"></textarea>
                                <div class="btn-group">
                                    <button class="btn-secondary" id="uploadChatFileBtn" title="支持图片、pdf、txt格式上传">
                                        <svg class="icon"><use xlink:href="#paperclip-solid-full"></use></svg>
                                    </button>
                                     <button class="btn-secondary" id="clearChatBtn" title="清空对话历史" style="margin-right: 16px;">
                                        <svg class="icon"><use xlink:href="#eraser-solid-full"></use></svg>
                                    </button>
                                    <button class="btn-primary" id="sendBtn" title="发送消息" style="width: 62px; background: var(--btcolor);">
                                        <svg class="icon"><use xlink:href="#paper-plane-solid-full"></use></svg>
                                    </button>
                                </div>
                            </div>
                            <input type="file" id="chatFileUpload" accept="image/*, application/pdf, text/plain" style="display: none;">
                        </div>

                        <div class="secondary-tab-pane" id="promptSubTab">
                             <h2 style="display: none;">提示词扩写</h2>
                            <p class="panel-description">
                                输入您的原始提示词，Gemini将为您扩展优化，生成更具想象力的详细描述（可在设置里修改扩写模板）。
                            </p>
                            <div class="chat-input-area">
                                 <textarea id="promptInput" placeholder="在此输入您的原始提示词..." style="min-height: 250px;"></textarea>
                                 <div class="btn-group">
                                    <button class="btn-secondary" id="clearExpandBtn" style="margin-right: 16px;">
                                       <svg class="icon"><use xlink:href="#eraser-solid-full"></use></svg>
                                    </button>
                                    <button class="btn-primary" id="expandBtn" style="width: 62px; background: var(--btcolor);">
                                        <svg class="icon"><use xlink:href="#wand-magic-sparkles-solid-full"></use></svg>
                                    </button>
                                </div>
                            </div>
                            <input type="file" id="promptFileUpload" accept="image/*" style="display: none;">
                        </div>
                    </div>
                </div>

                <div class="tab-pane" id="visionTab">
                    <div class="panel">                        
                        <div id="image-analysisSubTab" class="secondary-tab-pane active">
                            <h2><svg class="icon"><use xlink:href="#glasses-solid-full"></use></svg> 图像识别（提示词反推）</h2>
                            <p class="panel-description">
                                上传一张图片，AI将为您分析图像内容并生成详细的提示词，可用于AI绘画（可在设置里修改反推模板）。
                            </p>
                            <div class="vision-layout">
                                <div>
                                    <div class="upload-container" id="uploadArea">
                                        <div id="uploadContent" class="upload-icon">
                                            <svg class="icon"><use xlink:href="#cloud-arrow-up-solid-full"></use></svg>
                                            <p>拖放图片到此处或<br><b>点击上传</b></p>
                                        </div>
                                        <img id="imagePreview" alt="预览图片">
                                        <div class="close-preview" id="closePreview" style="display: none;">
                                            <svg class="icon"><use xlink:href="#circle-xmark-solid-full"></use></svg>
                                        </div>
                                        <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                                    </div>
                                </div>
                                <div>
                                    <div class="response-area" id="visionResponseArea">
                                        <div class="response-header">
                                            <h3> AI分析结果</h3>
                                            <button class="copy-btn" id="copyVisionBtn">
                                                <svg class="icon"><use xlink:href="#copy"></use></svg>复制
                                            </button>
                                        </div>
                                        <div class="response-content" id="visionResponse">
                                            图片上传后将自动分析...
                                        </div>
                                        <div class="btn-group vision-buttons">
                                            <button class="btn-primary" id="regenerateVisionBtn">
                                                <svg class="icon"><use xlink:href="#rotate-solid-full"></use></svg>重新生成
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-pane" id="settingsTab">
                    <div class="settings-pane">
                        <div class="settings-header">
                            <h2><svg class="icon"><use xlink:href="#gear-solid-full"></use></svg>设置</h2>
                        </div>
                        <div class="shezhik">
                            <div class="settings-item">
                                <label for="apiKey">Gemini API 密钥</label>
                                <p class="panel-description" style="color: var(--text3);">
                                    需申请Gemini API并填入此处，查看<a href="https://www.bilibili.com/video/BV1ri42127Kv/?spm_id_from=333.337.search-card.all.click" target="_blank" style="color:var(--main-color);">获取密钥教程</a>。科学上网代理模式设置为“全局连接”，勾选支持的国家，查看<a href="https://developer.android.google.cn/studio/preview/gemini/availability?hl=zh-cn" target="_blank" style="color:var(--main-color);">支持国家列表</a>。密钥只保存在您的浏览器中，不会被发送到任何服务器。
                                    <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: var(--main-color); text-decoration: none;">获取密钥 <svg class="icon"><use xlink:href="#up-right-from-square-solid-full"></use></svg></a>
				                </p>
                                <input type="password" id="apiKey" placeholder="输入您的Gemini API密钥">
                            </div>
                            
<div class="settings-item">
    <label for="modelSelection">模型选择</label>
    <p class="panel-description" style="color: var(--text3);">
        选择用于所有AI功能的模型。三者均支持多模态。
    </p>
<select id="modelSelection">
    <option value="gemini-2.5-flash">Gemini 2.5 flash (快速)</option>
    <option value="gemini-2.5-pro">Gemini 2.5 Pro (强大/稳定)</option> 
    <option value="gemini-1.5-flash-latest">Gemini 1.5 Flash (快速/经济)</option>
</select>
</div>

			                <div class="settings-item">
                                <label for="promptTemplate">
                                    <div class="panel-title-wrapper">
                                        提示词扩写模板
                                    </div>
                                    <button class="reset-btn" id="resetPromptBtn">
                                        <svg class="icon"><use xlink:href="#arrow-rotate-left-solid-full"></use></svg>恢复默认
                                    </button>
                                </label>
                                <textarea id="promptTemplate"></textarea>
                            </div>
                            
                            <div class="settings-item">
                                <label for="visionTemplate">
                                    <div class="panel-title-wrapper">
                                        提示词反推模板
                                    </div>
                                    <button class="reset-btn" id="resetVisionBtn">
                                        <svg class="icon"><use xlink:href="#arrow-rotate-left-solid-full"></use></svg>恢复默认
                                    </button>
                                </label>
                                <textarea id="visionTemplate"></textarea>
                            </div>
                        </div>
                        <div class="settings-footer">
                            <button class="btn-secondary" id="cancelSettings">取消</button>
                            <button class="btn-primary" id="saveSettings">保存设置</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
    // 默认设置
    const defaultPromptTemplate = "You are creating a prompt for an AI image generation model like Stable Diffusion. Your task is to expand on the user's original idea. First, describe the potential image in more detail. Second, based on that description, generate a rich, detailed, and imaginative text prompt. The final output should only be the prompt itself. Embellish it as needed, but keep it under 120 tokens. The user's original idea is: %s";
    const defaultVisionTemplate = "Analyze the uploaded image in great detail. Cover the main subjects, the setting, composition, colors, lighting, style, and overall atmosphere. Based on your comprehensive description, generate a high-quality, detailed, and artistic prompt suitable for an image generation model like Stable Diffusion or Midjourney. The final output should only be the prompt itself, and keep it under 120 tokens.";

    document.addEventListener('DOMContentLoaded', () => {
        // Global elements
        const apiStatus = document.getElementById('apiStatus');

        // Settings pane elements
        const apiKeyInput = document.getElementById('apiKey');
        const modelSelection = document.getElementById('modelSelection');
        const promptTemplateInput = document.getElementById('promptTemplate');
        const visionTemplateInput = document.getElementById('visionTemplate');
        const resetPromptBtn = document.getElementById('resetPromptBtn');
        const resetVisionBtn = document.getElementById('resetVisionBtn');
        const saveSettingsBtn = document.getElementById('saveSettings');
        const cancelSettingsBtn = document.getElementById('cancelSettings');

        // Tab elements
        const mainTabBtns = document.querySelectorAll('.tab-btn');
        const mainTabPanes = document.querySelectorAll('.tab-pane');
        const secondaryTabBtns = document.querySelectorAll('.secondary-tab-btn');
        const secondaryTabPanes = document.querySelectorAll('.secondary-tab-pane');

        // Chat functionality elements
        const expandBtn = document.getElementById('expandBtn');
        const clearExpandBtn = document.getElementById('clearExpandBtn');
        const promptInput = document.getElementById('promptInput');
        const sendBtn = document.getElementById('sendBtn');
        const clearChatBtn = document.getElementById('clearChatBtn');
        const chatInput = document.getElementById('chatInput');
        const chatHistory = document.getElementById('chatHistory');
        const uploadChatFileBtn = document.getElementById('uploadChatFileBtn');
        const chatFileUpload = document.getElementById('chatFileUpload');
        const chatFilePreview = document.getElementById('chatFilePreview');
        const chatFileDisplay = document.getElementById('chatFileDisplay');
        const chatFilePreviewImg = document.getElementById('chatFilePreviewImg');
        const chatFileIcon = document.getElementById('chatFileIcon');
        const chatFilePreviewName = document.getElementById('chatFilePreviewName');
        const removeChatFile = document.getElementById('removeChatFile');

        // Vision functionality elements
        const uploadArea = document.getElementById('uploadArea');
        const uploadContent = document.getElementById('uploadContent');
        const imageUpload = document.getElementById('imageUpload');
        const imagePreview = document.getElementById('imagePreview');
        const closePreview = document.getElementById('closePreview');
        const visionResponse = document.getElementById('visionResponse');
        const copyVisionBtn = document.getElementById('copyVisionBtn');
        const regenerateVisionBtn = document.getElementById('regenerateVisionBtn');
        
        // State variables
        let apiHistory = [];
        let displayHistory = [];
        let chatUploadedFile = null;
        let visionUploadedFile = null;
        let currentSettingsFormState = {};
        let lastRequestTime = 0;
        const REQUEST_INTERVAL = 3000;


        // --- Initialization ---
        loadSettings();
        checkApiStatus();
        setupEventListeners();
        clearChat();

        // --- Event Listener Setup ---
        function setupEventListeners() {
            mainTabBtns.forEach(btn => btn.addEventListener('click', () => switchMainTab(btn)));
            secondaryTabBtns.forEach(btn => btn.addEventListener('click', () => switchSecondaryTab(btn)));
            saveSettingsBtn.addEventListener('click', saveSettingsAction);
            cancelSettingsBtn.addEventListener('click', cancelSettingsAction);
            resetPromptBtn.addEventListener('click', () => promptTemplateInput.value = defaultPromptTemplate);
            resetVisionBtn.addEventListener('click', () => visionTemplateInput.value = defaultVisionTemplate);
            expandBtn.addEventListener('click', handleExpandPrompt);
            clearExpandBtn.addEventListener('click', () => promptInput.value = '');
            promptInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    expandBtn.click();
                }
            });
            sendBtn.addEventListener('click', handleSendMessage);
            clearChatBtn.addEventListener('click', clearChat);
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendBtn.click();
                }
            });
            uploadChatFileBtn.addEventListener('click', () => chatFileUpload.click());
            chatFileUpload.addEventListener('change', handleChatFileSelect);
            removeChatFile.addEventListener('click', removeChatUploadedFile);
            uploadArea.addEventListener('click', () => imageUpload.click());
            imageUpload.addEventListener('change', handleVisionFileSelect);
            closePreview.addEventListener('click', resetVisionUpload);
            copyVisionBtn.addEventListener('click', copyVisionResult);
            regenerateVisionBtn.addEventListener('click', handleRegenerateVision);
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => uploadArea.classList.add('highlight'), false);
            });
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('highlight'), false);
            });
            uploadArea.addEventListener('drop', handleDrop, false);
            document.addEventListener('click', (e) => {
                const copyBtn = e.target.closest('.copy-message-btn');
                if (copyBtn) {
                    const messageContent = copyBtn.closest('.message-bubble').querySelector('.message-content').innerHTML;
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = messageContent;
                    navigator.clipboard.writeText(tempDiv.textContent || tempDiv.innerText).then(() => {
                        showAlert('已复制消息内容', 'success');
                    });
                }
            });
        }

        // --- Tab Switching Logic ---
        function switchMainTab(clickedBtn) {
            mainTabBtns.forEach(b => b.classList.remove('active'));
            mainTabPanes.forEach(pane => pane.classList.remove('active'));
            clickedBtn.classList.add('active');
            const targetPane = document.getElementById(`${clickedBtn.dataset.tab}Tab`);
            if (targetPane) {
                targetPane.classList.add('active');
            }
            if (clickedBtn.dataset.tab === 'settings') {
                currentSettingsFormState = {
                    apiKey: apiKeyInput.value,
                    model: modelSelection.value,
                    promptTemplate: promptTemplateInput.value,
                    visionTemplate: visionTemplateInput.value,
                };
            } else {
                loadSettings(); 
            }
        }

        function switchSecondaryTab(clickedBtn) {
            const parentTabId = clickedBtn.dataset.parent;
            const relevantSecondaryBtns = document.querySelectorAll(`.secondary-tab-btn[data-parent="${parentTabId}"]`);
            const relevantSecondaryPanes = document.getElementById(`${parentTabId}Tab`).querySelectorAll('.secondary-tab-pane');
            relevantSecondaryBtns.forEach(b => b.classList.remove('active'));
            relevantSecondaryPanes.forEach(pane => pane.classList.remove('active'));
            clickedBtn.classList.add('active');
            const targetPane = document.getElementById(`${clickedBtn.dataset.subtab}SubTab`);
            if (targetPane) {
                targetPane.classList.add('active');
            }
        }
        
        // --- Core Functionality ---
        async function handleExpandPrompt() {
            const prompt = promptInput.value.trim();
            if (!prompt) return showAlert('请输入要扩写的提示词', 'error');
            if (!checkRequestFrequency()) return;

            const template = localStorage.getItem('promptTemplate') || defaultPromptTemplate;
            const fullPrompt = template.replace('%s', prompt);
            
            setButtonLoading(expandBtn, true, '');
            try {
                const contents = [{ role: "user", parts: [{ text: fullPrompt }] }];
                const expandedPrompt = await callGeminiApi(contents);
                promptInput.value = expandedPrompt;
                showAlert('提示词扩写完成！', 'success');
            } catch (error) {
                showAlert(`扩写失败: ${error.message}`, 'error');
            } finally {
                setButtonLoading(expandBtn, false, '<svg class="icon"><use xlink:href="#wand-magic-sparkles-solid-full"></use></svg>');
            }
        }

        async function handleSendMessage() {
            const message = chatInput.value.trim();
            if (!message && !chatUploadedFile) return showAlert('请输入消息或上传文件', 'error');
            if (!checkRequestFrequency()) return;

            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            const userParts = [];
            if (message) userParts.push({ text: message });
            if (chatUploadedFile) {
                userParts.push({
                    inline_data: {
                        mime_type: chatUploadedFile.mime,
                        data: chatUploadedFile.base64
                    }
                });
            }
            
            displayHistory.push({
                role: 'user', content: message, timestamp,
                fileData: chatUploadedFile ? { type: chatUploadedFile.mime, name: chatUploadedFile.name, preview: chatUploadedFile.mime.startsWith('image/') ? `data:${chatUploadedFile.mime};base64,${chatUploadedFile.base64}` : null } : null
            });
            apiHistory.push({ role: "user", parts: userParts });

            renderChatHistory();
            chatInput.value = '';
            removeChatUploadedFile();
            
            setButtonLoading(sendBtn, true, '');

            try {
                const response = await callGeminiApi(apiHistory);
                const aiTimestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                displayHistory.push({ role: 'ai', content: response, timestamp: aiTimestamp });
                apiHistory.push({ role: "model", parts: [{ text: response }] });
                renderChatHistory();
            } catch (error) {
                showAlert(`发送失败: ${error.message}`, 'error');
                // Optional: remove the user's last message from history on failure
                // apiHistory.pop();
                // displayHistory.pop();
                renderChatHistory();
            } finally {
                setButtonLoading(sendBtn, false, '<svg class="icon"><use xlink:href="#paper-plane-solid-full"></use></svg>');
            }
        }

        function clearChat() {
            apiHistory = [];
            displayHistory = [];
            displayHistory.push({
                role: 'ai',
                content: '<strong>您好 👏🏻😊<br>我是您身边的智能助手</strong><br><br>我可以为您答疑解惑，尽情创造，快来体验吧~',
                timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                initial: true
            });
            renderChatHistory();
            showAlert('对话历史已清空', 'success');
        }

        async function handleVisionFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                visionUploadedFile = file;
                await processAndAnalyzeImage(file);
            }
        }

        async function handleRegenerateVision() {
            if (!visionUploadedFile) {
                showAlert('请先上传图片', 'error');
                return;
            }
            await processAndAnalyzeImage(visionUploadedFile);
        }

        async function processAndAnalyzeImage(file) {
             if (!checkRequestFrequency()) {
                imageUpload.value = '';
                return;
            }
            const reader = new FileReader();
            reader.onload = async (event) => {
                imagePreview.src = event.target.result;
                imagePreview.style.display = 'block';
                closePreview.style.display = 'flex';
                uploadContent.style.display = 'none';
                visionResponse.innerHTML = '正在分析图片...';
                try {
                    const template = localStorage.getItem('visionTemplate') || defaultVisionTemplate;
                    const base64Image = event.target.result.split(',')[1];
                    const mimeType = file.type;
                    const contents = [{
                        parts: [
                            { text: template },
                            { inline_data: { mime_type: mimeType, data: base64Image } }
                        ]
                    }];
                    const analysis = await callGeminiApi(contents);
                    visionResponse.innerHTML = marked.parse(analysis);
                    showAlert('图片分析完成！', 'success');
                } catch (error) {
                    showAlert(`分析失败: ${error.message}`, 'error');
                    visionResponse.innerHTML = '分析失败，请重试。';
                }
            };
            reader.readAsDataURL(file);
        }
        
        function resetVisionUpload(e) {
            if (e) e.stopPropagation();
            imagePreview.style.display = 'none';
            closePreview.style.display = 'none';
            imagePreview.src = '';
            imageUpload.value = '';
            uploadContent.style.display = 'block';
            visionResponse.innerHTML = '图片上传后将自动分析...';
            visionUploadedFile = null;
        }

        function copyVisionResult() {
            const text = visionResponse.innerText; 
            if (text && text !== '图片上传后将自动分析...') {
                navigator.clipboard.writeText(text).then(() => showAlert('已复制到剪贴板！', 'success'));
            } else {
                showAlert('没有可复制的内容', 'error');
            }
        }
        
        // --- Settings Management ---
        function loadSettings() {
            apiKeyInput.value = localStorage.getItem('apiKey') || '';
            modelSelection.value = localStorage.getItem('geminiModel') || 'gemini-1.5-flash-latest';
            promptTemplateInput.value = localStorage.getItem('promptTemplate') || defaultPromptTemplate;
            visionTemplateInput.value = localStorage.getItem('visionTemplate') || defaultVisionTemplate;
        }

        function saveSettingsAction() {
            localStorage.setItem('apiKey', apiKeyInput.value);
            localStorage.setItem('geminiModel', modelSelection.value);
            localStorage.setItem('promptTemplate', promptTemplateInput.value);
            localStorage.setItem('visionTemplate', visionTemplateInput.value);
            checkApiStatus();
            showAlert('设置已保存！', 'success');
            document.querySelector('.tab-btn[data-tab="chat"]').click();
        }

        function cancelSettingsAction() {
            apiKeyInput.value = currentSettingsFormState.apiKey;
            modelSelection.value = currentSettingsFormState.model;
            promptTemplateInput.value = currentSettingsFormState.promptTemplate;
            visionTemplateInput.value = currentSettingsFormState.visionTemplate;
            document.querySelector('.tab-btn[data-tab="chat"]').click();
        }

        // --- Render and UI Update ---
        function renderChatHistory() {
            chatHistory.innerHTML = '';
            const AVATARS = {
                user: "img/user.webp",
                ai: "img/2z.gif",
                initial: "img/2z.gif"
            };
            displayHistory.forEach(msg => {
                const messageContainer = document.createElement('div');
                messageContainer.className = `message ${msg.role}-message ${msg.initial ? 'initial' : ''}`;
                let avatarSrc = msg.role === 'user' ? AVATARS.user : (msg.initial ? AVATARS.initial : AVATARS.ai);
                let contentHTML = msg.role === 'ai' ? marked.parse(msg.content) : msg.content;
                let fileAttachmentHTML = '';
                if (msg.fileData) {
                    const fileName = msg.fileData.name;
                    let filePreviewSrc = msg.fileData.type.startsWith('image/') ? msg.fileData.preview : '';
                    fileAttachmentHTML = `
                        <div class="message-file-attachment">
                            ${filePreviewSrc ? `<img src="${filePreviewSrc}" alt="file preview" style="max-width: 60px; max-height: 60px; border-radius: 8px; margin-right: 10px;">` : `<svg class="icon" style="font-size: 24px; margin-right: 10px; color: var(--text3);"><use xlink:href="#arrow-rotate-left-solid-full"></use></svg>`}
                            <span>${fileName}</span>
                        </div>
                    `;
                }
                messageContainer.innerHTML = `
                    <div class="message-avatar">
                        <img src="${avatarSrc}" style="width: 40px;" alt="${msg.role} avatar">
                    </div>
                    <div class="message-bubble">
                        <div class="message-content">${contentHTML}${fileAttachmentHTML}</div>
                        <div class="message-footer">
                            <span class="message-time">${msg.timestamp}</span>
                            ${msg.role === 'ai' ? `<button class="copy-message-btn" title="复制"><svg class="icon" style="width:14px; height:14px;"><use xlink:href="#copy"></use></svg></button>` : ''}
                        </div>
                    </div>
                `;
                chatHistory.appendChild(messageContainer);
            });
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        function showAlert(message, type = 'success') {
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            const iconId = type === 'success' ? 'circle-check-solid-full' : 'circle-exclamation-solid-full';
            alert.innerHTML = `<svg class="icon" style="margin-right: 8px;"><use xlink:href="#${iconId}"></use></svg> ${message}`;
            document.body.appendChild(alert);
            setTimeout(() => alert.remove(), 3000);
        }

        function setButtonLoading(button, isLoading, originalContent) {
            button.disabled = isLoading;
            if (isLoading) {
                button.classList.add('btn-disabled');
                button.dataset.originalContent = button.innerHTML;
                button.innerHTML = `<span class="loader"></span>`;
            } else {
                button.classList.remove('btn-disabled');
                if (button.dataset.originalContent) {
                    button.innerHTML = button.dataset.originalContent;
                }
            }
        }
        
        // --- API Call ---
        async function callGeminiApi(contents) {
            const apiKey = localStorage.getItem('apiKey');
            const model = localStorage.getItem('geminiModel') || 'gemini-1.5-flash-latest';
            if (!apiKey) throw new Error('请先在设置中填写您的Gemini API密钥');
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: contents,
                    generationConfig: { temperature: 0.7, maxOutputTokens: 8192 }
                })
            });
            const data = await response.json();
            if (!response.ok || !data.candidates) {
                console.error('API Error:', data);
                if (response.status === 429) throw new Error('请求过于频繁，请稍后再试。');
                if (data.error && data.error.message) throw new Error(data.error.message);
                throw new Error('API请求失败，请检查密钥或网络连接');
            }
            return data.candidates[0].content.parts[0].text;
        }

        async function checkApiStatus() {
            const apiKey = localStorage.getItem('apiKey');
            if (!apiKey) {
                updateApiStatus(false, '未设置API密钥');
                return;
            }
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                if (response.ok) {
                    updateApiStatus(true, 'API连接正常');
                } else {
                    updateApiStatus(false, 'API密钥无效或网络错误');
                }
            } catch (error) {
                console.error("API Status Check Error:", error);
                updateApiStatus(false, 'API连接失败');
            }
        }
        
        function updateApiStatus(isOnline, title) {
            apiStatus.className = `status-indicator status-${isOnline ? 'online' : 'offline'}`;
            apiStatus.title = title;
        }

        // --- Helper and Drag & Drop Functions ---
        function handleChatFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                chatUploadedFile = {
                    base64: event.target.result.split(',')[1],
                    mime: file.type,
                    name: file.name
                };
                chatFilePreviewName.textContent = file.name;
                chatFilePreview.style.display = 'flex';
                if (file.type.startsWith('image/')) {
                    chatFilePreviewImg.src = event.target.result;
                    chatFilePreviewImg.style.display = 'block';
                    chatFileIcon.style.display = 'none';
                } else {
                    chatFilePreviewImg.style.display = 'none';
                    chatFileIcon.className = file.type === 'application/pdf' ? 'fas fa-file-pdf' : 'fas fa-file-alt';
                    chatFileIcon.style.display = 'block';
                }
            };
            reader.readAsDataURL(file);
        }

        function removeChatUploadedFile() {
            chatUploadedFile = null;
            chatFileUpload.value = '';
            chatFilePreview.style.display = 'none';
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleDrop(e) {
            let file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                 visionUploadedFile = file;
                 processAndAnalyzeImage(file);
            } else {
                showAlert('目前只支持图片上传', 'error');
            }
        }

        function checkRequestFrequency() {
            const now = Date.now();
            if (now - lastRequestTime < REQUEST_INTERVAL) {
                showAlert('操作过于频繁，请稍后再试', 'error');
                return false;
            }
            lastRequestTime = now;
            return true;
        }
    });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</body>
</html>