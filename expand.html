<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºèƒ½æ‰©å›¾å·¥å…·</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ–¼ï¸</text></svg>">
    <style>
        :root {
            --main-color: #5a64ff;
            --btcolor: linear-gradient(113deg, #4c73ff, #6a52ff);
            --text1: #1a1d2e;
            --text2: #4a4e6d;
            --text3: #8d8fa3;
            --line: #e2e4f0;
            --mainbg: #f9fafb;
            --btactive: #e5e8ff;
            --lightbg: #f8f9ff;
            --shadow: #55537512;
            --card-bg: #ffffff;
            --blur: rgba(255, 255, 255, 0.5);
            --button: #5a64ff24;
            --user-msg-bg: #e2e5fd;
            --ai-msg-bg: #ffffff;
            --success-color: #2ecc71;
            --error-color: #e74c3c;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'HarmonyOS_Sans', 'Microsoft YaHei', 'Arial Unicode MS', sans-serif;
        }

        body {
            display: flex;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            background: linear-gradient(0deg, #f9f9ff 72%, #7a6fff);
            color: var(--text1);
            justify-content: center;
            align-items: center;
        }
        .icon {
            display: inline-block;
            width: 1.2em;
            height: 1.2em;
            fill: currentColor;
        }
        
        .main-layout {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            flex-direction: column;
            max-width: 1200px;
            width: 95%;
            border-radius: 12px;
        }
        
        .header {
            padding: 15px 30px 10px;
            display: flex;
            align-items: baseline;
            color: white;
            gap: 10px;
        }
        
        .logo h1 {
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .main-content {
            flex-grow: 1;
            padding: 10px;
            display: flex;
            overflow-y: auto;
        }
        
        .panel {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .panel-description {
            color: var(--text2);
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        
        .drawing-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            flex-grow: 1;
            overflow: auto;
            padding: 5px;
        }
        
        .drawing-controls-panel {
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .drawing-preview-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: auto; /* Push buttons to the bottom */
            padding-top: 20px;
            justify-content: center;
        }
        
        button {
            padding: 10px 24px;
            border-radius: 30px;
            border: none;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }
        
        .btn-primary {
            background: var(--btcolor);
            color: white;
            box-shadow: 0 4px 15px rgba(89, 99, 255, 0.25);
        }
        
        .btn-primary:hover:not(:disabled) {
            opacity: 0.92;
            box-shadow: 0 7px 18px rgba(89, 99, 255, 0.35);
        }
        
        .btn-secondary {
            background: var(--card-bg);
            color: var(--text2);
            border: 1px solid var(--line);
        }
        
        .btn-secondary:hover {
            background: var(--btactive);
            color: var(--main-color);
        }

        button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .drawing-control label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text2);
        }
        
        .drawing-preview {
            text-align: center;
            position: relative;
        }
        
    #generatedImage {
    max-width: 100%;
    max-height: 500px;
    border-radius: 12px;
    display: block; /* <-- ä¿®æ”¹è¿™é‡Œ */
    border: 1px solid var(--line);
}
        
        .drawing-placeholder {
            color: var(--text3);
            padding: 40px;
            opacity: 0.7;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 15px;
            border: 2px dashed var(--line);
            border-radius: 12px;
            min-height: 300px;
            width: 100%;
        }
        
        .drawing-placeholder svg {
            font-size: 56px;
            color: var(--text3);
            opacity: 0.5;
        }
        
        .alert {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            padding: 16px 35px;
            border-radius: 12px;
            color: white;
            box-shadow: 0 8px 25px var(--shadow);
            z-index: 1001;
            animation: fadeInOut 3s forwards;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .alert.success { background: var(--success-color); }
        .alert.error { background: var(--error-color); }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -20px); }
            10% { opacity: 1; transform: translate(-50%, 0); }
            90% { opacity: 1; transform: translate(-50%, 0); }
            100% { opacity: 0; transform: translate(-50%, -20px); }
        }
        
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 0, 0, 0.2);
            border-radius: 50%;
            border-top-color: var(--main-color);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .image-upload-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            border: 2px dashed var(--line);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            min-height: 150px;
        }
        
        .image-upload-area:hover {
            border-color: var(--main-color);
            background: var(--btactive);
        }
        
        .image-upload-area svg {
            font-size: 40px;
            color: var(--text3);
            margin-bottom: 10px;
        }
        
        .image-upload-area p {
            color: var(--text2);
            font-size: 14px;
            text-align: center;
        }
        
        .image-upload-area input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }
        
        .uploaded-image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            display: block;
            border: 1px solid var(--line);
        }
        
        .upload-status {
            margin-top: 10px;
            font-size: 13px;
            color: var(--text3);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .hidden { display: none !important; }

        .direction-controls-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            padding: 15px;
            border: 1px solid var(--line);
            border-radius: 8px;
        }

        .direction-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 10px;
            width: 150px;
            height: 150px;
        }

        .direction-btn {
            border-radius: 8px;
            background: var(--mainbg);
            color: var(--text2);
            border: 1px solid var(--line);
            font-size: 24px;
            padding: 0;
            width: 100%;
            height: 100%;
        }

        .direction-btn:hover {
            background: var(--btactive);
            color: var(--main-color);
        }

        .direction-btn.active {
            background: var(--main-color);
            color: white;
            border-color: var(--main-color);
        }

        #arrow-up { grid-area: 1 / 2 / 2 / 3; }
        #arrow-left { grid-area: 2 / 1 / 3 / 2; }
        #arrow-right { grid-area: 2 / 3 / 3 / 4; }
        #arrow-down { grid-area: 3 / 2 / 4 / 3; }
        .center-placeholder { 
            grid-area: 2 / 2 / 3 / 3; 
            background: var(--btactive);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--main-color);
        }
        
        .size-info {
            padding: 10px 15px;
            background-color: var(--lightbg);
            border: 1px solid var(--line);
            border-radius: 8px;
            font-size: 14px;
            color: var(--text2);
            text-align: center;
        }
        .size-info span {
            font-weight: 600;
            color: var(--main-color);
        }

        @media (max-width: 768px) {
            .drawing-layout {
                grid-template-columns: 1fr;
            }
            .header {
                display: none;
            }
             .main-layout {
                width: 100%;
                height: 100vh;
                border-radius: 0;
            }
            .main-content {
                padding: 8px;
            }
            .drawing-preview-panel {
                margin-top: 20px;
            }
        }
    </style>
</head>
<body>
<svg width="0" height="0" class="hidden">
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="arrow-down-solid-full"><path d="M297.4 566.6C309.9 579.1 330.2 579.1 342.7 566.6L502.7 406.6C515.2 394.1 515.2 373.8 502.7 361.3C490.2 348.8 469.9 348.8 457.4 361.3L352 466.7L352 96C352 78.3 337.7 64 320 64C302.3 64 288 78.3 288 96L288 466.7L182.6 361.3C170.1 348.8 149.8 348.8 137.3 361.3C124.8 373.8 124.8 394.1 137.3 406.6L297.3 566.6z"></path></symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="arrow-left-solid-full"><path d="M73.4 297.4C60.9 309.9 60.9 330.2 73.4 342.7L233.4 502.7C245.9 515.2 266.2 515.2 278.7 502.7C291.2 490.2 291.2 469.9 278.7 457.4L173.3 352L544 352C561.7 352 576 337.7 576 320C576 302.3 561.7 288 544 288L173.3 288L278.7 182.6C291.2 170.1 291.2 149.8 278.7 137.3C266.2 124.8 245.9 124.8 233.4 137.3L73.4 297.3z"></path></symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="arrow-right-solid-full"><path d="M566.6 342.6C579.1 330.1 579.1 309.8 566.6 297.3L406.6 137.3C394.1 124.8 373.8 124.8 361.3 137.3C348.8 149.8 348.8 170.1 361.3 182.6L466.7 288L96 288C78.3 288 64 302.3 64 320C64 337.7 78.3 352 96 352L466.7 352L361.3 457.4C348.8 469.9 348.8 490.2 361.3 502.7C373.8 515.2 394.1 515.2 406.6 502.7L566.6 342.7z"></path></symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="arrow-up-solid-full"><path d="M342.6 81.4C330.1 68.9 309.8 68.9 297.3 81.4L137.3 241.4C124.8 253.9 124.8 274.2 137.3 286.7C149.8 299.2 170.1 299.2 182.6 286.7L288 181.3L288 552C288 569.7 302.3 584 320 584C337.7 584 352 569.7 352 552L352 181.3L457.4 286.7C469.9 299.2 490.2 299.2 502.7 286.7C515.2 274.2 515.2 253.9 502.7 241.4L342.7 81.4z"></path></symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="cloud-arrow-up-solid-full"><path d="M176 544C96.5 544 32 479.5 32 400C32 336.6 73 282.8 129.9 263.5C128.6 255.8 128 248 128 240C128 160.5 192.5 96 272 96C327.4 96 375.5 127.3 399.6 173.1C413.8 164.8 430.4 160 448 160C501 160 544 203 544 256C544 271.7 540.2 286.6 533.5 299.7C577.5 320 608 364.4 608 416C608 486.7 550.7 544 480 544L176 544zM337 255C327.6 245.6 312.4 245.6 303.1 255L231.1 327C221.7 336.4 221.7 351.6 231.1 360.9C240.5 370.2 255.7 370.3 265 360.9L296 329.9L296 432C296 445.3 306.7 456 320 456C333.3 456 344 445.3 344 432L344 329.9L375 360.9C384.4 370.3 399.6 370.3 408.9 360.9C418.2 351.5 418.3 336.3 408.9 327L336.9 255z"></path></symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="image-solid-full"><path d="M160 96C124.7 96 96 124.7 96 160L96 480C96 515.3 124.7 544 160 544L480 544C515.3 544 544 515.3 544 480L544 160C544 124.7 515.3 96 480 96L160 96zM224 176C250.5 176 272 197.5 272 224C272 250.5 250.5 272 224 272C197.5 272 176 250.5 176 224C176 197.5 197.5 176 224 176zM368 288C376.4 288 384.1 292.4 388.5 299.5L476.5 443.5C481 450.9 481.2 460.2 477 467.8C472.8 475.4 464.7 480 456 480L184 480C175.1 480 166.8 475 162.7 467.1C158.6 459.2 159.2 449.6 164.3 442.3L220.3 362.3C224.8 355.9 232.1 352.1 240 352.1C247.9 352.1 255.2 355.9 259.7 362.3L286.1 400.1L347.5 299.6C351.9 292.5 359.6 288.1 368 288.1z"></path></symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="eraser-solid-full"><path d="M210.5 480L333.5 480L398.8 414.7L225.3 241.2L98.6 367.9L210.6 479.9zM256 544L210.5 544C193.5 544 177.2 537.3 165.2 525.3L49 409C38.1 398.1 32 383.4 32 368C32 352.6 38.1 337.9 49 327L295 81C305.9 70.1 320.6 64 336 64C351.4 64 366.1 70.1 377 81L559 263C569.9 273.9 576 288.6 576 304C576 319.4 569.9 334.1 559 345L424 480L544 480C561.7 480 576 494.3 576 512C576 529.7 561.7 544 544 544L256 544z"></path></symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="wand-magic-sparkles-solid-full"><path d="M295.4 37L310.2 73.8L347 88.6C350 89.8 352 92.8 352 96C352 99.2 350 102.2 347 103.4L310.2 118.2L295.4 155C294.2 158 291.2 160 288 160C284.8 160 281.8 158 280.6 155L265.8 118.2L229 103.4C226 102.2 224 99.2 224 96C224 92.8 226 89.8 229 88.6L265.8 73.8L280.6 37C281.8 34 284.8 32 288 32C291.2 32 294.2 34 295.4 37zM142.7 105.7L164.2 155.8L214.3 177.3C220.2 179.8 224 185.6 224 192C224 198.4 220.2 204.2 214.3 206.7L164.2 228.2L142.7 278.3C140.2 284.2 134.4 288 128 288C121.6 288 115.8 284.2 113.3 278.3L91.8 228.2L41.7 206.7C35.8 204.2 32 198.4 32 192C32 185.6 35.8 179.8 41.7 177.3L91.8 155.8L113.3 105.7C115.8 99.8 121.6 96 128 96C134.4 96 140.2 99.8 142.7 105.7zM496 368C502.4 368 508.2 371.8 510.7 377.7L532.2 427.8L582.3 449.3C588.2 451.8 592 457.6 592 464C592 470.4 588.2 476.2 582.3 478.7L532.2 500.2L510.7 550.3C508.2 556.2 502.4 560 496 560C489.6 560 483.8 556.2 481.3 550.3L459.8 500.2L409.7 478.7C403.8 476.2 400 470.4 400 464C400 457.6 403.8 451.8 409.7 449.3L459.8 427.8L481.3 377.7C483.8 371.8 489.6 368 496 368zM492 64C503 64 513.6 68.4 521.5 76.2L563.8 118.5C571.6 126.4 576 137 576 148C576 159 571.6 169.6 563.8 177.5L475.6 265.7L374.3 164.4L462.5 76.2C470.4 68.4 481 64 492 64zM76.2 462.5L340.4 198.3L441.7 299.6L177.5 563.8C169.6 571.6 159 576 148 576C137 576 126.4 571.6 118.5 563.8L76.2 521.5C68.4 513.6 64 503 64 492C64 481 68.4 470.4 76.2 462.5z"></path></symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="check-circle-solid-full"><path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM369 209L241 337c-9.4 9.4-24.6 9.4-33.9 0l-64-64c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l47 47L335 175c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9z"/></symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="triangle-exclamation-solid-full"><path d="M320 64C334.7 64 348.2 72.1 355.2 85L571.2 485C577.9 497.4 577.6 512.4 570.4 524.5C563.2 536.6 550.1 544 536 544L104 544C89.9 544 76.8 536.6 69.6 524.5C62.4 512.4 62.1 497.4 68.8 485L284.8 85C291.8 72.1 305.3 64 320 64zM320 416C302.3 416 288 430.3 288 448C288 465.7 302.3 480 320 480C337.7 480 352 465.7 352 448C352 430.3 337.7 416 320 416zM320 224C301.8 224 287.3 239.5 288.6 257.7L296 361.7C296.9 374.2 307.4 384 319.9 384C332.5 384 342.9 374.3 343.8 361.7L351.2 257.7C352.5 239.5 338.1 224 319.8 224z"></path></symbol>
</svg>

<div class="main-layout">
    <div class="header">
        <div class="logo">
            <h1>AI æ™ºèƒ½æ‰©å›¾</h1>
        </div>
    </div>
    
    <div class="main-content">
        <div class="panel">              
            <div class="drawing-layout">
                <div class="drawing-controls-panel">
                    
                    <div>
                        <label class="drawing-control-label">1. ä¸Šä¼ å›¾ç‰‡</label>
                        <p class="panel-description" style="margin-bottom: 10px;">ä¸Šä¼ éœ€è¦æ‰©å±•çš„åŸå§‹å›¾ç‰‡ï¼ˆå°äº10MBï¼‰ã€‚</p>
                        <div class="image-upload-area" id="imageUploadArea">
                            <div id="upload-prompt" style="display: flex; flex-direction: column; align-items: center;">
                                <svg class="icon"><use xlink:href="#cloud-arrow-up-solid-full"></use></svg>
                                <p>ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°è¿™é‡Œ</p>
                            </div>
                            <img id="uploadedImagePreview" class="uploaded-image-preview hidden" alt="ä¸Šä¼ çš„å›¾ç‰‡é¢„è§ˆ">
                            <input type="file" id="imageUploadInput" accept="image/*">
                        </div>
                        <div class="upload-status" id="uploadStatus"></div>
                    </div>

                    <div>
                        <label class="drawing-control-label">2. é€‰æ‹©æ‰©å±•æ–¹å‘</label>
                         <p class="panel-description" style="margin-bottom: 10px;">ç‚¹å‡»ç®­å¤´é€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ªæ‰©å±•æ–¹å‘ã€‚</p>
                        <div class="direction-controls-container">
                            <div class="direction-grid">
                                <button class="direction-btn" id="arrow-up" data-direction="upwards">
                                    <svg class="icon"><use xlink:href="#arrow-up-solid-full"></use></svg>
                                </button>
                                <button class="direction-btn" id="arrow-left" data-direction="to the left">
                                    <svg class="icon"><use xlink:href="#arrow-left-solid-full"></use></svg>
                                </button>
                                <div class="center-placeholder">
                                    <svg class="icon"><use xlink:href="#image-solid-full"></use></svg>
                                </div>
                                <button class="direction-btn" id="arrow-right" data-direction="to the right">
                                    <svg class="icon"><use xlink:href="#arrow-right-solid-full"></use></svg>
                                </button>
                                <button class="direction-btn" id="arrow-down" data-direction="downwards">
                                    <svg class="icon"><use xlink:href="#arrow-down-solid-full"></use></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="sizeInfo" class="size-info hidden">
                        åŸå§‹å°ºå¯¸: <span id="originalSize"></span><br>
                        é¢„è®¡è¾“å‡º: <span id="outputSize"></span>
                    </div>

                    <div class="btn-group">
                        <button class="btn-secondary" id="clearBtn">
                            <svg class="icon"><use xlink:href="#eraser-solid-full"></use></svg>æ¸…é™¤
                        </button>
                        <button class="btn-primary" id="generateBtn">
                           <svg class="icon"><use xlink:href="#wand-magic-sparkles-solid-full"></use></svg> ç”Ÿæˆå›¾åƒ
                        </button>
                    </div>
                </div>
                
                <div class="drawing-preview-panel">
                    <div class="drawing-preview">
                        <p class="panel-description">AIå°†æ ¹æ®æ‚¨é€‰æ‹©çš„æ–¹å‘æ™ºèƒ½å¯¹åŸå›¾è¿›è¡Œæ‰©å±•å’Œå¡«å……ã€‚</p>
                        <div id="drawingPlaceholder" class="drawing-placeholder">
                            <svg class="icon"><use xlink:href="#image-solid-full"></use></svg>
                            <p>æ­¤å¤„å°†æ˜¾ç¤ºç”Ÿæˆçš„å›¾åƒ</p>
                        </div>
                        <img id="generatedImage" alt="ç”Ÿæˆçš„å›¾åƒ" class="hidden">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
    
<div id="alertContainer"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // DOM å…ƒç´ 
    const imageUploadArea = document.getElementById('imageUploadArea');
    const imageUploadInput = document.getElementById('imageUploadInput');
    const uploadedImagePreview = document.getElementById('uploadedImagePreview');
    const uploadPrompt = document.getElementById('upload-prompt');
    const uploadStatus = document.getElementById('uploadStatus');
    const directionBtns = document.querySelectorAll('.direction-btn');
    const clearBtn = document.getElementById('clearBtn');
    const generateBtn = document.getElementById('generateBtn');
    const drawingPlaceholder = document.getElementById('drawingPlaceholder');
    const generatedImage = document.getElementById('generatedImage');
    const sizeInfo = document.getElementById('sizeInfo');
    const originalSizeSpan = document.getElementById('originalSize');
    const outputSizeSpan = document.getElementById('outputSize');

    // çŠ¶æ€å˜é‡
    let uploadedImageUrl = null;
    let originalWidth = 0;
    let originalHeight = 0;
    const IMGBB_API_KEY = '1ca72c5c363a3096e17108ea665be289'; // å…¬å…±API Key

    // --- äº‹ä»¶ç›‘å¬ ---

    clearBtn.addEventListener('click', clearAll);
    generateBtn.addEventListener('click', generateExpandedImage);

    directionBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            btn.classList.toggle('active');
            updateOutputSizeDisplay();
        });
    });

    imageUploadInput.addEventListener('change', handleImageUpload);
    imageUploadArea.addEventListener('dragover', (e) => { e.preventDefault(); imageUploadArea.style.borderColor = "var(--main-color)"; });
    imageUploadArea.addEventListener('dragleave', (e) => { e.preventDefault(); imageUploadArea.style.borderColor = "var(--line)"; });
    imageUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        imageUploadArea.style.borderColor = "var(--line)";
        if (e.dataTransfer.files.length > 0) {
            imageUploadInput.files = e.dataTransfer.files;
            handleImageUpload();
        }
    });

    // --- æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ---

    async function handleImageUpload() {
        const file = imageUploadInput.files[0];
        if (!file) return;

        if (!file.type.startsWith('image/')) {
            showAlert('è¯·ä¸Šä¼ æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶', 'error');
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            uploadedImagePreview.src = e.target.result;
            // å…³é”®ï¼šåœ¨å›¾ç‰‡é¢„è§ˆåŠ è½½å®Œæˆåè·å–å…¶åŸå§‹å°ºå¯¸
            uploadedImagePreview.onload = () => {
                originalWidth = uploadedImagePreview.naturalWidth;
                originalHeight = uploadedImagePreview.naturalHeight;
                updateOutputSizeDisplay();
                sizeInfo.classList.remove('hidden');
            };
            uploadedImagePreview.classList.remove('hidden');
            uploadPrompt.classList.add('hidden');
        };
        reader.readAsDataURL(file);

        setUploadStatus('ä¸Šä¼ ä¸­...', true);
        try {
            const formData = new FormData();
            formData.append('image', file);
            const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData });
            const data = await response.json();
            if (data.success) {
                uploadedImageUrl = data.data.url;
                setUploadStatus('ä¸Šä¼ æˆåŠŸ!', false);
                showAlert('å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼Œè¯·é€‰æ‹©æ‰©å±•æ–¹å‘', 'success');
            } else {
                throw new Error(data.error?.message || 'ä¸Šä¼ å¤±è´¥');
            }
        } catch (error) {
            console.error('ImgBBä¸Šä¼ é”™è¯¯:', error);
            setUploadStatus(`ä¸Šä¼ å¤±è´¥: ${error.message}`, false);
            showAlert(`å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•`, 'error');
            uploadedImageUrl = null;
        }
    }

    function generateExpandedImage() {
        if (!uploadedImageUrl) {
            showAlert('è¯·å…ˆä¸Šä¼ ä¸€å¼ å›¾ç‰‡', 'error');
            return;
        }

        const activeDirections = Array.from(directionBtns).filter(btn => btn.classList.contains('active'));
        if (activeDirections.length === 0) {
            showAlert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ‰©å±•æ–¹å‘', 'error');
            return;
        }

        // åŠ¨æ€è®¡ç®—æœ€ç»ˆå°ºå¯¸
        const { finalWidth, finalHeight } = calculateFinalDimensions();

        const MAX_DIMENSION = 2048; // è®¾ç½®APIå¯èƒ½æ”¯æŒçš„æœ€å¤§å°ºå¯¸
        if (finalWidth > MAX_DIMENSION || finalHeight > MAX_DIMENSION) {
            showAlert(`ç›®æ ‡å°ºå¯¸(${finalWidth}x${finalHeight})è¿‡å¤§ï¼Œè¯·å‡å°‘æ‰©å±•æ–¹å‘ã€‚`, 'error');
            return;
        }

        const prompt = `Expand the image ${activeDirections.map(btn => btn.dataset.direction).join(' and ')}`;
        const strength = 0.6;
        const seed = Math.floor(Math.random() * 1000000);

        const params = new URLSearchParams({
            width: finalWidth,
            height: finalHeight,
            image: uploadedImageUrl,
            strength,
            seed,
            model: 'kontext', // æ‰©å›¾ä»»åŠ¡å¿…é¡»ä½¿ç”¨kontextæ¨¡å‹
            nologo: 'true',
            safe: 'false',
            token: 'lOpIOM_Rk9Ne3k5Z'
        });
        const apiUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?${params.toString()}`;

        fetchAndDisplayImage(apiUrl);
    }

    async function fetchAndDisplayImage(apiUrl) {
        setButtonLoading(generateBtn, true, 'ç”Ÿæˆä¸­...');
        drawingPlaceholder.innerHTML = `<div class="loader"></div><p>æ­£åœ¨è¯·æ±‚AIï¼Œè¯·ç¨å€™...</p>`;
        generatedImage.classList.add('hidden');
        
        try {
            const response = await fetch(apiUrl);
            if (!response.ok) {
                throw new Error(`HTTP é”™è¯¯: ${response.status} ${response.statusText}`);
            }
            const blob = await response.blob();
            if (blob.size < 1000) { // å°äº1KBçš„å›¾ç‰‡åŸºæœ¬å¯è§†ä¸ºæ— æ•ˆ
                throw new Error('APIè¿”å›äº†æ— æ•ˆæˆ–ç©ºçš„å›¾åƒæ•°æ®');
            }

            uploadToImgBB(blob, "expanded-image").catch(err => console.error("ç”Ÿæˆç»“æœä¸Šä¼ å¤±è´¥:", err));

            const imageUrl = URL.createObjectURL(blob);
            generatedImage.onload = () => {
                drawingPlaceholder.classList.add('hidden');
                generatedImage.classList.remove('hidden');
                showAlert('å›¾åƒç”ŸæˆæˆåŠŸï¼', 'success');
                URL.revokeObjectURL(imageUrl);
            };
            generatedImage.src = imageUrl;

        } catch (error) {
            console.error('å›¾åƒç”Ÿæˆå¤±è´¥:', error);
            showAlert(`ç”Ÿæˆå¤±è´¥: ${error.message}`, 'error');
            drawingPlaceholder.innerHTML = `<svg class="icon" style="color: var(--error-color);"><use xlink:href="#triangle-exclamation-solid-full"></use></svg><p>å›¾åƒç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•</p>`;
        } finally {
            setButtonLoading(generateBtn, false, '<svg class="icon"><use xlink:href="#wand-magic-sparkles-solid-full"></use></svg> ç”Ÿæˆå›¾åƒ');
        }
    }

    // --- è¾…åŠ©åŠUIå‡½æ•° ---

    function calculateFinalDimensions() {
        if (originalWidth === 0 || originalHeight === 0) {
            return { finalWidth: 0, finalHeight: 0 };
        }
        let finalWidth = originalWidth;
        let finalHeight = originalHeight;
        const extensionX = Math.round(originalWidth / 2);
        const extensionY = Math.round(originalHeight / 2);

        const activeDirections = new Set(
            Array.from(directionBtns)
                 .filter(btn => btn.classList.contains('active'))
                 .map(btn => btn.dataset.direction)
        );

        if (activeDirections.has('to the left')) finalWidth += extensionX;
        if (activeDirections.has('to the right')) finalWidth += extensionX;
        if (activeDirections.has('upwards')) finalHeight += extensionY;
        if (activeDirections.has('downwards')) finalHeight += extensionY;

        // å°†æœ€ç»ˆå°ºå¯¸å¤„ç†ä¸º64çš„å€æ•°ï¼Œæé«˜AIç”ŸæˆæˆåŠŸç‡
        const roundTo64 = num => Math.round(num / 64) * 64;
        
        return { finalWidth: roundTo64(finalWidth), finalHeight: roundTo64(finalHeight) };
    }

    function updateOutputSizeDisplay() {
        if (originalWidth > 0 && originalHeight > 0) {
            originalSizeSpan.textContent = `${originalWidth} Ã— ${originalHeight}`;
            const { finalWidth, finalHeight } = calculateFinalDimensions();
            outputSizeSpan.textContent = `${finalWidth} Ã— ${finalHeight}`;
        }
    }

    function clearAll() {
        imageUploadInput.value = '';
        uploadedImagePreview.src = '';
        uploadedImagePreview.classList.add('hidden');
        uploadedImagePreview.onload = null;
        uploadPrompt.classList.remove('hidden');
        uploadStatus.innerHTML = '';
        uploadedImageUrl = null;
        originalWidth = 0;
        originalHeight = 0;
        
        directionBtns.forEach(btn => btn.classList.remove('active'));
        
        sizeInfo.classList.add('hidden');
        originalSizeSpan.textContent = '';
        outputSizeSpan.textContent = '';

        generatedImage.src = '';
        generatedImage.classList.add('hidden');
        drawingPlaceholder.classList.remove('hidden');
        drawingPlaceholder.innerHTML = `<svg class="icon"><use xlink:href="#image-solid-full"></use></svg><p>æ­¤å¤„å°†æ˜¾ç¤ºç”Ÿæˆçš„å›¾åƒ</p>`;

        showAlert('å·²æ¸…é™¤æ‰€æœ‰å†…å®¹', 'success');
    }

    async function uploadToImgBB(blob, name) {
        const formData = new FormData();
        const fileName = name.replace(/[^a-zA-Z0-9]/g, '_') || 'ai-image';
        const file = new File([blob], `${fileName}.png`, { type: 'image/png' });
        formData.append('image', file);
        const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData });
        const data = await response.json();
        if (data.success) {
            console.log('åå°ä¸Šä¼ æˆåŠŸ:', data.data.url);
        } else {
            throw new Error(data.error?.message || 'åå°ä¸Šä¼ å¤±è´¥');
        }
    }
    
    function setUploadStatus(message, isLoading = false) {
        let loadingIndicator = isLoading ? '<div class="loader" style="width:16px; height:16px; border-width:2px; margin-right:5px;"></div>' : '';
        uploadStatus.innerHTML = `${loadingIndicator} ${message}`;
        if(message.includes('å¤±è´¥')) uploadStatus.style.color = 'var(--error-color)';
        else if(message.includes('æˆåŠŸ')) uploadStatus.style.color = 'var(--success-color)';
        else uploadStatus.style.color = 'var(--text2)';
    }

    function setButtonLoading(button, isLoading, loadingText) {
        button.disabled = isLoading;
        const originalHTML = '<svg class="icon"><use xlink:href="#wand-magic-sparkles-solid-full"></use></svg> ç”Ÿæˆå›¾åƒ';
        if (isLoading) {
            button.innerHTML = loadingText;
        } else {
            button.innerHTML = originalHTML;
        }
    }

    function showAlert(message, type = 'success') {
        const alertContainer = document.getElementById('alertContainer');
        const alert = document.createElement('div');
        alert.className = `alert ${type}`;
        const iconId = type === 'success' ? 'check-circle-solid-full' : 'triangle-exclamation-solid-full';
        alert.innerHTML = `<svg class="icon"><use xlink:href="#${iconId}"></use></svg> ${message}`;
        alertContainer.appendChild(alert);
        setTimeout(() => alert.remove(), 3000);
    }
});
</script>
</body>
</html>