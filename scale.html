<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI高清放大 - 免费AI图像放大工具</title>
    <script defer src="https://cloud.umami.is/script.js" data-website-id="5a2e10cd-bf73-47df-be48-079c9ba7783c" data-domains="designtool.site"></script>
    <script src="menu.js" defer></script>
    <link rel="icon" href="img/gongjuxiang.svg" type="image/svg">
    <style>
        :root {
            --main-color: #5a64ff;
            --main-gradient: linear-gradient(113deg, #4c73ff, #6a52ff);
            --secondary-color: #818cf8;
            --text1: #1a1d2e;
            --text2: #4a4e6d;
            --text3: #8d8fa3;
            --bg-light: #f9fafb;
            --bg-lighter: #ffffff;
            --border: #eaeef3;
            --success: #10b981;
            --error: #ef4444;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius: 12px;
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #fff;
            color: var(--text2);
            display: flex;
            min-height: 100vh;
            margin: 0;
        }
.icon {
    display: inline-block;
    width: 1.2em;
    height: 1.2em;
    fill: currentColor;
}
        .container {
            display: flex;
            width: 100%;
            margin: 0 auto;
            padding-left: 60px;
            padding-right: 20px;
        }

        .left-panel {
            width: 380px;
            min-width: 380px;
            background: #fff;
            padding: 20px;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            height: fit-content;
            position: sticky;
            top: 20px;
                height: -webkit-fill-available;
        }

        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 20px;
            min-height: 100vh;
        }

        header {
            text-align: center;
            padding: 30px 10px;
            background: #fff;
        }

        header h1 {
            background: var(--main-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 12px;
            letter-spacing: -0.5px;
        }

        header p {
            color: var(--text2);
            font-size: 0.9rem;
            margin: 0 auto;
            max-width: 600px;
        }

        .upload-section {
            position: relative;
            margin-bottom: 20px;
            background-color: var(--bg-light);
            border: 2px dashed var(--main-color);
            padding: 30px;
            border-radius: var(--radius);
            transition: var(--transition);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .upload-section:hover {
            background-color: #5a64ff26;
            transform: translateY(-2px);
        }

        .upload-section.drag-over {
            background-color: #5a64ff26;
            transform: translateY(-2px);
        }

        .upload-icon-text {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 1rem;
            font-weight: 600;
            color: #bcbff1;
            border-radius: 8px;
            transition: var(--transition);
            cursor: pointer;
            flex-direction: column;
        }

        .upload-icon-text:hover {
            transform: translateY(-2px);
	color: var(--main-color);
        }

        .upload-icon-text svg {
            font-size: 2.5rem;
        }

        .drag-hint {
            margin-top: 10px;
            color: var(--text3);
            font-size: 0.9rem;
        }

        .options-group {
            margin-bottom: 20px;
        }

        .options-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text1);
            font-weight: 600;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .options-group select, .options-group input {
            width: 100%;
            padding: 10px 16px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background-color: white;
            color: var(--text2);
            font-size: 1rem;
            transition: var(--transition);
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 16px;
        }

        .options-group select:focus, .options-group input:focus {
            outline: none;
            border-color: var(--main-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--main-color);
        }

        .image-preview {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .image-wrapper {
            display: flex;
            flex-direction: column;
        }

        .image-container {
            width: 100%;
            height: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            position: relative;
            transition: var(--transition);
            overflow: hidden;
            background: linear-gradient(0deg, #f9fafb, #e3f2fd);
            border-radius: var(--radius);
        }
        .image-container h2 {
            color: var(--text2);
            margin-bottom: 20px;
            font-size: 1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            padding: 10px 20px;
            margin: 0;
        }

        .image-container img {
            max-width: 100%;
            max-height: 540px;
            border-radius: 16px;
            display: block;
            transition: var(--transition);
            padding: 10px;
        }

        .image-container img:hover {
            transform: scale(1.03);
        }

        #original-container, #upscaled-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
            margin: 0 10px 10px;
            border-radius: 6px;
            width: -webkit-fill-available;
        }

        .image-size {
            text-align: center;
            color: var(--text2);
            font-size: 0.9rem;
            width: fit-content;
            background: #fff;
            padding: 10px 20px;
            border-radius: 20px;
            margin: 10px auto;
            box-shadow: 0px 1px 4px 0px #0000001a;
        }

        .upload-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .action-button {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border: none;
        }

        .retry-button {
            background: var(--border);
            color: var(--text2);
        }

        .retry-button:hover {
            transform: translateY(-1px);
                background: #d3d8e4;
        }

        .clear-button {
            background: var(--error);
            color: #fff;
        }

        .clear-button:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        /* 下载按钮样式 - 确保图标与文字垂直居中 */
        #download-button {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 20px;
            font-size: 1rem;
            justify-content: center;
        }

        #download-button .icon {
            vertical-align: middle;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: var(--border);
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
            position: relative;
        }

        .progress {
            height: 100%;
            background: var(--main-gradient);
            width: 0%;
            transition: width 0.3s ease;
            position: relative;
            border-radius: 4px;
        }

        .progress::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .status-message {
            padding: 14px 16px;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .status-error {
            background-color: #fef2f2;
            color: var(--error);
            border: 1px solid #fecaca;
        }

        .status-success {
            background-color: #f0fdf4;
            color: var(--success);
            border: 1px solid #10b981a6;
            padding: 8px;
        }

        .model-loading {
            display: inline-flex;
            align-items: center;
            margin-top: 10px;
            font-size: 0.95rem;
            color: var(--text3);
            gap: 4px;
        }

        .model-loading .dot {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: var(--main-color);
            animation: pulse 1.5s infinite ease-in-out;
        }

        .model-loading .dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .model-loading .dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.2; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        .placeholder-text {
            color: var(--text3);
            text-align: center;
            padding: 20px;
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .content-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            margin: 0 auto;
            padding: 40px;
            position: relative;
            padding-bottom: 80px;
        }

        .download-section1 {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }

        .download-section1 button {
            background: var(--main-gradient);
            color: white;
            border: none;
            padding: 12px 32px;
            border-radius: 30px;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            min-width: 200px;
        }

        .download-section1 button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .download-section1 button:disabled {
            background: var(--border);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            color: var(--text3);
        }

        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
            cursor: zoom-in;
            transition: all 0.2s ease-in-out;
        }
        .modal-content.zoomed {
            max-width: none;
            max-height: none;
            cursor: zoom-out;
        }
    .modal.zoomed-container {
    align-items: flex-start;
}
        .close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
            z-index: 1001;
        }
        
        .close:hover, .close:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }
        
        /* 点击放大的图片样式 */
        .clickable-image {
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .clickable-image:hover {
            transform: scale(1.03);
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                padding: 0;
            }
            .download-section1 {
                position: fixed;
            }
            .content-container {
                padding: 20px;
            }
            .left-panel {
                width: 100%;
                min-width: 0; 
                position: static;
                height: auto;
                top: 0;
                box-shadow: none;
            }
            
            .image-preview {
                grid-template-columns: 1fr;
                gap: 0;
            }
            .image-size {
                margin-bottom: 60px;
            }
            .image-container {
                height: 400px; /* 适配移动端的高度 */
            }
        }
    </style>
</head>
<body>
<svg width="0" height="0" class="hidden">
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="circle-check-solid-full">
    <path d="M320 576C178.6 576 64 461.4 64 320C64 178.6 178.6 64 320 64C461.4 64 576 178.6 576 320C576 461.4 461.4 576 320 576zM438 209.7C427.3 201.9 412.3 204.3 404.5 215L285.1 379.2L233 327.1C223.6 317.7 208.4 317.7 199.1 327.1C189.8 336.5 189.7 351.7 199.1 361L271.1 433C276.1 438 282.9 440.5 289.9 440C296.9 439.5 303.3 435.9 307.4 430.2L443.3 243.2C451.1 232.5 448.7 217.5 438 209.7z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="cloud-arrow-up-solid-full">
    <path d="M176 544C96.5 544 32 479.5 32 400C32 336.6 73 282.8 129.9 263.5C128.6 255.8 128 248 128 240C128 160.5 192.5 96 272 96C327.4 96 375.5 127.3 399.6 173.1C413.8 164.8 430.4 160 448 160C501 160 544 203 544 256C544 271.7 540.2 286.6 533.5 299.7C577.5 320 608 364.4 608 416C608 486.7 550.7 544 480 544L176 544zM337 255C327.6 245.6 312.4 245.6 303.1 255L231.1 327C221.7 336.4 221.7 351.6 231.1 360.9C240.5 370.2 255.7 370.3 265 360.9L296 329.9L296 432C296 445.3 306.7 456 320 456C333.3 456 344 445.3 344 432L344 329.9L375 360.9C384.4 370.3 399.6 370.3 408.9 360.9C418.2 351.5 418.3 336.3 408.9 327L336.9 255z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="download-solid-full">
    <path d="M352 96C352 78.3 337.7 64 320 64C302.3 64 288 78.3 288 96L288 306.7L246.6 265.3C234.1 252.8 213.8 252.8 201.3 265.3C188.8 277.8 188.8 298.1 201.3 310.6L297.3 406.6C309.8 419.1 330.1 419.1 342.6 406.6L438.6 310.6C451.1 298.1 451.1 277.8 438.6 265.3C426.1 252.8 405.8 252.8 393.3 265.3L352 306.7L352 96zM160 384C124.7 384 96 412.7 96 448L96 480C96 515.3 124.7 544 160 544L480 544C515.3 544 544 515.3 544 480L544 448C544 412.7 515.3 384 480 384L433.1 384L376.5 440.6C345.3 471.8 294.6 471.8 263.4 440.6L206.9 384L160 384zM464 440C477.3 440 488 450.7 488 464C488 477.3 477.3 488 464 488C450.7 488 440 477.3 440 464C440 450.7 450.7 440 464 440z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="image-solid-full">
    <path d="M160 96C124.7 96 96 124.7 96 160L96 480C96 515.3 124.7 544 160 544L480 544C515.3 544 544 515.3 544 480L544 160C544 124.7 515.3 96 480 96L160 96zM224 176C250.5 176 272 197.5 272 224C272 250.5 250.5 272 224 272C197.5 272 176 250.5 176 224C176 197.5 197.5 176 224 176zM368 288C376.4 288 384.1 292.4 388.5 299.5L476.5 443.5C481 450.9 481.2 460.2 477 467.8C472.8 475.4 464.7 480 456 480L184 480C175.1 480 166.8 475 162.7 467.1C158.6 459.2 159.2 449.6 164.3 442.3L220.3 362.3C224.8 355.9 232.1 352.1 240 352.1C247.9 352.1 255.2 355.9 259.7 362.3L286.1 400.1L347.5 299.6C351.9 292.5 359.6 288.1 368 288.1z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="maximize-solid-full">
    <path d="M264 96L120 96C106.7 96 96 106.7 96 120L96 264C96 273.7 101.8 282.5 110.8 286.2C119.8 289.9 130.1 287.8 137 281L177 241L256 320L177 399L137 359C130.1 352.1 119.8 350.1 110.8 353.8C101.8 357.5 96 366.3 96 376L96 520C96 533.3 106.7 544 120 544L264 544C273.7 544 282.5 538.2 286.2 529.2C289.9 520.2 287.9 509.9 281 503L241 463L320 384L399 463L359 503C352.1 509.9 350.1 520.2 353.8 529.2C357.5 538.2 366.3 544 376 544L520 544C533.3 544 544 533.3 544 520L544 376C544 366.3 538.2 357.5 529.2 353.8C520.2 350.1 509.9 352.1 503 359L463 399L384 320L463 241L503 281C509.9 287.9 520.2 289.9 529.2 286.2C538.2 282.5 544 273.7 544 264L544 120C544 106.7 533.3 96 520 96L376 96C366.3 96 357.5 101.8 353.8 110.8C350.1 119.8 352.2 130.1 359 137L399 177L320 256L241 177L281 137C287.9 130.1 289.9 119.8 286.2 110.8C282.5 101.8 273.7 96 264 96z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="rotate-right-solid-full">
    <path d="M552 256L408 256C398.3 256 389.5 250.2 385.8 241.2C382.1 232.2 384.1 221.9 391 215L437.7 168.3C362.4 109.7 253.4 115 184.2 184.2C109.2 259.2 109.2 380.7 184.2 455.7C259.2 530.7 380.7 530.7 455.7 455.7C463.9 447.5 471.2 438.8 477.6 429.6C487.7 415.1 507.7 411.6 522.2 421.7C536.7 431.8 540.2 451.8 530.1 466.3C521.6 478.5 511.9 490.1 501 501C401 601 238.9 601 139 501C39.1 401 39 239 139 139C233.3 44.7 382.7 39.4 483.3 122.8L535 71C541.9 64.1 552.2 62.1 561.2 65.8C570.2 69.5 576 78.3 576 88L576 232C576 245.3 565.3 256 552 256z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="trash-solid-full">
    <path d="M232.7 69.9L224 96L128 96C110.3 96 96 110.3 96 128C96 145.7 110.3 160 128 160L512 160C529.7 160 544 145.7 544 128C544 110.3 529.7 96 512 96L416 96L407.3 69.9C402.9 56.8 390.7 48 376.9 48L263.1 48C249.3 48 237.1 56.8 232.7 69.9zM512 208L128 208L149.1 531.1C150.7 556.4 171.7 576 197 576L443 576C468.3 576 489.3 556.4 490.9 531.1L512 208z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="triangle-exclamation-solid-full">
    <path d="M320 64C334.7 64 348.2 72.1 355.2 85L571.2 485C577.9 497.4 577.6 512.4 570.4 524.5C563.2 536.6 550.1 544 536 544L104 544C89.9 544 76.8 536.6 69.6 524.5C62.4 512.4 62.1 497.4 68.8 485L284.8 85C291.8 72.1 305.3 64 320 64zM320 416C302.3 416 288 430.3 288 448C288 465.7 302.3 480 320 480C337.7 480 352 465.7 352 448C352 430.3 337.7 416 320 416zM320 224C301.8 224 287.3 239.5 288.6 257.7L296 361.7C296.9 374.2 307.4 384 319.9 384C332.5 384 342.9 374.3 343.8 361.7L351.2 257.7C352.5 239.5 338.1 224 319.8 224z"></path>
  </symbol>
</svg>
    <div class="container">
        <div class="left-panel">
            <header>
                <h1>AI高清放大</h1>
                <p>使用开源 AI 模型，在您的浏览器中直接放大图像，保留更多细节</p>
            </header>
                <div class="upload-section" id="upload-section">
                    <input type="file" id="image-input" accept="image/*" hidden>
                <div class="upload-icon-text">
                    <svg class="icon"><use xlink:href="#cloud-arrow-up-solid-full"></use></svg>
                </div>
                    <div style="margin-top: 10px; font-weight:600;">拖放图片到此处或点击上传</div>
                <p class="drag-hint">支持jpg、png、jpeg、webp格式</p>
            </div>
            
            <div class="options-group">
                <label for="zoom-factor"> 选择放大倍数</label>
                <select id="zoom-factor">
                    <option value="2">2倍（推荐）</option>
                    <option value="3">3倍</option>
                    <option value="4">4倍</option>
                </select>
            </div>
            
            <div class="options-group">
                <label for="denoise-level"> 去噪强度</label>
                <select id="denoise-level">
                    <option value="0">无去噪</option>
                    <option value="1" selected>轻度去噪</option>
                    <option value="2">中度去噪</option>
                    <option value="3">强去噪</option>
                </select>
            </div>

            <div id="model-status" class="model-loading">
                <span>模型加载中</span>
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
            </div>
                                        <div class="download-section1">
                    <a id="download-link" href="#">
                        <button id="download-button" disabled><svg class="icon"><use xlink:href="#download-solid-full"></use></svg> 下载放大图像</button>
                    </a>
                </div>
        </div>
        
        <div class="right-panel">
         
            <div class="content-container">
                             <div id="status-message" class="status-message" style="display: none;"></div>  
                <div class="upload-status">
                    <div class="file-info">
                        <span id="file-name">尚未选择文件</span>
                    </div>
                    <div class="action-buttons">
                        <button id="retry-button" class="action-button retry-button" style="display: none;">
                            <svg class="icon"><use xlink:href="#rotate-right-solid-full"></use></svg>重试
                        </button>
                        <button id="clear-button" class="action-button clear-button" style="display: none;">
                            <svg class="icon"><use xlink:href="#trash-solid-full"></use></svg>清除
                        </button>
                    </div>
                </div>
                
                <div class="progress-bar">
                    <div class="progress" id="progress-bar"></div>
                </div>
                
                
                <div class="image-preview">
                    <div class="image-wrapper">
                        <div class="image-container">
                            <h2><svg class="icon"><use xlink:href="#image-solid-full"></use></svg>原始图像</h2>
                            <div id="original-container">
                                <img id="original-image" src="" alt="原始图像预览" style="display: none;">
                                <div id="original-placeholder" class="placeholder-text">原始图像将显示在这里</div>
                            </div>
                        </div>
                        <div id="original-size" class="image-size" style="display: none;"></div>
                </div>
                
                <div class="image-wrapper">
                    <div class="image-container" style="background: linear-gradient(0deg, #f9fafb, #e9e9fa);">
                        <h2><svg class="icon"><use xlink:href="#maximize-solid-full"></use></svg> 放大后的图像</h2>
                        <div id="upscaled-container">
                            <img id="upscaled-image" src="" alt="放大后的图像预览" style="display: none;">
                            <div id="upscaled-placeholder" class="placeholder-text">放大后的图像将显示在这里</div>
                            <div id="loader" class="loader" style="display: none;"></div>
                        </div>
                    </div>
                    <div id="upscaled-size" class="image-size" style="display: none;"></div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="image-modal" class="modal">
        <span class="close">&times;</span>
        <img class="modal-content" id="modal-image">
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/upscaler@0.12.0/dist/browser/umd/upscaler.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const imageInput = document.getElementById('image-input');
            const uploadSection = document.getElementById('upload-section');
            const fileNameElement = document.getElementById('file-name');
            const originalImage = document.getElementById('original-image');
            const upscaledImage = document.getElementById('upscaled-image');
            const downloadButton = document.getElementById('download-button');
            const downloadLink = document.getElementById('download-link');
            const loader = document.getElementById('loader');
            const progressBar = document.getElementById('progress-bar');
            const originalPlaceholder = document.getElementById('original-placeholder');
            const upscaledPlaceholder = document.getElementById('upscaled-placeholder');
            const statusMessage = document.getElementById('status-message');
            const modelStatus = document.getElementById('model-status');
            const zoomFactorSelect = document.getElementById('zoom-factor');
            const denoiseLevelSelect = document.getElementById('denoise-level');
            const imageModal = document.getElementById('image-modal');
            const modalImage = document.getElementById('modal-image');
            const closeModal = document.getElementsByClassName('close')[0];
            const retryButton = document.getElementById('retry-button');
            const clearButton = document.getElementById('clear-button');
            const originalSizeDiv = document.getElementById('original-size');
            const upscaledSizeDiv = document.getElementById('upscaled-size');

            let upscaler;
            let isModelLoaded = false;
            let isImageUploaded = false;
            let currentFile = null;

            // 显示状态消息
            function showStatus(message, isError = false) {
                statusMessage.textContent = message;
                statusMessage.className = isError ? 'status-message status-error' : 'status-message status-success';
                statusMessage.style.display = 'block';
                
                if (!isError) {
                    setTimeout(() => {
                        statusMessage.style.display = 'none';
                    }, 5000);
                }
            }

            // 更新模型加载状态
            function updateModelStatus(loaded) {
                isModelLoaded = loaded;
                if (loaded) {
                    modelStatus.innerHTML = '<svg class="icon" style="color:var(--success)" ><use xlink:href="#circle-check-solid-full"></use></svg>模型已加载';
                    showStatus("AI模型加载成功！");
                } else {
                    modelStatus.innerHTML = '<svg class="icon" style="color:var(--error)" ><use xlink:href="#triangle-exclamation-solid-full"></use></svg>模型加载失败';
                }
            }

            // 初始化 Upscaler
            async function initUpscaler() {
                try {
                    upscaler = new Upscaler();
                    await tf.ready();
                    updateModelStatus(true);
                    console.log("Upscaler initialized successfully");
                } catch (error) {
                    console.error('Upscaler initialization failed:', error);
                    updateModelStatus(false);
                    showStatus("AI模型加载失败，请刷新页面重试或检查网络连接", true);
                }
            }

            // 初始化 Upscaler
            initUpscaler();

            // 点击上传
            uploadSection.addEventListener('click', () => {
                imageInput.click();
            });

            // 拖拽上传功能
            uploadSection.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadSection.classList.add('drag-over');
            });

            uploadSection.addEventListener('dragleave', () => {
                uploadSection.classList.remove('drag-over');
            });

            uploadSection.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadSection.classList.remove('drag-over');
                
                const file = e.dataTransfer.files[0];
                if (file) {
                    handleFile(file);
                }
            });

            imageInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (file) {
                    handleFile(file);
                }
            });

            // 重试按钮事件
            retryButton.addEventListener('click', () => {
                if (currentFile) {
                    handleFile(currentFile);
                } else {
                    imageInput.click();
                }
            });

            // 清除按钮事件
            clearButton.addEventListener('click', () => {
                resetUI();
            });

            // 重置UI状态
            function resetUI() {
                imageInput.value = '';
                fileNameElement.textContent = '尚未选择文件';
                originalImage.src = '';
                originalImage.style.display = 'none';
                upscaledImage.src = '';
                upscaledImage.style.display = 'none';
                downloadButton.disabled = true;
                downloadLink.href = '#';
                downloadLink.removeAttribute('download');
                progressBar.style.width = '0%';
                statusMessage.style.display = 'none';
                retryButton.style.display = 'none';
                clearButton.style.display = 'none';
                originalPlaceholder.style.display = 'block';
                upscaledPlaceholder.style.display = 'block';
                originalSizeDiv.textContent = '';
                originalSizeDiv.style.display = 'none';
                upscaledSizeDiv.textContent = '';
                upscaledSizeDiv.style.display = 'none';
                isImageUploaded = false;
                currentFile = null;
            }

            // 图像去噪函数
            function applyDenoise(imageData, level) {
                if (level === 0) return imageData;
                
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                return new Promise((resolve) => {
                    img.onload = function() {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                        
                        const imageDataObj = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const data = imageDataObj.data;
                        
                        // 简单的去噪算法 - 根据级别调整模糊程度
                        const radius = level;
                        
                        for (let i = 0; i < data.length; i += 4) {
                            if (radius > 0) {
                                // 简单模糊效果
                                if (i > 4 && i < data.length - 4) {
                                    data[i] = (data[i] + data[i - 4] + data[i + 4]) / 3;     // R
                                    data[i + 1] = (data[i + 1] + data[i - 3] + data[i + 5]) / 3; // G
                                    data[i + 2] = (data[i + 2] + data[i - 2] + data[i + 6]) / 3; // B
                                }
                            }
                            
                            if (level > 1) {
                                // 中级去噪 - 减少噪点
                                const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                                const threshold = 30 * (level - 1);
                                
                                if (Math.abs(data[i] - avg) > threshold) data[i] = avg;
                                if (Math.abs(data[i + 1] - avg) > threshold) data[i + 1] = avg;
                                if (Math.abs(data[i + 2] - avg) > threshold) data[i + 2] = avg;
                            }
                        }
                        
                        ctx.putImageData(imageDataObj, 0, 0);
                        resolve(canvas.toDataURL('image/jpeg', 0.9));
                    };
                    img.src = imageData;
                });
            }

            // 处理文件上传
            async function handleFile(file) {
                isImageUploaded = true;
                currentFile = file;
                retryButton.style.display = 'flex';
                clearButton.style.display = 'flex';
                
                // 验证文件类型
                if (!file.type.startsWith('image/')) {
                    showStatus("请选择有效的图像文件！", true);
                    return;
                }

                // 检查模型是否已加载
                if (!isModelLoaded) {
                    showStatus("AI模型尚未加载完成，请稍后再试", true);
                    return;
                }

                fileNameElement.textContent = file.name;
                downloadButton.disabled = true;
                upscaledImage.src = '';
                downloadLink.href = '#';
                statusMessage.style.display = 'none';
                
                // 显示原始图像
                originalPlaceholder.style.display = 'none';
                upscaledPlaceholder.style.display = 'block';
                originalSizeDiv.style.display = 'none';
                upscaledSizeDiv.style.display = 'none';

                const reader = new FileReader();
                reader.onload = async (e) => {
                    originalImage.src = e.target.result;
                    originalImage.style.display = 'block';
                    originalImage.classList.add('clickable-image');
                    
                    // 图像加载完成后进行预处理
                    originalImage.onload = async function() {
                        loader.style.display = 'block';
                        progressBar.style.width = '0%';
                        try {
                            console.log('开始放大图像...');
                            showStatus("开始处理图像，这可能需要一些时间...");
                            
                            // 获取用户选择的放大倍数
                            const zoomFactor = parseInt(zoomFactorSelect.value);
                            
                            // --- 步骤1: 无损填充预处理 (恢复旧版高质量做法) ---
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            let img = new Image();
                            img.src = e.target.result;
                            
                            // 等待图像加载完成
                            await new Promise(resolve => {
                                img.onload = resolve;
                            });
                            
                            // 显示原始图像尺寸
                            originalSizeDiv.textContent = `原图：${img.width}x${img.height}px`;
                            originalSizeDiv.style.display = 'block';

                            // 计算需要填充的尺寸，使其能被模型处理（64的倍数），保留所有像素
                            const targetWidth = Math.ceil(img.width / 64) * 64;
                            const targetHeight = Math.ceil(img.height / 64) * 64;
                            
                            // 计算需要添加的padding
                            const paddingX = (targetWidth - img.width) / 2;
                            const paddingY = (targetHeight - img.height) / 2;
                            
                            canvas.width = targetWidth;
                            canvas.height = targetHeight;
                            
                            // 用白色背景填充
                            ctx.fillStyle = '#FFFFFF';
                            ctx.fillRect(0, 0, targetWidth, targetHeight);
                            
                            // 将原始图像绘制到canvas中央，不裁剪
                            ctx.drawImage(img, paddingX, paddingY, img.width, img.height);
                            
                            const processedImageData = canvas.toDataURL('image/jpeg', 0.9);
                            console.log(`图像已预处理(填充): 原尺寸(${img.width}x${img.height}) -> 填充后(${targetWidth}x${targetHeight})`);
                            
                            // --- 步骤2: 调用AI模型进行4倍放大 ---
                            const modelFixedScale = 4; // 认定模型是固定的4倍，以获取最佳基础质量
                            const upscaledSrc = await upscaler.upscale(processedImageData, {
                                patchSize: 64, // 64是这个旧版模型更稳定的参数
                                padding: 0,
                                progress: (progress) => {
                                    const percentage = (progress * 100).toFixed(2);
                                    fileNameElement.textContent = `正在放大... ${percentage}%`;
                                    progressBar.style.width = `${percentage}%`;
                                },
                            });
                            
                            // --- 步骤3: 高质量裁剪与缩放 (恢复旧版高质量做法) ---
                            showStatus(`模型已输出${modelFixedScale}倍图像，正在高精度处理至 ${zoomFactor} 倍...`);
                            const finalCanvas = document.createElement('canvas');
                            const finalCtx = finalCanvas.getContext('2d');
                            finalCtx.imageSmoothingQuality = 'high'; // 关键：开启高质量模式

                            const tempImg = new Image();
                            await new Promise(resolve => {
                                tempImg.onload = resolve;
                                tempImg.src = upscaledSrc;
                            });
                            
                            // 最终画布尺寸 = 原始尺寸 * 用户选择倍数
                            finalCanvas.width = img.width * zoomFactor;
                            finalCanvas.height = img.height * zoomFactor;

                            // 核心操作：从4倍大图中，精准裁剪出无填充部分，并高质量缩放到目标尺寸
                            finalCtx.drawImage(
                                tempImg,
                                paddingX * modelFixedScale,      // 源裁剪区X坐标 (跳过左边空白)
                                paddingY * modelFixedScale,      // 源裁剪区Y坐标 (跳过顶部空白)
                                img.width * modelFixedScale,     // 源裁剪区宽度 (原始内容在4倍图中的宽度)
                                img.height * modelFixedScale,    // 源裁剪区高度 (原始内容在4倍图中的高度)
                                0,                               // 目标绘制区X坐标
                                0,                               // 目标绘制区Y坐标
                                finalCanvas.width,               // 目标绘制区宽度
                                finalCanvas.height               // 目标绘制区高度
                            );

                            const finalUpscaledSrc = finalCanvas.toDataURL('image/png'); // 使用PNG以保留最高质量

                            // --- 步骤4: 显示最终结果 ---
                            loader.style.display = 'none';
                            upscaledImage.src = finalUpscaledSrc;
                            upscaledImage.style.display = 'block';
                            upscaledImage.classList.add('clickable-image');
                            upscaledPlaceholder.style.display = 'none';
                            downloadLink.href = finalUpscaledSrc;
                            // 设置动态文件名
                            const originalFileName = currentFile.name.split('.').slice(0, -1).join('.');
                            downloadLink.download = `upscaled-${originalFileName}.png`;
                            
                            downloadButton.disabled = false;
                            fileNameElement.textContent = `${file.name} - 放大完成`;
                            progressBar.style.width = '100%';
                            showStatus(`图像放大成功！已高质量处理至 ${zoomFactor} 倍`);
                            
                            upscaledSizeDiv.textContent = `放大后：${finalCanvas.width}x${finalCanvas.height}px`;
                            upscaledSizeDiv.style.display = 'block';

                            setTimeout(() => progressBar.style.width = '0%', 1000);
                            
                        } catch (error) {
                            loader.style.display = 'none';
                            console.error('图像放大失败:', error);
                            fileNameElement.textContent = '放大失败，请重试';
                            let errorMsg = '图像放大失败';
                            if (error.message.includes('Failed to fetch')) errorMsg = '模型加载失败，请检查网络连接或刷新页面重试';
                            else if (error.message.includes('memory')) errorMsg = '图像太大导致内存不足，请尝试较小的图像';
                            else if (error.message.includes('concat4D') || error.message.includes('Shape of tensors')) errorMsg = '图像尺寸不兼容，已尝试自动调整，但仍失败';
                            else if (error.message.includes('WebGL maximum') || error.message.includes('texture size')) errorMsg = '图像尺寸超过WebGL限制，请尝试较小的图像或使用不同的浏览器';
                            showStatus(`${errorMsg}: ${error.message}`, true);
                        }
                    };
                };
                reader.readAsDataURL(file);
            }

            // 处理图像加载错误
            originalImage.onerror = () => {
                if (isImageUploaded) {
                    originalPlaceholder.style.display = 'block';
                    originalImage.style.display = 'none';
                    showStatus("原始图像加载失败", true);
                }
            };

            upscaledImage.onerror = () => {
                if (isImageUploaded) {
                    upscaledPlaceholder.style.display = 'block';
                    upscaledImage.style.display = 'none';
                    showStatus("放大后的图像加载失败", true);
                }
            };

            // 图片点击放大功能
            originalImage.addEventListener('click', () => {
                if (originalImage.src) {
                    imageModal.style.display = 'flex';
                    modalImage.src = originalImage.src;
                }
            });
// --- 在文件末尾的脚本区域内，添加以下代码 ---
modalImage.addEventListener('click', () => {
    // 点击图片时，同时切换图片和其容器的类
    modalImage.classList.toggle('zoomed');
    imageModal.classList.toggle('zoomed-container');
});
            upscaledImage.addEventListener('click', () => {
                if (upscaledImage.src) {
                    imageModal.style.display = 'flex';
                    modalImage.src = upscaledImage.src;
                }
            });

            // 关闭模态框
            closeModal.addEventListener('click', () => {
                    modalImage.classList.remove('zoomed'); // 新增：关闭时重置缩放状态
                    imageModal.classList.remove('zoomed-container'); 
                    imageModal.style.display = 'none';
            });

            // 点击模态框外部关闭
            imageModal.addEventListener('click', (e) => {
                if (e.target === imageModal) {
                    modalImage.classList.remove('zoomed');
                    imageModal.classList.remove('zoomed-container');
                    imageModal.style.display = 'none';
                }
            });

            // ESC键关闭模态框
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && imageModal.style.display === 'flex') {
                    modalImage.classList.remove('zoomed'); // 新增：关闭时重置缩放状态
                    imageModal.classList.remove('zoomed-container'); 
                    imageModal.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>