<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>现代化城市建筑生成器 | 矢量化城市建筑生成</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
 <script src="menu.js" defer></script>
    <link rel="icon" href="img/gongjuxiang.svg" type="image/svg">
<script defer src="https://cloud.umami.is/script.js" data-website-id="5a2e10cd-bf73-47df-be48-079c9ba7783c" data-domains="designtool.site"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --bg-background: linear-gradient(135deg, #f0f2f5, #ebedf0);
            --btcolor: linear-gradient(to left, #5963ff, #6d75ff);
            --text1: #373e4b;
            --text2: #5c6d88;
            --text3: #8ca6ca;
            --line: #dbe0e8;
            --mainbg: #ffffff;
            --accent: #5963ff;
            --control-bg: #eff1f7;
            --shadow: 8px 8px 16px rgba(163, 177, 198, 0.3), 
                      -8px -8px 16px rgba(255, 255, 255, 0.8);
            --inset-shadow: 0 1px 0 #fff, 0 -1px 1px #3c425430;
        }
        
        body {
            background: var(--bg-background);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text1);
        }
        .line {
	    width: 100%;
    	height: 1px;
    	background: var(--line);
    	box-shadow: 0 1px 0 #fff, 0 -1px #0000000a;
	margin-bottom: 10px;
	}
         .stat-item:last-child {
            margin-right: 0;
        }       
        .header {
            text-align: center;
            margin-bottom: 20px;
            max-width: 800px;
            padding: 20px;
            position: relative;
        }
        
        h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            background: var(--btcolor);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 800;
            letter-spacing: -0.5px;
	margin-top: 20px;
        }
        
        .subtitle {
            font-size: 1.0rem;
            color: var(--text2);
            margin-bottom: 20px;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        .controls {
            background: var(--control-bg);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 35px 25px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            width: 100%;
            max-width: 1280px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.6);
            flex-direction: column;
        }
        
        .control-group {
            display: flex;
    	flex-direction: column;
    	min-width: 200px;
    	justify-content: flex-start;
    	gap: 8px;
        }
        
        .control-group-title {
            display: flex;
            align-items: center;
            padding-bottom: 8px;
        }
        
        .control-group-title i {
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: var(--text3);
	margin-right: 8px;
        }
        
        .control-group-title h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text1);
        }
        
        label {
            font-size: 0.95rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            color: var(--text2);
            gap: 8px;
	    margin-bottom: 8px;
        }
        
        button {
            background: var(--btcolor);
            color: white;
            border: none;
            padding: 10px 28px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
            z-index: 1;
            width: 100%;
            justify-content: center;
            box-shadow: var(--shadow);
        }
        
        button:hover {
            box-shadow: var(--inset-shadow);
        }
        
        button:active {
            transform: translateY(1px);
            box-shadow: var(--shadow);
        }
        
        .color-picker {
            display: flex;
            gap: 12px;
            flex-wrap: nowrap;
            align-items: center;
	    margin-top: 10px;
        }
        
        .color-option {
            width: 52px;
            height: 32px;
            border-radius: 50px;
            cursor: pointer;
            border: 2px solid var(--line);
            transition: all 0.3s ease;
            position: relative;
            box-shadow: var(--shadow);
        }
        
        .color-option:hover {
            transform: scale(1.15);
        }
        
        .color-option.active {
            box-shadow: 0 0 0 3px var(--accent);
        }
        
        .custom-color {
            width: 52px;
            height: 32px;
            border-radius: 50px;
            cursor: pointer;
            border: 2px solid var(--line);
            transition: all 0.3s ease;
            position: relative;
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        .custom-color:hover {
		box-shadow: var(--inset-shadow);
		border: none;}
        .custom-color input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            cursor: pointer;
            opacity: 0;
	z-index: 1;
        }
        
        .custom-color i {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #555;
            font-size: 18px;
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            background: rgba(163, 177, 198, 0.2);
            border-radius: 10px;
            outline: none;
            -webkit-appearance: none;
            box-shadow: var(--inset-shadow);
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(89, 99, 255, 0.4);
        }
        
        .canvas-container {
            background: var(--control-bg);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            width: 100%;
            max-width: 900px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.6);
            display: flex;
    flex-direction: column;
    justify-content: space-around;
	gap: 10px;
        }
        
        #cityCanvas {
            width: 100%;
            max-height: 536px;
            background: linear-gradient(to bottom, #e6f0ff, #d4e3ff);
            border-radius: 10px;
            box-shadow: var(--inset-shadow);
        }
        
        .footer {
            margin-top: auto;
            padding: 20px;
            text-align: center;
            font-size: 0.9rem;
            color: var(--text3);
        }
        
        .stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .stat-item {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text2);
            box-shadow: var(--inset-shadow);
        }
        
        .stat-item i {
            color: var(--text3);
        }
        
        .bt {
            color: var(--text2);
    		background: #fff;
        }
        
        .bt:hover {
            background: #f0f2f5;
        }
        
        .sky-selector {
            display: flex;
            gap: 20px;
        }
        
        .sky-option {
            text-align: center;
            padding: 6px 20px;
            border-radius: 12px;
            background: var(--control-bg);
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
	    box-shadow: var(--shadow);
	    color: var(--text2);
	display: flex;
    	justify-content: center;
	    align-items: center;
	    flex-direction: row;
	gap: 10px;
        }
        
        .sky-option:hover {
            background: rgba(89, 99, 255, 0.1);
        }
        
        .sky-option.active {
            background: rgba(89, 99, 255, 0.15);
            box-shadow: var(--inset-shadow);
        }
        
        .sky-option i {
            font-size: 14px;
            display: block;
        }
        
        .sky-color-picker {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sky-color-picker label {
            margin-bottom: 0;
            white-space: nowrap;
        }
        
        .sky-color-input {
            position: relative;
            width: 104px;
            height: 40px;
            border-radius: 50px;
            cursor: pointer;
            overflow: hidden;
            flex-shrink: 0;
	border: 2px solid var(--mainbg);
	box-shadow: var(--shadow);
        }
        .sky-color-input:hover {
		box-shadow: var(--inset-shadow);
		border: none;}
        .sky-color-input input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            cursor: pointer;
            opacity: 0;
        }
        
        .sky-color-preview {
            width: 100%;
            height: 100%;
            border-radius: 50px;
            background: #e6f0ff;
        }
        .buju {
            display: grid; 
            grid-template-columns: 1.85fr 1fr; 
            gap: 20px;
            }
        .btgroup {
            display: flex; 
            flex-direction: row; 
            gap: 12px; 
            margin-top: 8px; 
            width: 100%;
            }
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: center;
                padding: 20px;
                margin-bottom: 0;
		        gap: 30px;
            }
           .buju {
                display: flex; 
                flex-direction: column-reverse;
            }
            .btgroup {
                flex-direction: column;} 
            .control-group {
                width: 100%;
            }
            .color-picker {
		    gap: 10px;}
            button {
                width: 100%;
                justify-content: center;
            }
            
            .stats {
                flex-direction: row;
                align-items: center;
            }
            
            .sky-selector {
                flex-direction: row;
            }
        }
    </style>
</head>
<script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "0fa9d31287314fffb488e27ef3d5c9d7"}'></script>
<body>
<div id="global-sidebar"></div>
    
    <div class="header">
        <h1>城市建筑生成器</h1>
        <p class="subtitle">创建独特的城市天际线，具有逼真的建筑层次感和现代化设计</p>
    </div>
<div class="buju">
    <div class="canvas-container">
        <svg id="cityCanvas" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 500"></svg>
        <div class="btgroup">
                <button class="bt" id="downloadBtn"><i class="fas fa-download"></i> 下载SVG图像</button>
                <button style="background: linear-gradient(90deg, #ffb347, #ff9a3d);" id="addBuildingsBtn"><i class="fas fa-plus"></i> 添加建筑</button>
                <button id="generateBtn"><i class="fas fa-sync-alt"></i> 生成城市</button>
            </div>
    </div>
    
    <div class="controls">
        <div class="control-group">
            <div class="control-group-title">
                <i class="fas fa-fill-drip"></i>
                <h3>建筑主题色调</h3>
            </div>
            <div class="color-picker">
                <div class="color-option active" style="background: #a5aaff;" data-color="#a5aaff"></div>
                <div class="color-option" style="background: #8f56fa;" data-color="#8f56fa"></div>
                <div class="color-option" style="background: #50C0FF;" data-color="#50C0FF"></div>
                <div class="color-option" style="background: #2EC4B6;" data-color="#2EC4B6"></div>
                
                <!-- 自定义颜色选择器 -->
                <div class="custom-color" style="background: #f0f2f5;">
                    <input type="color" id="customColorPicker" value="#a5aaff">
                    <i class="fas fa-palette"></i> <!-- 从 eyedropper 改为 palette -->
                </div>
            </div>
        </div>
        
        <div class="control-group">
        <div class="line"></div>
            <div class="control-group-title">
                <i class="fas fa-cloud"></i>
                <h3>天空设置</h3>
            </div>
            <div class="sky-color-picker">
                <label>天空颜色</label>
                <div class="sky-color-input">
                    <input type="color" id="skyColorPicker" value="#e6f0ff">
                    <div class="sky-color-preview" id="skyColorPreview"></div>
                </div>
            </div>
            
            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <label>天空类型</label>
                <div class="sky-selector">
                    <div class="sky-option active" data-type="clouds">
                        <i class="fas fa-cloud"></i>
                        <span>云朵</span>
                    </div>
                    <div class="sky-option" data-type="stars">
                        <i class="fas fa-star"></i>
                        <span>星空</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="control-group">
        <div class="line"></div>
            <div class="control-group-title">
                <i class="fas fa-building"></i>
                <h3>建筑设置</h3>
            </div>            
            <label>建筑密度: <span id="densityValue">20%</span></label>
            <input type="range" id="densitySlider" min="10" max="90" value="20">
            
            <label style="margin-top: 15px;">窗户密度: <span id="windowDensityValue">20%</span></label>
            <input type="range" id="windowDensitySlider" min="10" max="90" value="20">
        </div>        
    </div>
    
</div>
    
    <div class="stats">
        <div class="stat-item">
            <i class="fas fa-building"></i>
            <span>建筑数量: <span id="buildingCount">0</span></span>
        </div>
        <div class="stat-item">
            <i class="fas fa-window-maximize"></i>
            <span>窗户数量: <span id="windowCount">0</span></span>
        </div>
        <div class="stat-item">
            <i class="fas fa-palette"></i>
            <span>主题色: <span id="colorValue">#a5aaff</span></span>
        </div>
        <div class="stat-item">
            <i class="fas fa-cloud"></i>
            <span>天空: <span id="skyTypeValue">云朵</span></span>
        </div>
    </div>
    
    <script>
        // 配置变量
        const canvas = document.getElementById('cityCanvas');
        const generateBtn = document.getElementById('generateBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const addBuildingsBtn = document.getElementById('addBuildingsBtn');
        const densitySlider = document.getElementById('densitySlider');
        const densityValue = document.getElementById('densityValue');
        const windowDensitySlider = document.getElementById('windowDensitySlider');
        const windowDensityValue = document.getElementById('windowDensityValue');
        const colorOptions = document.querySelectorAll('.color-option');
        const customColorPicker = document.getElementById('customColorPicker');
        const buildingCountEl = document.getElementById('buildingCount');
        const windowCountEl = document.getElementById('windowCount');
        const colorValueEl = document.getElementById('colorValue');
        const skyColorPicker = document.getElementById('skyColorPicker');
        const skyColorPreview = document.getElementById('skyColorPreview');
        const skyOptions = document.querySelectorAll('.sky-option');
        const skyTypeValue = document.getElementById('skyTypeValue');
        
        let baseColor = '#a5aaff';
        let density = 0.2; // 默认20%
        let windowDensity = 0.2; // 默认20%
        let buildingCount = 0;
        let windowCount = 0;
        let skyColor = '#e6f0ff';
        let skyType = 'clouds'; // 默认云朵
        // 新增全局变量记录特殊建筑数量
        let towerCount = 0;
        let pavilionCount = 0;
        let squatCount = 0;
        
        // 初始化
        window.addEventListener('load', function() {
            // 更新天空预览颜色
            skyColorPreview.style.background = skyColor;
            generateCity();
        });
        
        // 事件监听
        generateBtn.addEventListener('click', generateCity);
        addBuildingsBtn.addEventListener('click', addBuildings);
        densitySlider.addEventListener('input', function() {
            density = this.value / 100;
            densityValue.textContent = `${this.value}%`;
        });
        
        windowDensitySlider.addEventListener('input', function() {
            windowDensity = this.value / 100;
            windowDensityValue.textContent = `${this.value}%`;
        });
        
        colorOptions.forEach(option => {
            option.addEventListener('click', function() {
                colorOptions.forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');
                baseColor = this.dataset.color;
                customColorPicker.value = baseColor;
                colorValueEl.textContent = baseColor;
                generateCity();
            });
        });
        
        // 自定义颜色选择器事件
        customColorPicker.addEventListener('input', function() {
            baseColor = this.value;
            colorValueEl.textContent = baseColor;
            colorOptions.forEach(opt => opt.classList.remove('active'));
            generateCity();
        });
        
        // 天空颜色选择器
        skyColorPicker.addEventListener('input', function() {
            skyColor = this.value;
            skyColorPreview.style.background = skyColor;
            generateCity();
        });
        
        // 天空类型选择器
        skyOptions.forEach(option => {
            option.addEventListener('click', function() {
                skyOptions.forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');
                skyType = this.dataset.type;
                skyTypeValue.textContent = this.dataset.type === 'clouds' ? '云朵' : '星空';
                generateCity();
            });
        });
        
        downloadBtn.addEventListener('click', downloadSVG);
        
    // 生成城市函数
    function generateCity() {
        // 重置特殊建筑计数
        towerCount = 0;
        pavilionCount = 0;
        squatCount = 0;

        // 清除画布
        canvas.innerHTML = '';
        buildingCount = 0;
        windowCount = 0;
        
        // 创建背景
        createBackground();
        
        // 生成建筑
        const count = Math.floor(10 + 25 * density);
        for (let i = 0; i < count; i++) {
            createBuilding();
        }
        
        // 添加地面
        createGround();
        
        // 更新统计
        updateStats();
    }
        
        // 添加建筑函数
        function addBuildings() {
            const count = Math.floor(5 + 10 * density);
            for (let i = 0; i < count; i++) {
                createBuilding();
            }
            updateStats();
        }
        
        // 更新统计信息
        function updateStats() {
            buildingCountEl.textContent = buildingCount;
            windowCountEl.textContent = windowCount;
        }
        
        // 创建背景
        function createBackground() {
            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            canvas.appendChild(defs);
            
            // 从天空颜色计算底部颜色（变暗）
            const bottomColor = darkenColor(skyColor, 10);
            
            // 背景渐变
            const bgGradient = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
            bgGradient.setAttribute('id', 'bgGradient');
            bgGradient.setAttribute('x1', '0%');
            bgGradient.setAttribute('y1', '100%');
            bgGradient.setAttribute('x2', '0%');
            bgGradient.setAttribute('y2', '0%');
            
            const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
            stop1.setAttribute('offset', '0%');
            stop1.setAttribute('stop-color', skyColor);
            
            const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
            stop2.setAttribute('offset', '100%');
            stop2.setAttribute('stop-color', bottomColor);
            
            bgGradient.appendChild(stop1);
            bgGradient.appendChild(stop2);
            defs.appendChild(bgGradient);
            
            const bgRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            bgRect.setAttribute('width', '800');
            bgRect.setAttribute('height', '500');
            bgRect.setAttribute('fill', 'url(#bgGradient)');
            canvas.appendChild(bgRect);
            
            // 添加天空元素（云朵或星星）
            if (skyType === 'clouds') {
                for (let i = 0; i < 5; i++) {
                    createCloud(Math.random() * 700 + 50, Math.random() * 100 + 30);
                }
            } else {
                createStars();
            }
        }
        
        // 创建云朵
        function createCloud(x, y) {
            const cloudGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            
            // 创建多个圆形组成云朵
            const positions = [
                [0, 2, 20],
                [15, 3, 15],
                [25, -3, 18],
                [40, 5, 16],
                [30, 10, 14],
                [10, 10, 16],
                [-5, 5, 12]
            ];
            
            positions.forEach(pos => {
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', x + pos[0]);
                circle.setAttribute('cy', y + pos[1]);
                circle.setAttribute('r', pos[2]);
                circle.setAttribute('fill', 'rgba(255, 255, 255, 0.9)');
                cloudGroup.appendChild(circle);
            });
            
            canvas.appendChild(cloudGroup);
        }
        
        // 创建星星
        function createStars() {
            const starGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            
            // 创建多个星星
            for (let i = 0; i < 100; i++) {
                const x = Math.random() * 800;
                const y = Math.random() * 250;
                const size = Math.random() * 1.5 + 0.5;
                const opacity = Math.random() * 0.7 + 0.3;
                
                const star = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                star.setAttribute('cx', x);
                star.setAttribute('cy', y);
                star.setAttribute('r', size);
                star.setAttribute('fill', '#ffffff');
                star.setAttribute('opacity', opacity);
                starGroup.appendChild(star);
                
                // 添加一些闪烁的星星
                if (Math.random() > 0.8) {
                    const glow = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    glow.setAttribute('cx', x);
                    glow.setAttribute('cy', y);
                    glow.setAttribute('r', size * 2);
                    glow.setAttribute('fill', 'url(#starGlow)');
                    glow.setAttribute('opacity', opacity * 0.3);
                    starGroup.appendChild(glow);
                }
            }
            
            // 添加径向渐变用于星星发光效果
            const defs = canvas.querySelector('defs');
            const glowGradient = document.createElementNS('http://www.w3.org/2000/svg', 'radialGradient');
            glowGradient.setAttribute('id', 'starGlow');
            glowGradient.setAttribute('cx', '50%');
            glowGradient.setAttribute('cy', '50%');
            glowGradient.setAttribute('r', '50%');
            glowGradient.setAttribute('fx', '50%');
            glowGradient.setAttribute('fy', '50%');
            
            const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
            stop1.setAttribute('offset', '0%');
            stop1.setAttribute('stop-color', '#ffffff');
            stop1.setAttribute('stop-opacity', '1');
            
            const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
            stop2.setAttribute('offset', '100%');
            stop2.setAttribute('stop-color', '#ffffff');
            stop2.setAttribute('stop-opacity', '0');
            
            glowGradient.appendChild(stop1);
            glowGradient.appendChild(stop2);
            defs.appendChild(glowGradient);
            
            canvas.appendChild(starGroup);
        }
     // 创建普通建筑（原createBuilding函数中的内容）
    function createNormalBuilding(x, y, width, height, group) {
        // 生成同色系渐变
        const color = hexToHSL(baseColor);
        const mainColor = `hsl(${color.h}, ${color.s}%, ${Math.max(20, color.l - 5)}%)`;
        
        // 创建建筑主体
        const building = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        building.setAttribute('x', x);
        building.setAttribute('y', y);
        building.setAttribute('width', width);
        building.setAttribute('height', height);
        
        // 创建渐变
        const gradientId = `gradient-${buildingCount}`;
        const gradient = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
        gradient.setAttribute('id', gradientId);
        gradient.setAttribute('x1', '0%');
        gradient.setAttribute('y1', '0%');
        gradient.setAttribute('x2', '0%');
        gradient.setAttribute('y2', '100%');
        
        const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
        stop1.setAttribute('offset', '0%');
        stop1.setAttribute('stop-color', mainColor);
        stop1.setAttribute('stop-opacity', '1.0');
        
        const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
        stop2.setAttribute('offset', '100%');
        stop2.setAttribute('stop-color', mainColor);
        stop2.setAttribute('stop-opacity', '0.0');
        
        gradient.appendChild(stop1);
        gradient.appendChild(stop2);
        
        const defs = canvas.querySelector('defs') || canvas.appendChild(document.createElementNS('http://www.w3.org/2000/svg', 'defs'));
        defs.appendChild(gradient);
        
        building.setAttribute('fill', `url(#${gradientId})`);
        group.appendChild(building);
        
        // 添加建筑细节
        addBuildingDetails(x, y, width, height, group, color);
        
        // 添加窗户
        addWindows(x, y, width, height, group, color);
        
        // 随机添加天线
        if (Math.random() > 0.7) {
            const antennaHeight = Math.random() * 30 + 20;
            const antenna = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            antenna.setAttribute('x1', x + width/2);
            antenna.setAttribute('y1', y);
            antenna.setAttribute('x2', x + width/2);
            antenna.setAttribute('y2', y - antennaHeight);
            antenna.setAttribute('stroke', '#cccccc');
            antenna.setAttribute('stroke-width', '1');
            antenna.setAttribute('opacity', '0.7');
            group.appendChild(antenna);
            
            const antennaBall = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            antennaBall.setAttribute('cx', x + width/2);
            antennaBall.setAttribute('cy', y - antennaHeight);
            antennaBall.setAttribute('r', '3');
            antennaBall.setAttribute('fill', baseColor);
            antennaBall.setAttribute('opacity', '0.8');
            group.appendChild(antennaBall);
        }
    }
    
    // 添加建筑细节（仅屋顶）
    function addBuildingDetails(x, y, width, height, group, color) {
        // 添加建筑顶部
        const topHeight = Math.random() * 15 + 10;
        
        // 随机选择屋顶类型（平顶或斜顶）
        const roofType = Math.random() > 0.5 ? 'flat' : 'angled';
        
        if (roofType === 'flat') {
            // 平顶
            const top = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            top.setAttribute('x', x - 5);
            top.setAttribute('y', y - topHeight);
            top.setAttribute('width', width + 10);
            top.setAttribute('height', topHeight);
            top.setAttribute('fill', '#454545');
            top.setAttribute('opacity', '1.0');
            group.appendChild(top);
        } else {
            // 斜角屋顶 - 只倾斜顶边
            const roof = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            
            // 创建偏移量使顶部倾斜
            const offset = Math.random() * 20 + 10;
            
            // 点顺序：左下 -> 右下 -> 右上 -> 左上
            const points = `
                ${x},${y} 
                ${x + width},${y} 
                ${x + width - offset},${y - topHeight} 
                ${x + offset},${y - topHeight}
            `;
            
            roof.setAttribute('points', points);
            roof.setAttribute('fill', '#333');
            roof.setAttribute('opacity', '1.0');
            group.appendChild(roof);
        }
	return topHeight;
    }
    
    // 添加窗户 - 高度随机变化，宽度固定
    function addWindows(x, y, width, height, group, color) {
        const windowSpacing = 10;
        const margin = 12;
        const floorHeight = 28;
        
        const floors = Math.floor((height - margin * 2) / floorHeight);
        
        for (let floor = 0; floor < floors; floor++) {
            const windowsPerFloor = Math.floor((width - margin * 2) / windowSpacing);
            const floorY = y + margin + floor * floorHeight;
            
            for (let i = 0; i < windowsPerFloor; i++) {
                // 根据窗户密度跳过一些窗户
                if (Math.random() > windowDensity) continue;
                
                const windowX = x + margin + i * windowSpacing;
                
                // 使用深色窗户设计
                const windowColor = `hsl(${color.h}, ${color.s}%, ${Math.max(0, color.l - 40)}%)`;
                
                // 创建窗户 - 宽度固定，高度随机
                const windowHeight = Math.random() * 8 + 8; // 8-16高度
                const window = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                window.setAttribute('x', windowX);
                window.setAttribute('y', floorY + (floorHeight - windowHeight)/2);
                window.setAttribute('width', 6); // 固定宽度
                window.setAttribute('height', windowHeight);
                window.setAttribute('fill', windowColor);
                window.setAttribute('rx', '1'); // 圆角
                window.setAttribute('opacity', '0.3');
                group.appendChild(window);
                
                windowCount++;
            }
        }
    }       
        // 创建建筑
        function createBuilding() {
            buildingCount++;
            
            // 随机决定建筑类型（普通建筑占80%，特殊建筑占20%）
            const buildingType = Math.random() > 0.8 ? getRandomSpecialBuildingType() : 'normal';
            
            // 根据建筑类型设置尺寸范围
            let width, height;
            switch(buildingType) {
                case 'tower':
                    // 塔形建筑 - 高而窄
                    width = Math.random() * 40 + 20; // 20-60
                    height = Math.random() * 250 + 180; // 200-500
                    towerCount++;
                    break;
                case 'pavilion':
                    // 亭子 - 小而精致
                    width = Math.random() * 30 + 20; // 20-50
                    height = Math.random() * 20 + 50; // 50-130
                    pavilionCount++;
                    break;
                case 'squat':
                    // 矮胖型建筑 - 宽而矮
                    width = Math.random() * 100 + 100; // 80-180
                    height = Math.random() * 120 + 80; // 80-200
                    squatCount++;
                    break;
                default:
                    // 普通建筑
                    width = Math.random() * 80 + 20; // 20-100
                    height = Math.random() * 250 + 100; // 100-350
            }
            
            const x = Math.random() * (800 - width);
            const y = 500 - height;
            
            // 创建建筑组
            const buildingGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            
            // 根据建筑类型创建不同的建筑
            switch(buildingType) {
                case 'tower':
                    createTowerBuilding(x, y, width, height, buildingGroup);
                    break;
                case 'pavilion':
                    createPavilionBuilding(x, y, width, height, buildingGroup);
                    break;
                case 'squat':
                    createSquatBuilding(x, y, width, height, buildingGroup);
                    break;
                default:
                    createNormalBuilding(x, y, width, height, buildingGroup);
            }
            
            canvas.appendChild(buildingGroup);
        }
        
        // 获取随机特殊建筑类型（确保每种不超过2个）
        function getRandomSpecialBuildingType() {
            const availableTypes = [];
            if (towerCount < 2) availableTypes.push('tower');
            if (pavilionCount < 2) availableTypes.push('pavilion');
            if (squatCount < 2) availableTypes.push('squat');
            
            if (availableTypes.length === 0) return 'normal';
            
            const randomIndex = Math.floor(Math.random() * availableTypes.length);
            return availableTypes[randomIndex];
        }
        
        // 创建普通建筑（原createBuilding函数中的内容）
        function createNormalBuilding(x, y, width, height, group) {
            // 生成同色系渐变
            const color = hexToHSL(baseColor);
            const mainColor = `hsl(${color.h}, ${color.s}%, ${Math.max(20, color.l - 5)}%)`;
            
            // 创建建筑主体
            const building = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            building.setAttribute('x', x);
            building.setAttribute('y', y);
            building.setAttribute('width', width);
            building.setAttribute('height', height);
            
            // 创建渐变
            const gradientId = `gradient-${buildingCount}`;
            const gradient = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
            gradient.setAttribute('id', gradientId);
            gradient.setAttribute('x1', '0%');
            gradient.setAttribute('y1', '0%');
            gradient.setAttribute('x2', '0%');
            gradient.setAttribute('y2', '100%');
            
            const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
            stop1.setAttribute('offset', '0%');
            stop1.setAttribute('stop-color', mainColor);
            stop1.setAttribute('stop-opacity', '1.0');
            
            const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
            stop2.setAttribute('offset', '100%');
            stop2.setAttribute('stop-color', mainColor);
            stop2.setAttribute('stop-opacity', '0.0');
            
            gradient.appendChild(stop1);
            gradient.appendChild(stop2);
            
            const defs = canvas.querySelector('defs') || canvas.appendChild(document.createElementNS('http://www.w3.org/2000/svg', 'defs'));
            defs.appendChild(gradient);
            
            building.setAttribute('fill', `url(#${gradientId})`);
            group.appendChild(building);
            
    		// 添加建筑细节并获取屋顶高度
    		const topHeight = addBuildingDetails(x, y, width, height, group, color);            
            // 添加窗户
            addWindows(x, y, width, height, group, color);
            
            // 随机添加天线
    if (Math.random() > 0.7) {
        const antennaHeight = Math.random() * 30 + 20;
        const antenna = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        antenna.setAttribute('x1', x + width/2);
        antenna.setAttribute('y1', y - topHeight); // 修改为从屋顶顶部开始
        antenna.setAttribute('x2', x + width/2);
        antenna.setAttribute('y2', y - topHeight - antennaHeight); // 终点也相应调整
                antenna.setAttribute('stroke', '#cccccc');
                antenna.setAttribute('stroke-width', '1');
                antenna.setAttribute('opacity', '0.7');
                group.appendChild(antenna);
                
        const antennaBall = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        antennaBall.setAttribute('cx', x + width/2);
        antennaBall.setAttribute('cy', y - topHeight - antennaHeight); // 同样调整
                antennaBall.setAttribute('r', '3');
                antennaBall.setAttribute('fill', '#ffcc00');
                antennaBall.setAttribute('opacity', '0.8');
                group.appendChild(antennaBall);
            }
        }
        
        // 创建塔形建筑
        function createTowerBuilding(x, y, width, height, group) {
            const color = hexToHSL(baseColor);
            const mainColor = `hsl(${color.h}, ${color.s}%, ${Math.max(20, color.l - 10)}%)`;
            
            // 创建塔体（多个梯形堆叠）
            const layers = 3; // 3层
            const layerHeight = height / layers;
            
            for (let i = 0; i < layers; i++) {
                const layerWidth = width * (1 - i * 0.15);
                const layerX = x + (width - layerWidth) / 1.5;
                const layerY = y + i * layerHeight;
                
                // 创建梯形
                const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                const points = `
                    ${layerX},${layerY + layerHeight} 
                    ${layerX + layerWidth},${layerY + layerHeight} 
                    ${layerX + layerWidth * 0.8},${layerY} 
                    ${layerX + layerWidth * 0.2},${layerY}
                `;
                polygon.setAttribute('points', points);
                polygon.setAttribute('fill', mainColor);
                polygon.setAttribute('opacity', (0.9 - i * 0.2).toString());
                group.appendChild(polygon);
            }
            
            // 添加尖顶
            const spireHeight = layerHeight * 0.5;
            const spire = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            const spirePoints = `
                ${x + width * 0.4},${y} 
                ${x + width * 0.6},${y} 
                ${x + width * 0.5},${y - spireHeight}
            `;
            spire.setAttribute('points', spirePoints);
            spire.setAttribute('fill', '#333');
            spire.setAttribute('opacity', '0.8');
            group.appendChild(spire);
            
            // 添加顶柱
            const poleHeight = spireHeight * 0.4;
            const pole = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            pole.setAttribute('x1', x + width/2);
            pole.setAttribute('y1', y - spireHeight);
            pole.setAttribute('x2', x + width/2);
            pole.setAttribute('y2', y - spireHeight - poleHeight);
            pole.setAttribute('stroke', '#ccc');
            pole.setAttribute('stroke-width', '2');
            group.appendChild(pole);
            
            // 添加顶球
            const ball = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            ball.setAttribute('cx', x + width/2);
            ball.setAttribute('cy', y - spireHeight - poleHeight);
            ball.setAttribute('r', '4');
            ball.setAttribute('fill', '#ffcc00');
            group.appendChild(ball);
            
            // 添加窗户（垂直排列）
            addTowerWindows(x, y, width, height, group, color);
        }
        
        // 添加塔形建筑窗户
        function addTowerWindows(x, y, width, height, group, color) {
            const windowSpacing = 15;
            const margin = 10;
            const floorHeight = 40;
            
            const floors = Math.floor((height - margin * 2) / floorHeight);
            
            for (let floor = 0; floor < floors; floor++) {
                // 跳过一些楼层以创建间距
                if (Math.random() > 0.7) continue;
                
                const floorY = y + margin + floor * floorHeight;
                
                // 窗户颜色
                const windowColor = `hsl(${color.h}, ${color.s}%, ${Math.max(0, color.l - 40)}%)`;
                
                // 创建窗户 - 垂直排列
                const window = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                window.setAttribute('x', x + width/2 - 4);
                window.setAttribute('y', floorY + 10);
                window.setAttribute('width', 8);
                window.setAttribute('height', 20);
                window.setAttribute('fill', windowColor);
                window.setAttribute('rx', '1');
                window.setAttribute('opacity', '0.6');
                group.appendChild(window);
                
                windowCount++;
            }
        }
        
        // 创建亭子
        function createPavilionBuilding(x, y, width, height, group) {
            const color = hexToHSL(baseColor);
            const mainColor = `hsl(${color.h}, ${color.s}%, ${Math.max(20, color.l - 10)}%)`;
            
            // 创建柱子
            const columnWidth = width * 0.15;
            const columnHeight = height * 0.7;
                // 柱子向内收进的偏移量（设为柱子宽度的50%）
    	const columnInset = columnWidth * 0.5;

            // 左柱
            const leftColumn = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            leftColumn.setAttribute('x', x + columnInset); 
            leftColumn.setAttribute('y', y + height - columnHeight);
            leftColumn.setAttribute('width', columnWidth);
            leftColumn.setAttribute('height', columnHeight);
            leftColumn.setAttribute('fill', mainColor);
            leftColumn.setAttribute('opacity', '0.8');
            group.appendChild(leftColumn);
            
            // 右柱
            const rightColumn = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rightColumn.setAttribute('x', x + width - columnWidth - columnInset); 
            rightColumn.setAttribute('y', y + height - columnHeight);
            rightColumn.setAttribute('width', columnWidth);
            rightColumn.setAttribute('height', columnHeight);
            rightColumn.setAttribute('fill', mainColor);
            rightColumn.setAttribute('opacity', '0.8');
            group.appendChild(rightColumn);
            
            // 创建屋顶
            const roofHeight = height * 0.5;
            const roof = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            const roofPoints = `
                ${x},${y + height - columnHeight} 
                ${x + width},${y + height - columnHeight} 
                ${x + width/2},${y + height - columnHeight - roofHeight}
            `;
            roof.setAttribute('points', roofPoints);
            roof.setAttribute('fill', '#8B4513'); // 棕色屋顶
            roof.setAttribute('opacity', '0.9');
            group.appendChild(roof);
            
            // 添加顶柱
            const poleHeight = roofHeight * 0.5;
            const pole = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            pole.setAttribute('x1', x + width/2);
            pole.setAttribute('y1', y + height - columnHeight - roofHeight);
            pole.setAttribute('x2', x + width/2);
            pole.setAttribute('y2', y + height - columnHeight - roofHeight - poleHeight);
            pole.setAttribute('stroke', '#ccc');
            pole.setAttribute('stroke-width', '2');
            group.appendChild(pole);
            
            // 添加顶球
            const ball = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            ball.setAttribute('cx', x + width/2);
            ball.setAttribute('cy', y + height - columnHeight - roofHeight - poleHeight);
            ball.setAttribute('r', '5');
            ball.setAttribute('fill', '#ffcc00');
            group.appendChild(ball);
        }
        
        // 创建矮胖型建筑
        function createSquatBuilding(x, y, width, height, group) {
            const color = hexToHSL(baseColor);
            const mainColor = `hsl(${color.h}, ${color.s}%, ${Math.max(20, color.l - 5)}%)`;
            
            // 创建建筑主体
            const building = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            building.setAttribute('x', x);
            building.setAttribute('y', y);
            building.setAttribute('width', width);
            building.setAttribute('height', height);
            building.setAttribute('fill', mainColor);
            building.setAttribute('opacity', '0.9');
            group.appendChild(building);
            
            // 添加平顶
            const top = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            top.setAttribute('x', x - 5);
            top.setAttribute('y', y - 10);
            top.setAttribute('width', width + 10);
            top.setAttribute('height', 10);
            top.setAttribute('fill', '#454545');
            top.setAttribute('opacity', '1.0');
            group.appendChild(top);
            
            // 添加特殊窗户（横向长条）
            addSquatWindows(x, y, width, height, group, color);
        }
        
        // 添加矮胖型建筑窗户
        function addSquatWindows(x, y, width, height, group, color) {
            const floorHeight = 30;
            const margin = 15;
            const windowHeight = 10;
            
            const floors = Math.floor((height - margin * 2) / floorHeight);
            
            for (let floor = 0; floor < floors; floor++) {
                const floorY = y + margin + floor * floorHeight;
                
                // 窗户颜色
                const windowColor = `hsl(${color.h}, ${color.s}%, ${Math.max(0, color.l - 40)}%)`;
                
                // 创建横向长条窗户
                const window = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                window.setAttribute('x', x + 10);
                window.setAttribute('y', floorY + (floorHeight - windowHeight)/2);
                window.setAttribute('width', width - 20);
                window.setAttribute('height', windowHeight);
                window.setAttribute('fill', windowColor);
                window.setAttribute('rx', '3');
                window.setAttribute('opacity', '0.4');
                group.appendChild(window);
                
                windowCount++;
                
                // 添加窗户分隔线
                if (width > 100) {
                    const separatorCount = Math.floor((width - 20) / 30);
                    for (let i = 1; i < separatorCount; i++) {
                        const separator = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                        separator.setAttribute('x1', x + 10 + i * ((width - 20) / separatorCount));
                        separator.setAttribute('y1', floorY + (floorHeight - windowHeight)/2);
                        separator.setAttribute('x2', x + 10 + i * ((width - 20) / separatorCount));
                        separator.setAttribute('y2', floorY + (floorHeight - windowHeight)/2 + windowHeight);
                        separator.setAttribute('stroke', '#000');
                        separator.setAttribute('stroke-width', '1');
                        separator.setAttribute('opacity', '0.2');
                        group.appendChild(separator);
                    }
                }
            }
        }
        
        // 创建地面
        function createGround() {
            const ground = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            ground.setAttribute('x', '0');
            ground.setAttribute('y', '490');
            ground.setAttribute('width', '800');
            ground.setAttribute('height', '10');
            ground.setAttribute('fill', '#e0e0e0');
            ground.setAttribute('opacity', '0.9');
            canvas.appendChild(ground);
            
            // 添加地面细节
            for (let i = 0; i < 20; i++) {
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', i * 40);
                line.setAttribute('y1', '495');
                line.setAttribute('x2', i * 40 + 20);
                line.setAttribute('y2', '495');
                line.setAttribute('stroke', '#5963ff');
                line.setAttribute('stroke-width', '1');
                line.setAttribute('opacity', '0.6');
                canvas.appendChild(line);
            }
        }
        
        // 下载SVG函数
        function downloadSVG() {
            const svgData = canvas.outerHTML;
            const blob = new Blob([svgData], {type: "image/svg+xml"});
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement("a");
            link.href = url;
            link.download = "modern_city.svg";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        
        // 辅助函数：十六进制转HSL
        function hexToHSL(hex) {
            // 转换十六进制为RGB
            let r = parseInt(hex.substring(1, 3), 16);
            let g = parseInt(hex.substring(3, 5), 16);
            let b = parseInt(hex.substring(5, 7), 16);
            
            // 将RGB值转换为0-1范围
            r /= 255, g /= 255, b /= 255;
            
            // 查找最大值和最小值
            let max = Math.max(r, g, b);
            let min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            
            if (max === min) {
                h = s = 0; // 灰色
            } else {
                let d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                
                h /= 6;
            }
            
            return {
                h: Math.round(h * 360),
                s: Math.round(s * 100),
                l: Math.round(l * 100)
            };
        }
        
        // 辅助函数：加深颜色
        function darkenColor(color, percent) {
            // 如果颜色是十六进制
            if (color.startsWith('#')) {
                let r = parseInt(color.substring(1, 3), 16);
                let g = parseInt(color.substring(3, 5), 16);
                let b = parseInt(color.substring(5, 7), 16);
                
                r = Math.max(0, Math.floor(r * (100 - percent) / 100));
                g = Math.max(0, Math.floor(g * (100 - percent) / 100));
                b = Math.max(0, Math.floor(b * (100 - percent) / 100));
                
                return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
            }
            return color;
        }
    </script>
</body>
</html>