<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>批量条形码生成工具</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>
    <script defer src="https://cloud.umami.is/script.js" data-website-id="5a2e10cd-bf73-47df-be48-079c9ba7783c" data-domains="designtool.site"></script>
    <script src="menu.js" defer></script>
    <link rel="icon" href="img/gongjuxiang.svg" type="image/svg">
    
    <style>
        :root {
            --main-color: #5a64ff;
            --btcolor: linear-gradient(113deg, #4c73ff, #6a52ff);
            --text1: #1a1d2e;
            --text2: #4a4e6d;
            --text3: #8d8fa3;
            --border: #e2e4f0;
            --background: #f7f8fc;
            --white: #ffffff;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--background); color: var(--text2); margin: 0;
            padding: 20px;
        }
        .icon {
    display: inline-block;
    width: 1.2em;
    height: 1.2em;
    fill: currentColor;
}
        header {
            text-align: center;
            padding: 20px;
        }
        .quesheng {
            color: var(--text3); 
            padding: 100px 20px; 
            display: flex; 
            flex-direction: column;
            align-items: center; 
            gap: 15px;
        }
        .color-input {
            width: 32px;
            height: 32px;
            border: 1px solid var(--border);
            background: none;
            border-radius: 6px;
            padding: 2px;
            cursor: pointer;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .color-input::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        .color-input::-webkit-color-swatch {
            border: none;
            border-radius: 4px;
        }
        .color-input::-moz-color-swatch {
            border: none;
            border-radius: 4px;
        }
        .container {
            width: 100%;
            margin: 0 auto;
            display: flex;
            gap: 10px;
            align-items: flex-start;
            padding-left: 60px;
        }
.controls {
    width: 380px;
    flex-shrink: 0;
    position: sticky;
    top: 20px;
    max-height: calc(100vh - 110px); /* 新增：限制最大高度，使其不超过视口高度 */
    overflow-y: auto; /* 新增：当内容超出时，在面板内部显示垂直滚动条 */
}
        .controls, .preview {
            background: var(--white); border-radius: 8px; padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);     
            box-sizing: border-box;
        }
        
        /* 自定义滚动条样式 */
        .controls::-webkit-scrollbar,
        .preview::-webkit-scrollbar,
        textarea::-webkit-scrollbar {
            width: 8px; /* 滚动条宽度 */
            height: 8px; /* 水平滚动条高度 */
        }
        
        /* 滚动条轨道 */
        .controls::-webkit-scrollbar-track,
        .preview::-webkit-scrollbar-track,
        textarea::-webkit-scrollbar-track {
            background: var(--background); /* 使用背景色 */
            border-radius: 4px; /* 轨道圆角 */
        }
        
        /* 滚动条滑块 */
        .controls::-webkit-scrollbar-thumb,
        .preview::-webkit-scrollbar-thumb,
        textarea::-webkit-scrollbar-thumb {
            background: var(--border); /* 使用边框颜色 */
            border-radius: 4px; /* 滑块圆角 */
            transition: background-color 0.2s ease;
        }
        
        /* 滚动条滑块悬停效果 */
        .controls::-webkit-scrollbar-thumb:hover,
        .preview::-webkit-scrollbar-thumb:hover,
        textarea::-webkit-scrollbar-thumb:hover {
            background: var(--text3); /* 使用次要文本颜色 */
        }
        
        /* 滚动条边角 */
        .controls::-webkit-scrollbar-corner,
        .preview::-webkit-scrollbar-corner,
        textarea::-webkit-scrollbar-corner {
            background: var(--background); /* 使用背景色 */
        }
        
        /* 为Firefox添加滚动条样式 */
        .controls,
        .preview,
        textarea {
            scrollbar-width: thin; /* 细滚动条 */
            scrollbar-color: var(--border) var(--background); /* 滑块颜色 轨道颜色 */
        }
        .preview { 
            flex-grow: 1;  
            height: -webkit-fill-available;
            max-height: calc(100vh - 110px);
            overflow-y: auto;}
        .input-box::-webkit-scrollbar {
    width: 8px; 
    height: 8px; }

        h1 {
            color: var(--text1);  
            padding-bottom: 20px;
            margin-top: 0; 
            font-size: 1.4rem;
            display: flex;
            justify-content: center;
        }
        .heading-with-button {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }
        .heading-with-button h2 {
            color: var(--text1);
            margin: 0;
            font-size: 1.2rem;
        }
        #save-styles-btn {
            width: auto;
            padding: 6px 14px;
            font-size: 0.8rem;
            white-space: nowrap;
        }
        
        .control-group { margin-bottom: 10px; }
        .control-group label, .slider-group .label-row label, .settings-group .control-group > label {
            font-weight: 400; 
            color: var(--text2);
            display: block;
            font-size: 0.9rem;
        }
        
        input[type="text"], input[type="number"], select, textarea {
            width: 100%; padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px;
            box-sizing: border-box; transition: border-color 0.3s;
            background: var(--white);
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--main-color); }
        textarea { resize: vertical; min-height: 100px; }
        
        .slider-group .label-row {
            display: flex; justify-content: space-between; align-items: center; 
        }
        .slider-group .label-row label { margin-bottom: 0; }
        .slider-group input[type="number"] { width: 70px; flex-shrink: 0; text-align: center;  height: 32px;}
        .slider-group input[type="range"] {
            width: 100%; -webkit-appearance: none; appearance: none;
            height: 8px; background: var(--border); border-radius: 5px; outline: none; margin: 0;
        }
        .slider-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 18px; height: 18px;
            background: var(--main-color); border-radius: 50%; cursor: pointer;
        }
        .slider-group input[type="range"]::-moz-range-thumb {
            width: 18px; height: 18px; background: var(--main-color);
            border-radius: 50%; cursor: pointer; border: none;
        }
        
.tabs {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    margin-bottom: 15px;
    border-bottom: 1px solid var(--border);
    /* --- 以下是为实现吸顶效果新增的样式 --- */
    position: sticky;
    top: -20px; /* 关键：抵消父容器的内边距，实现真正的顶部对齐 */
    background: var(--white); /* 添加背景色，防止下方内容滚动时透过来 */
    z-index: 1; /* 确保它显示在最上层 */
}
        .tab-button {
            padding: 10px 15px; cursor: pointer; border: none; background: none; font-size: 1.1rem;
            color: var(--text2); border-bottom: 2px solid transparent;
            font-weight: 600;
            text-align: center;
            margin-bottom: -1px;
        }
        .tab-button.active { color: var(--main-color); border-bottom-color: var(--main-color); }
        .tab-content { display: none; } .tab-content.active { display: block; }
        .inline-group { display: flex; gap: 10px; } 
        .inline-group > div { flex-grow: 1; }
        
        .file-input-wrapper input[type="file"] {
            width: 0.1px; height: 0.1px; opacity: 0;
            overflow: hidden; position: absolute; z-index: -1;
        }
        
        .action-footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--white);
            padding: 15px; border-top: 1px solid var(--border);
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.03);
            z-index: 100; box-sizing: border-box;
        }
        .footer-buttons {
            max-width: 900px; padding: 0 20px; margin: 0 auto; display: grid;
            grid-template-columns: repeat(5, 1fr); gap: 10px;
        }
        
        .btn {
            width: 100%; padding: 10px; border-radius: 10px; font-size: 0.9rem;
            font-weight: 500; cursor: pointer; transition: all 0.3s; border: 1px solid transparent;
            white-space: nowrap; display: inline-flex; align-items: center; justify-content: center;
        }
        .btn:disabled {
            cursor: not-allowed;
            background: var(--border) !important;
            color: var(--text3) !important;
            border-color: transparent !important;
            box-shadow: none !important;
            opacity: 0.7;
        }
        .btn.btn-primary { background: var(--btcolor); color: var(--white); }
        .btn.btn-outline { background: var(--white); color: var(--main-color); border-color: var(--main-color); }
        .btn.btn-secondary { 
            background: #f0f1f6; 
            color: var(--text2); 
            padding: 4px 10px;
        }
        .btn.btn-secondary:hover {
            background: #e5e7f2;
        }
        .btn.btn-primary:hover:not(:disabled) { opacity: 0.9; box-shadow: 0 2px 8px rgba(90, 100, 255, 0.3); }
        .btn.btn-outline:hover:not(:disabled) { background: #f5f6ff; }
        
        #barcode-container {
            display: flex; flex-wrap: wrap; justify-content: center;
            align-items: flex-start; gap: 20px;
        }
        .barcode-item {
            display: flex; flex-direction: column; align-items: center;
            padding: 15px; border: 1px solid var(--border); border-radius: 8px;
            background: var(--background);
        }
        .barcode-item svg { max-width: 100%; height: auto; }
        
        .settings-group {
            background: var(--background);
            border-radius: 8px;
            padding: 14px;
            margin-top: 10px;
        }
        .settings-group h3 {
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1rem;
            color: var(--text1);
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .inline-control {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .inline-control label {
            margin-bottom: 0; 
            flex-shrink: 0;
        }
        .inline-control select {
            flex-grow: 1;
        }
        .font-style-buttons { display: flex; gap: 8px; }
        .font-style-buttons .btn {
            width: 38px; height: 32px; padding: 0;
            font-size: 1rem;
            border: 1px solid var(--border);
            background: var(--white);
            color: var(--text3);
        }
        .font-style-buttons .btn.active {
            background: #e9eaff;
            color: var(--main-color);
            border-color: var(--main-color);
        }

        .file-input-wrapper {
        }
        .file-input-wrapper label.btn {
            width: auto;
            padding: 10px;
            display: flex;
            margin-bottom: 20px;
        }
        .tongji {
            position: absolute; 
            top: 8px; 
            right: 12px; 
            color: var(--text3); 
            font-size: 0.8rem; 
            background: var(--white); 
            padding: 2px 4px; 
            border-radius: 4px; 
            pointer-events: none;
        }
        @media (max-width: 768px) {
            .controls { width: 320px; }

            body { padding: 0 0 150px 0; }
            .container { 
                padding-left: 0;
                flex-direction: column; 
                margin-bottom: 30px;
            }
            .controls { width: 100%; position: static;  }
            .preview { min-height: auto; }
            .footer-buttons { grid-template-columns: repeat(3, 1fr); gap: 15px; }

            .controls, .preview { padding: 20px; }
            h1 { font-size: 1.3rem; }
            .footer-buttons { grid-template-columns: repeat(2, 1fr); }
            .tab-button { padding: 10px 8px; font-size: 0.9rem; }
        }
        
    </style>
</head>
<body>
<svg width="0" height="0" class="hidden">
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="barcode-solid-full">
    <path d="M128 96C110.3 96 96 110.3 96 128L96 512C96 529.7 110.3 544 128 544C145.7 544 160 529.7 160 512L160 128C160 110.3 145.7 96 128 96zM216 96C202.7 96 192 106.7 192 120L192 520C192 533.3 202.7 544 216 544C229.3 544 240 533.3 240 520L240 120C240 106.7 229.3 96 216 96zM288 128L288 512C288 529.7 302.3 544 320 544C337.7 544 352 529.7 352 512L352 128C352 110.3 337.7 96 320 96C302.3 96 288 110.3 288 128zM496 120L496 520C496 533.3 506.7 544 520 544C533.3 544 544 533.3 544 520L544 120C544 106.7 533.3 96 520 96C506.7 96 496 106.7 496 120zM400 120L400 520C400 533.3 410.7 544 424 544C437.3 544 448 533.3 448 520L448 120C448 106.7 437.3 96 424 96C410.7 96 400 106.7 400 120z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="bold-solid-full">
    <path d="M160 96C142.3 96 128 110.3 128 128C128 145.7 142.3 160 160 160L192 160L192 480L160 480C142.3 480 128 494.3 128 512C128 529.7 142.3 544 160 544L384 544C454.7 544 512 486.7 512 416C512 369.5 487.2 328.7 450 306.3C468.7 284 480 255.3 480 224C480 153.3 422.7 96 352 96L160 96zM416 224C416 259.3 387.3 288 352 288L256 288L256 160L352 160C387.3 160 416 188.7 416 224zM256 480L256 352L384 352C419.3 352 448 380.7 448 416C448 451.3 419.3 480 384 480L256 480z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="font-solid-full">
    <path d="M349.1 114.7C343.9 103.3 332.5 96 320 96C307.5 96 296.1 103.3 290.9 114.7L123.5 480L112 480C94.3 480 80 494.3 80 512C80 529.7 94.3 544 112 544L200 544C217.7 544 232 529.7 232 512C232 494.3 217.7 480 200 480L193.9 480L215.9 432L424.2 432L446.2 480L440.1 480C422.4 480 408.1 494.3 408.1 512C408.1 529.7 422.4 544 440.1 544L528.1 544C545.8 544 560.1 529.7 560.1 512C560.1 494.3 545.8 480 528.1 480L516.6 480L349.2 114.7zM394.8 368L245.2 368L320 204.8L394.8 368z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="image-solid-full">
    <path d="M160 96C124.7 96 96 124.7 96 160L96 480C96 515.3 124.7 544 160 544L480 544C515.3 544 544 515.3 544 480L544 160C544 124.7 515.3 96 480 96L160 96zM224 176C250.5 176 272 197.5 272 224C272 250.5 250.5 272 224 272C197.5 272 176 250.5 176 224C176 197.5 197.5 176 224 176zM368 288C376.4 288 384.1 292.4 388.5 299.5L476.5 443.5C481 450.9 481.2 460.2 477 467.8C472.8 475.4 464.7 480 456 480L184 480C175.1 480 166.8 475 162.7 467.1C158.6 459.2 159.2 449.6 164.3 442.3L220.3 362.3C224.8 355.9 232.1 352.1 240 352.1C247.9 352.1 255.2 355.9 259.7 362.3L286.1 400.1L347.5 299.6C351.9 292.5 359.6 288.1 368 288.1z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="italic-solid-full">
    <path d="M256 128C256 110.3 270.3 96 288 96L480 96C497.7 96 512 110.3 512 128C512 145.7 497.7 160 480 160L421.3 160L288 480L352 480C369.7 480 384 494.3 384 512C384 529.7 369.7 544 352 544L160 544C142.3 544 128 529.7 128 512C128 494.3 142.3 480 160 480L218.7 480L352 160L288 160C270.3 160 256 145.7 256 128z"></path>
  </symbol>
</svg>
    <div class="container">
        <div class="controls">
            
            <div class="control-group">
                <div class="tabs">
                    <button class="tab-button active" onclick="showTab('manual')">手动输入</button>
                    <button class="tab-button" onclick="showTab('sequence')">序列生成</button>
                    <button class="tab-button" onclick="showTab('file')">文件导入</button>
                </div>
    <div id="manual-tab" class="tab-content active">
    <div style="position: relative;">
        <textarea id="data" placeholder="请输入条码内容，每行一条"></textarea>
        <span id="line-counter" class="tongji">已输入 0 条</span>
    </div>
</div>
                <div id="sequence-tab" class="tab-content">
                    <div class="inline-group">
                        <div><label for="seq-start" style="margin-bottom: 6px;">起始数据</label><input type="text" id="seq-start" value="0001"></div>
                        <div><label for="seq-count" style="margin-bottom: 6px;">生成数量</label><input type="number" id="seq-count" value="10"></div>
                    </div>
                    <div style="margin-top:10px;"><label for="seq-prefix" style="margin-bottom: 6px;">前缀</label><input type="text" id="seq-prefix" value="SN-"></div>
                </div>
                <div id="file-tab" class="tab-content file-input-wrapper">
                    <input type="file" id="file-input" accept=".txt,.csv">
                    <label for="file-input" class="btn btn-outline">选择 .txt 或 .csv 文件</label>
                </div>
            </div>

            <div class="heading-with-button">
                 <h2>样式设置</h2>
                 <div style="display: flex; gap: 10px;">
                     <button class="btn btn-secondary" onclick="resetStyles()">重置样式</button>
                     <button id="save-styles-btn" class="btn btn-primary">保存样式</button>
                 </div>
            </div>

            <div class="settings-group">
                <h3><svg class="icon" style="color: var(--main-color);"><use xlink:href="#barcode-solid-full"></use></svg> 条码样式</h3>
                <div class="control-group inline-control">
                    <label for="barcode-type">条码类型</label>
                    <select id="barcode-type">
                        <option value="CODE128" selected>CODE128</option><option value="CODE39">CODE39</option>
                        <option value="EAN13">EAN13</option><option value="UPC">UPC</option>
                        <option value="ITF">ITF</option><option value="MSI">MSI</option>
                    </select>
                </div>
                <div class="control-group slider-group">
                    <div class="label-row"><label for="barcode-width">宽度</label><input type="number" id="barcode-width" value="2" min="1" max="10"></div>
                    <input type="range" id="barcode-width-slider" value="2" min="1" max="10">
                </div>
                <div class="control-group slider-group">
                    <div class="label-row"><label for="barcode-height">高度</label><input type="number" id="barcode-height" value="80" min="20" max="200"></div>
                    <input type="range" id="barcode-height-slider" value="80" min="20" max="200">
                </div>
                <div class="control-group slider-group">
                    <div class="label-row"><label for="barcode-margin">条码边距</label><input type="number" id="barcode-margin" value="20" min="1" max="200"></div>
                    <input type="range" id="barcode-margin-slider" value="20" min="1" max="200">
                </div>
                <div class="control-group inline-group">
                    <div style="display: flex; align-items: center; gap: 10px;"><label for="barcode-color">条码颜色</label><input type="color" id="barcode-color" value="#1a1d2e" class="color-input"></div>
                    <div style="display: flex; align-items: center; gap: 10px;"><label for="background-color">背景颜色</label><input type="color" id="background-color" value="#ffffff" class="color-input"></div>
                </div>
            </div>

            <div class="settings-group">
                <h3><svg class="icon" style="color: var(--main-color);"><use xlink:href="#font-solid-full"></use></svg>文本样式</h3>
                <div class="control-group inline-control">
                    <label for="display-value">显示文本</label>
                    <select id="display-value">
                        <option value="true" selected>显示</option><option value="false">隐藏</option>
                    </select>
                </div>
                 <div class="control-group inline-control">
                    <label for="font-family">字体选择</label>
                    <select id="font-family">
                        <option value="sans-serif" selected>无衬线 (Sans-serif)</option>
                        <option value="serif">衬线 (Serif)</option>
                        <option value="monospace">等宽 (Monospace)</option>
                    </select>
                </div>
                <div class="control-group inline-control">
                    <label>字体样式</label>
                    <div class="font-style-buttons">
                        <button id="font-bold-btn" class="btn"><svg class="icon"><use xlink:href="#bold-solid-full"></use></svg></button>
                        <button id="font-italic-btn" class="btn"><svg class="icon"><use xlink:href="#italic-solid-full"></use></svg></button>
                    </div>
                </div>
                <div class="control-group slider-group">
                    <div class="label-row"><label for="font-size">字体大小</label><input type="number" id="font-size" value="18" min="8" max="40"></div>
                    <input type="range" id="font-size-slider" value="18" min="8" max="40">
                </div>
                <div class="control-group slider-group">
                    <div class="label-row"><label for="text-margin">文本边距</label><input type="number" id="text-margin" value="0" min="-10" max="30"></div>
                    <input type="range" id="text-margin-slider" value="0" min="-10" max="30">
                </div>
                <div class="control-group slider-group">
                    <div class="label-row"><label for="letter-spacing">字间距</label><input type="number" id="letter-spacing" value="0" min="-5" max="20"></div>
                    <input type="range" id="letter-spacing-slider" value="0" min="-5" max="20">
                </div>
            </div>
        </div>

        <div class="preview">
            <h1>批量条形码生成</h1>
            <div id="barcode-container"></div>
        </div>
    </div>
    
    <div class="action-footer">
        <div class="footer-buttons">
            <button id="zip-png-btn" class="btn btn-primary" onclick="downloadAllAsZip('png')">下载ZIP (PNG)</button>
            <button id="zip-svg-btn" class="btn btn-primary" onclick="downloadAllAsZip('svg')">下载ZIP (SVG)</button>
            <button id="pdf-btn" class="btn btn-outline" onclick="downloadAllAsPDF()">下载为PDF</button>
            <button id="excel-btn" class="btn btn-outline" onclick="downloadDataAsExcel()">下载为Excel</button>
            <button class="btn btn-secondary" onclick="clearData()">清空数据</button>
        </div>
    </div>

    <script>
        const { jsPDF } = window.jspdf;
        // --- CONFIG FOR STYLE SAVING ---
        const styleControlIds = [
            'barcode-type', 'display-value', 'barcode-width', 'barcode-height', 'barcode-margin',
            'font-size', 'text-margin', 'letter-spacing', 'barcode-color', 'background-color', 'font-family'
        ];

        // --- Setup and Initialization ---
        window.onload = () => {
            loadStyles(); // Load saved styles from cookie first
            setupSliders();
            setupEventListeners();
            generateBarcodes();
        };

        // --- Slider Synchronization ---
        function setupSliders() {
            const configs = [
                { numId: 'barcode-width', sliderId: 'barcode-width-slider' }, { numId: 'barcode-height', sliderId: 'barcode-height-slider' },
                { numId: 'barcode-margin', sliderId: 'barcode-margin-slider'},
                { numId: 'font-size', sliderId: 'font-size-slider' }, { numId: 'text-margin', sliderId: 'text-margin-slider' },
                { numId: 'letter-spacing', sliderId: 'letter-spacing-slider' }
            ];
            configs.forEach(({numId, sliderId}) => {
                const numInput = document.getElementById(numId);
                const sliderInput = document.getElementById(sliderId);
                numInput.addEventListener('input', () => { sliderInput.value = numInput.value; debounce(generateBarcodes, 200); });
                sliderInput.addEventListener('input', () => { numInput.value = sliderInput.value; debounce(generateBarcodes, 200); });
            });
        }
        
        let debounceTimer;
        function debounce(func, delay) { clearTimeout(debounceTimer); debounceTimer = setTimeout(func, delay); }

        function setupEventListeners() {
            const controlsToWatch = [
                'data', 'seq-start', 'seq-count', 'seq-prefix', 'barcode-type', 'display-value',
                'barcode-color', 'background-color', 'font-family'
            ];
            controlsToWatch.forEach(id => document.getElementById(id)?.addEventListener('input', () => debounce(generateBarcodes, 200)));
            
            ['font-bold-btn', 'font-italic-btn'].forEach(id => {
                document.getElementById(id).addEventListener('click', (e) => {
                    e.currentTarget.classList.toggle('active');
                    generateBarcodes();
                });
            });

            document.getElementById('file-input').addEventListener('change', handleFileImport);
            document.getElementById('save-styles-btn').addEventListener('click', saveStyles); // Add listener for save button
        }

        // --- SAVE AND LOAD STYLES ---
        function saveStyles() {
            const styleSettings = {};
            styleControlIds.forEach(id => {
                styleSettings[id] = document.getElementById(id).value;
            });
            // Handle non-input controls (buttons)
            styleSettings['font-bold'] = document.getElementById('font-bold-btn').classList.contains('active');
            styleSettings['font-italic'] = document.getElementById('font-italic-btn').classList.contains('active');

            // Save to cookie for 1 year
            document.cookie = `barcodeStyles=${JSON.stringify(styleSettings)};max-age=31536000;path=/`;

            const btn = document.getElementById('save-styles-btn');
            btn.textContent = '已保存!';
            setTimeout(() => { btn.textContent = '保存样式'; }, 1500);
        }

        function loadStyles() {
            try {
                const cookieString = document.cookie.split('; ').find(row => row.startsWith('barcodeStyles='));
                if (!cookieString) return;
                
                const savedStyles = JSON.parse(cookieString.split('=')[1]);
                styleControlIds.forEach(id => {
                    if (savedStyles[id] !== undefined) {
                        const el = document.getElementById(id);
                        el.value = savedStyles[id];
                        // Also update corresponding slider if it exists
                        const sliderEl = document.getElementById(`${id}-slider`);
                        if (sliderEl) sliderEl.value = savedStyles[id];
                    }
                });
                
                // Load button states
                const boldBtn = document.getElementById('font-bold-btn');
                savedStyles['font-bold'] ? boldBtn.classList.add('active') : boldBtn.classList.remove('active');
                
                const italicBtn = document.getElementById('font-italic-btn');
                savedStyles['font-italic'] ? italicBtn.classList.add('active') : italicBtn.classList.remove('active');

            } catch (e) {
                console.error("Failed to load styles from cookie:", e);
            }
        }

        let currentTab = 'manual';
        function showTab(tabName) {
            currentTab = tabName;
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');
            if (tabName !== 'file') generateBarcodes();
        }

        function handleFileImport(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById('data').value = e.target.result;
                const label = document.querySelector('.file-input-wrapper label');
                label.textContent = file.name; // Show selected file name
                showTab('manual'); generateBarcodes();
            };
            reader.readAsText(file);
        }

        function getDataLines() {
            if (currentTab === 'manual' || currentTab === 'file') {
                const data = document.getElementById('data').value.trim();
                return data ? data.split('\n').filter(line => line.trim() !== '') : [];
            }
            if (currentTab === 'sequence') {
                const start = document.getElementById('seq-start').value, count = parseInt(document.getElementById('seq-count').value, 10) || 0;
                const prefix = document.getElementById('seq-prefix').value, dataLines = [];
                const isNumeric = /^\d+$/.test(start);
                for(let i=0; i<count; i++) dataLines.push(isNumeric ? prefix+String(parseInt(start,10)+i).padStart(start.length,'0') : prefix+start+i);
                return dataLines;
            }
            return [];
        }

        function generateBarcodes() {
            const container = document.getElementById('barcode-container'), dataLines = getDataLines();
                const counterElement = document.getElementById('line-counter');
                if (counterElement) counterElement.textContent = `已输入 ${dataLines.length} 条`;
            container.innerHTML = '';
            updateButtonStates(dataLines.length > 0);
            if (dataLines.length === 0) {
                container.innerHTML = '<p class="quesheng"><svg class="icon" style="font-size: 94px; color: var(--border);"><use xlink:href="#image-solid-full"></use></svg>请在左侧输入数据或更改设置以实时生成预览。</p>'; return;
            }

            let fontOptions = '';
            if (document.getElementById('font-bold-btn').classList.contains('active')) fontOptions += 'bold ';
            if (document.getElementById('font-italic-btn').classList.contains('active')) fontOptions += 'italic';
            fontOptions = fontOptions.trim();

            const options = {
                format: document.getElementById('barcode-type').value,
                width: parseInt(document.getElementById('barcode-width').value) || 2,
                height: parseInt(document.getElementById('barcode-height').value) || 80,
                displayValue: document.getElementById('display-value').value === 'true',
                font: document.getElementById('font-family').value,
                fontOptions: fontOptions,
                textAlign: "center", // Default is center
                textPosition: "bottom",
                textMargin: parseInt(document.getElementById('text-margin').value) || 0,
                fontSize: parseInt(document.getElementById('font-size').value) || 18,
                background: document.getElementById('background-color').value,
                lineColor: document.getElementById('barcode-color').value,
                margin: parseInt(document.getElementById('barcode-margin').value) || 20
            };
            const letterSpacing = document.getElementById('letter-spacing').value;

            dataLines.forEach((line, index) => {
                const cleanLine = line.trim(), item = document.createElement('div');
                item.className = 'barcode-item';
                const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                svg.id = `barcode-${index}`; svg.dataset.value = cleanLine;
                
                // --- 全新的、更稳定的处理逻辑 ---
                
                // 1. 为本次生成创建一个可修改的选项副本
                let finalOptions = {...options};

                // 2. 如果设置了字间距，我们就接管对齐方式，强制左对齐以避免冲突
                if (letterSpacing != 0) {
                    finalOptions.textAlign = 'left';
                }

                try {
                    // 3. 使用修正后的选项，并且只调用一次JsBarcode
                    JsBarcode(svg, cleanLine, finalOptions);

                    // 4. 如果设置了字间距，执行稳定可靠的 transform 居中方案
                    if (letterSpacing != 0) {
                        const textElement = svg.querySelector('text');
                        if (textElement) {
                            textElement.style.letterSpacing = `${letterSpacing}px`;

                            // 精确计算条码区域的中心点
                            const margin = finalOptions.margin;
                            const svgWidth = svg.width.baseVal.value;
                            const barWidth = svgWidth - (2 * margin);
                            const center = barWidth / 2;

                            // 使用 transform 平移来居中，并移除冲突的 x 属性
                            textElement.setAttribute("transform", `translate(${center}, 0)`);
                            textElement.setAttribute("text-anchor", "middle");
                            textElement.removeAttribute("x");
                        }
                    }
                    
                    item.appendChild(svg);
                } catch (e) { 
                    item.innerHTML = `<p style="color:red;font-size:12px;word-break:break-all;">'${cleanLine}'生成失败</p><p style="color:red;font-size:10px;">${e.message}</p>`; 
                }
                container.appendChild(item);
            });
        }
        
        function updateButtonStates(hasData) {
            ['zip-png-btn', 'zip-svg-btn', 'pdf-btn', 'excel-btn'].forEach(id => document.getElementById(id).disabled = !hasData);
        }
        
        function getPNGDataURLFromSVG(svg) {
            return new Promise(resolve => {
                const canvas = document.createElement('canvas'), bbox = svg.getBBox();
                const scale = 2;
                canvas.width = (bbox.width + bbox.x) * scale;
                canvas.height = (bbox.height + bbox.y) * scale;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = document.getElementById('background-color').value;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                // No need to scale context, just draw image at scaled size
                const data = new XMLSerializer().serializeToString(svg);
                const img = new Image(), svgBlob = new Blob([data], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(svgBlob);
                img.onload = () => {
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height); URL.revokeObjectURL(url);
                    resolve(canvas.toDataURL('image/png'));
                };
                img.src = url;
            });
        }
        
        async function downloadAllAsPDF() {
            const svgs = Array.from(document.querySelectorAll('#barcode-container svg'));
            if (svgs.length === 0) return alert('没有条码可以下载！');
            const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            const margin = 10, itemWidth = (doc.internal.pageSize.getWidth() - 3 * margin) / 2;
            let x = margin, y = margin, rowMaxHeight = 0;

            for (let i = 0; i < svgs.length; i++) {
                const svg = svgs[i], dataURL = await getPNGDataURLFromSVG(svg);
                const aspectRatio = svg.width.baseVal.value / svg.height.baseVal.value;
                const itemHeight = itemWidth / aspectRatio;
                
                if (y + itemHeight > doc.internal.pageSize.getHeight() - margin) {
                    doc.addPage(); x = margin; y = margin; rowMaxHeight = 0;
                }
                
                doc.addImage(dataURL, 'PNG', x, y, itemWidth, itemHeight);
                rowMaxHeight = Math.max(rowMaxHeight, itemHeight);

                if ((i + 1) % 2 === 0) {
                    x = margin; 
                    y += rowMaxHeight + margin;
                    rowMaxHeight = 0;
                } else {
                    x += itemWidth + margin; 
                }
            }
            doc.save('barcodes.pdf');
        }

        async function downloadAllAsZip(format) {
            const svgs = Array.from(document.querySelectorAll('#barcode-container svg'));
            if (svgs.length === 0) return alert('没有条码可以下载！');
            const zip = new JSZip(), btn = document.getElementById(`zip-${format}-btn`), originalText = btn.textContent;
            btn.textContent = '压缩中...'; btn.disabled = true;
            if (format === 'svg') {
                svgs.forEach(svg => zip.file(`${svg.dataset.value || 'barcode'}.svg`, new XMLSerializer().serializeToString(svg)));
            } else if (format === 'png') {
                const promises = svgs.map(async svg => ({
                    name: `${svg.dataset.value || 'barcode'}.png`,
                    blob: await fetch(await getPNGDataURLFromSVG(svg)).then(res => res.blob())
                }));
                for (const file of await Promise.all(promises)) zip.file(file.name, file.blob);
            }
            const content = await zip.generateAsync({ type: "blob" });
            saveAs(content, `barcodes-${format}.zip`);
            btn.textContent = originalText; btn.disabled = false;
        }

        // 关键改动2：全新的、支持图片的Excel导出函数
        async function downloadDataAsExcel() {
            const svgs = Array.from(document.querySelectorAll('#barcode-container svg'));
            if (svgs.length === 0) return alert('没有可下载的数据！');
            
            const btn = document.getElementById('excel-btn');
            const originalText = btn.innerHTML; // 保存原始按钮内容
            btn.textContent = '生成中...';
            btn.disabled = true;

            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('Barcodes');

            // 设置列宽
            worksheet.getColumn('A').width = 30; // 文本列
            worksheet.getColumn('B').width = 40; // 图片列

            // 添加表头
            worksheet.getRow(1).values = ['条码文本', '条形码'];
            worksheet.getRow(1).font = { bold: true };

            for (let i = 0; i < svgs.length; i++) {
                const svg = svgs[i];
                const text = svg.dataset.value || '';
                const rowNumber = i + 2; // Excel行号从1开始，第1行是表头

                // 1. 添加文本数据
                worksheet.getCell(`A${rowNumber}`).value = text;
                worksheet.getCell(`A${rowNumber}`).alignment = { vertical: 'middle' };

                // 2. 转换SVG为PNG
                const pngDataUrl = await getPNGDataURLFromSVG(svg);
                
                // 3. 将PNG添加到工作簿
                const imageId = workbook.addImage({
                    base64: pngDataUrl,
                    extension: 'png',
                });

                // 4. 将图片插入到单元格
                worksheet.addImage(imageId, {
                    // tl = top-left corner, br = bottom-right corner
                    tl: { col: 1, row: rowNumber - 1 }, // col从0开始, row从0开始
                    ext: { width: 250, height: 100 }
                });
                
                // 5. 设置行高以适应图片
                worksheet.getRow(rowNumber).height = 80;
            }

            // 生成并下载文件
            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            saveAs(blob, 'barcodes-with-images.xlsx');
            
            btn.innerHTML = originalText; // 恢复按钮内容
            btn.disabled = false;
        }

        function clearData() {
            document.getElementById('data').value = '';
            document.getElementById('file-input').value = '';
            document.querySelector('.file-input-wrapper label').textContent = '选择 .txt 或 .csv 文件';
            generateBarcodes();
        }
        function resetStyles() {
            // This function now resets to default values, ignoring cookies.
            document.getElementById('barcode-type').value = 'CODE128'; 
            document.getElementById('display-value').value = 'true';
            document.getElementById('barcode-width').value = 2;
            document.getElementById('barcode-height').value = 80;
            document.getElementById('barcode-margin').value = 20;
            document.getElementById('barcode-color').value = '#1a1d2e'; 
            document.getElementById('background-color').value = '#ffffff';
            document.getElementById('font-family').value = 'sans-serif';
            document.getElementById('font-bold-btn').classList.remove('active');
            document.getElementById('font-italic-btn').classList.remove('active');
            document.getElementById('font-size').value = 18;
            document.getElementById('text-margin').value = 0;
            document.getElementById('letter-spacing').value = 0;
            
            // Manually update all sliders to match the reset values
            setupSliders(); // Re-sync sliders and inputs
            styleControlIds.forEach(id => {
                const sliderEl = document.getElementById(`${id}-slider`);
                if(sliderEl) sliderEl.value = document.getElementById(id).value;
            });

            generateBarcodes();
        }
    </script>
</body>
</html>