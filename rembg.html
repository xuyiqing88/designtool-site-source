<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>AI一键抠图工具 - 在线免费去除图片背景 | 支持批量抠图</title>
  <script src="menu.js" defer></script>
  <link rel="icon" href="img/gongjuxiang.svg" type="image/svg">
  <script defer src="https://cloud.umami.is/script.js" data-website-id="5a2e10cd-bf73-47df-be48-079c9ba7783c" data-domains="designtool.site"></script>

  <style>
    :root {
      --main-color: #5a64ff;
      --btcolor: linear-gradient(113deg, #6472ff, #8352ff);
      --text1: #1a1d2e;
      --text2: #4a4e6d;
      --text3: #8d8fa3;
      --light: #f8f9fa;
      --dark: #212529;
      --success: #33b763;
      --danger: #f72585;
      --border-radius: 10px;
      --box-shadow: 0 4px 20px rgba(90, 100, 255, 0.12);
      --transition: all 0.3s ease;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
	    display: flex;
  	  flex-direction: column;
  	  justify-content: center;
      color: var(--text1);
      position: relative;
	    background-color: #f5f7ff;
    }
.icon {
    display: inline-block;
    width: 1.2em;
    height: 1.2em;
    fill: currentColor;
}
@keyframes spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

.spinning-icon {
  animation: spin 1s linear infinite;
}
    /* 新增：加载蒙版样式 */
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: 10000;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      padding: 20px;
      text-align: center;
      transition: opacity 0.5s ease;
    }
    #loading-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .loading-content h2 {
      color: var(--main-color);
      margin-bottom: 15px;
    }
    .loading-content p {
      color: var(--text2);
      line-height: 1.6;
      font-size: 0.95rem;
      margin-bottom: 25px;
    }
    .loading-progress-bar-container {
      width: 100%;
      height: 12px;
      background-color: #e9ecef;
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 10px;
    }
    .loading-progress-bar {
      width: 0%;
      height: 100%;
      background: var(--btcolor);
      transition: width 0.2s ease;
    }
    .loading-status {
      font-size: 0.9rem;
      color: var(--text3);
    }
    #loading-error {
      color: var(--danger);
      margin-top: 20px;
      font-weight: bold;
    }

    .download-all-container {
	    text-align: center;
      padding: 10px;
      position: fixed;
      bottom: 0;
      background: #ffffff52;
      margin: 0 auto;
      left: 0;
      right: 0;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.05);
	    z-index: 2;
	  }
    .container {
      width: 1200px;
      margin: 0 auto;
      padding: 20px 0;
    }
    
    header {
      text-align: center;
      padding: 20px;
    }
    
    h1 {
      color: var(--main-color);
      margin-bottom: 10px;
      font-size: 1.8rem;
    }
    
    .subtitle {
      color: var(--text3);
      font-size: 0.9rem;
      max-width: 700px;
      margin: 0 auto 15px;
    }
    
    .app-container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      margin-bottom: 60px;
    }
    
    
    .panel {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 25px;
      transition: var(--transition);
      min-height: -webkit-fill-available;
      position: relative;
    }

    
    .panel-title {
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text1);
      margin-bottom: 20px;
      font-size: 1.2rem;
      position: relative;
    }
    
    .panel-title svg {
      font-size: 1.2rem;
    }
    
    .upload-area {
      border: 2px dashed #dee2e6;
      border-radius: var(--border-radius);
      padding: 30px 20px;
      text-align: center;
      background: #f8f9fa;
      cursor: pointer;
      transition: var(--transition);
      margin: 20px 0;
      position: relative;
    }
    
    .upload-area:hover, .upload-area.drag-over {
      border-color: var(--main-color);
      background: rgba(90, 100, 255, 0.05);
    }
    
    .upload-area svg {
      font-size: 40px;
      background: var(--main-color);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
	    opacity: 0.4;
    }
    .upload-area i:hover {
	    opacity: 1;
    }
    .upload-area h3 {
      margin-bottom: 10px;
      color: var(--text1);
      font-weight: 600;
    }
    
    .upload-area p {
      color: var(--text3);
      font-size: 0.95rem;
    }
    
    #file-input {
      display: none;
    }
    
    .btn {
      display: inline-block;
      background: var(--btcolor);
      color: white;
      padding: 10px 90px;
      border-radius: 50px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      text-align: center;
      font-size: 1rem;
      box-shadow: 0 4px 12px rgba(90, 100, 255, 0.3);
      margin: 10px auto;
	    display: flex;
    }
    
    .btn:hover {
      background: linear-gradient(113deg, #3c63e6, #5a42e6);
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(90, 100, 255, 0.4);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn svg {
      margin-right: 8px;
    }
    
    .btn-secondary {
      background: #f0f2f5;
      color: var(--text1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    .btn-secondary:hover {
      background: #e4e7eb;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
    }
    
.btn:disabled {
  background: linear-gradient(113deg, #c5c7db, #b4afc2);
  cursor: not-allowed;
  box-shadow: none;
  transform: none;
}

/* 确保旋转图标在禁用状态下仍然旋转 */
.btn:disabled .spinning-icon {
  animation: spin 1s linear infinite;
}

.btn:disabled:hover {
  transform: none;
}
    .image-preview-container {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin: 20px 0 40px 0;
      justify-content: flex-start;
    }
    
    .image-card {
      background: var(--light);
      border-radius: var(--border-radius);
      overflow: hidden;
      width: 100%;
      max-width: 100%;
      transition: var(--transition);
      display: flex;
      align-items: center;
      padding: 10px;
      gap: 15px;
    }
    
    .image-card:hover {
	    background: #5a64ff1a;
    }
    
    .image-wrapper {
      position: relative;
      width: 60px;
      height: 60px;
      overflow: hidden;
      background: #f8f9fa;
      border-radius: 8px;
      flex-shrink: 0;
    }
    
    .image-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .image-meta {
      flex-grow: 1;
	    width: 70%
    }
    
    .image-name {
      font-weight: 600;
      margin-bottom: 5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--text1);
      font-size: 0.95rem;
    }
    
    .image-status {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85rem;
      color: var(--text3);
    }
    
    .status-indicator {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }
    
    .status-queued {
      background: #ffb703;
    }
    
    .status-processing {
      background: var(--main-color);
      animation: pulse 1.5s infinite;
    }
    
    .status-completed {
      background: #2ec4b6;
    }
    
    .status-error {
      background: var(--danger);
    }
    
    .progress-container {
      width: 100%;
      height: 8px;
      background: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
      margin: 15px 0;
    }
    
    .progress-bar {
      height: 100%;
      background: var(--success);
      border-radius: 4px;
      width: 0%;
      transition: width 0.3s ease;
    }
    
    .results-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
      margin: 15px 0;
      min-height: 300px;
      position: relative;
    }
    @media (max-width: 768px) {
	    .container {    width: 100%; }
      .panel {
        padding: 16px;
	      width: 100vw;
      }
  
      .results-container {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      }
      
      .btn {
        padding: 10px 60px;
        font-size: 0.9rem;
      }
	  }  
    @media (min-width: 768px) {
      .results-container {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      }
      .app-container {
        grid-template-columns: 40% 60%;
        align-items: stretch;
      }
    }
    .result-item {
      display: flex;
      flex-direction: column;
      position: relative;
      border-radius: var(--border-radius);
      overflow: hidden;
    }
    
    .preview-container {
      position: relative;
      width: 100%;
      aspect-ratio: 1/1;
      background: 
        linear-gradient(45deg, #f0f0f0 25%, transparent 25%, transparent 75%, #f0f0f0 75%),
        linear-gradient(45deg, #f0f0f0 25%, transparent 25%, transparent 75%, #f0f0f0 75%);
      background-size: 20px 20px;
      background-position: 0 0, 10px 10px;
      border-radius: 10px 10px 0 0;
      overflow: hidden;
    }
    
    .preview-container img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      cursor: pointer;
      transition: transform 0.3s ease;
    }
    
    .preview-container img:hover {
      transform: scale(1.05);
    }
    
    .download-bt {
      position: absolute;
      bottom: 10px;
      right: 10px;
      width: 32px;
      height: 32px;
      background: #00000054;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 2;
    }
    
    .download-bt:hover {
      background: #000000a1;
      transform: scale(1.1);
    }
    
    .image-name-result {
      padding: 12px 8px;
      font-size: 0.8rem;
      color: var(--text2);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-align: center;
	    background: var(--light);
	    border-radius: 0 0 10px 10px;
    }
    
    .panel-header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .panel-title {
      margin-bottom: 0;
      flex: 1;
      min-width: 120px;
    }
    
    .progress-header {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #f0f2f5;
      padding: 8px 15px;
      border-radius: 50px;
      font-size: 0.9rem;
      color: var(--text2);
      order: 1;
      flex: 0 0 auto;
    }
    
    .clear-btn {
      background: #f8f9fa;
      color: var(--text2);
      border: none;
      border-radius: 50px;
      padding: 8px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 6px;
      flex: 0 0 auto;
      order: 2;
    }
    
    .clear-btn:hover {
      background: #e9ecef;
      color: var(--text1);
    }
    
    .header-progress {
      height: 6px;
      width: 100px;
      background: #cdced7;
      border-radius: 3px;
      overflow: hidden;
    }
    
    .header-progress-bar {
      height: 100%;
      background: var(--success);
      border-radius: 3px;
      width: 0%;
      transition: width 0.3s ease;
    }
        
    .hidden {
      display: none;
    }
    
    footer {
      text-align: center;
      margin-top: 40px;
      color: var(--text3);
      font-size: 0.9rem;
      padding: 20px;
    }
    
    .batch-download-btn {
      width: 200px;
      height: 48px;
      background: var(--btcolor);
      color: white;
      border-radius: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      cursor: pointer;
      box-shadow: 0 6px 15px rgba(90, 100, 255, 0.4);
      z-index: 100;
      transition: all 0.3s ease;
      transform: translateY(10px);
      opacity: 0;
      pointer-events: none;
	    margin: 0 auto;
	    gap: 8px;
    }
    
    .batch-download-btn.visible {
      transform: translateY(0);
      opacity: 1;
      pointer-events: all;
    }
    
    .batch-download-btn:hover {
      transform: scale(1.05) translateY(0);
      box-shadow: 0 8px 20px rgba(90, 100, 255, 0.5);
    }
    
    .empty-state {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      width: 100%;
      max-width: 300px;
      padding: 20px;
      z-index: 1;
      display: flex;
    flex-direction: column;
    align-items: center;
    }
    
    .empty-state svg {
      font-size: 5rem;
      color: #dee2e6;
      margin-bottom: 20px;
      display: block;
    }
    
    .empty-state h3 {
      color: var(--text2);
      margin-bottom: 10px;
    }
    
    .empty-state p {
      color: var(--text3);
      font-size: 0.95rem;
    }
    
    @keyframes pulse {
      0% { opacity: 0.6; }
      50% { opacity: 1; }
      100% { opacity: 0.6; }
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    .modal.active {
      opacity: 1;
      pointer-events: all;
    }
    
    .modal-content {
      max-width: 90%;
      max-height: 90%;
      position: relative;
    }
    
    .modal-content img {
      max-width: 100%;
      max-height: 80vh;
      border-radius: 8px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
    }
    
    .close-modal {
      position: absolute;
      top: 15px;
      right: 15px;
      background: rgba(255, 255, 255, 0.9);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.2rem;
      color: var(--text1);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }
    
    .close-modal:hover {
      background: white;
    }
    
    .delete-btn {
      background: transparent;
      border: none;
      color: var(--text3);
      cursor: pointer;
      font-size: 1.1rem;
      transition: color 0.2s ease;
      padding: 5px;
    }
    
    .delete-btn:hover {
      color: var(--danger);
    }
  </style>
</head>
<body>
<svg width="0" height="0" class="hidden">
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="cloud-arrow-up-solid-full">
    <path d="M176 544C96.5 544 32 479.5 32 400C32 336.6 73 282.8 129.9 263.5C128.6 255.8 128 248 128 240C128 160.5 192.5 96 272 96C327.4 96 375.5 127.3 399.6 173.1C413.8 164.8 430.4 160 448 160C501 160 544 203 544 256C544 271.7 540.2 286.6 533.5 299.7C577.5 320 608 364.4 608 416C608 486.7 550.7 544 480 544L176 544zM337 255C327.6 245.6 312.4 245.6 303.1 255L231.1 327C221.7 336.4 221.7 351.6 231.1 360.9C240.5 370.2 255.7 370.3 265 360.9L296 329.9L296 432C296 445.3 306.7 456 320 456C333.3 456 344 445.3 344 432L344 329.9L375 360.9C384.4 370.3 399.6 370.3 408.9 360.9C418.2 351.5 418.3 336.3 408.9 327L336.9 255z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="download-solid-full">
    <path d="M352 96C352 78.3 337.7 64 320 64C302.3 64 288 78.3 288 96L288 306.7L246.6 265.3C234.1 252.8 213.8 252.8 201.3 265.3C188.8 277.8 188.8 298.1 201.3 310.6L297.3 406.6C309.8 419.1 330.1 419.1 342.6 406.6L438.6 310.6C451.1 298.1 451.1 277.8 438.6 265.3C426.1 252.8 405.8 252.8 393.3 265.3L352 306.7L352 96zM160 384C124.7 384 96 412.7 96 448L96 480C96 515.3 124.7 544 160 544L480 544C515.3 544 544 515.3 544 480L544 448C544 412.7 515.3 384 480 384L433.1 384L376.5 440.6C345.3 471.8 294.6 471.8 263.4 440.6L206.9 384L160 384zM464 440C477.3 440 488 450.7 488 464C488 477.3 477.3 488 464 488C450.7 488 440 477.3 440 464C440 450.7 450.7 440 464 440z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="image-solid-full">
    <path d="M160 96C124.7 96 96 124.7 96 160L96 480C96 515.3 124.7 544 160 544L480 544C515.3 544 544 515.3 544 480L544 160C544 124.7 515.3 96 480 96L160 96zM224 176C250.5 176 272 197.5 272 224C272 250.5 250.5 272 224 272C197.5 272 176 250.5 176 224C176 197.5 197.5 176 224 176zM368 288C376.4 288 384.1 292.4 388.5 299.5L476.5 443.5C481 450.9 481.2 460.2 477 467.8C472.8 475.4 464.7 480 456 480L184 480C175.1 480 166.8 475 162.7 467.1C158.6 459.2 159.2 449.6 164.3 442.3L220.3 362.3C224.8 355.9 232.1 352.1 240 352.1C247.9 352.1 255.2 355.9 259.7 362.3L286.1 400.1L347.5 299.6C351.9 292.5 359.6 288.1 368 288.1z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="trash-solid-full">
    <path d="M232.7 69.9L224 96L128 96C110.3 96 96 110.3 96 128C96 145.7 110.3 160 128 160L512 160C529.7 160 544 145.7 544 128C544 110.3 529.7 96 512 96L416 96L407.3 69.9C402.9 56.8 390.7 48 376.9 48L263.1 48C249.3 48 237.1 56.8 232.7 69.9zM512 208L128 208L149.1 531.1C150.7 556.4 171.7 576 197 576L443 576C468.3 576 489.3 556.4 490.9 531.1L512 208z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="spinner-solid-full">
    <path d="M272 112C272 85.5 293.5 64 320 64C346.5 64 368 85.5 368 112C368 138.5 346.5 160 320 160C293.5 160 272 138.5 272 112zM272 528C272 501.5 293.5 480 320 480C346.5 480 368 501.5 368 528C368 554.5 346.5 576 320 576C293.5 576 272 554.5 272 528zM112 272C138.5 272 160 293.5 160 320C160 346.5 138.5 368 112 368C85.5 368 64 346.5 64 320C64 293.5 85.5 272 112 272zM480 320C480 293.5 501.5 272 528 272C554.5 272 576 293.5 576 320C576 346.5 554.5 368 528 368C501.5 368 480 346.5 480 320zM139 433.1C157.8 414.3 188.1 414.3 206.9 433.1C225.7 451.9 225.7 482.2 206.9 501C188.1 519.8 157.8 519.8 139 501C120.2 482.2 120.2 451.9 139 433.1zM139 139C157.8 120.2 188.1 120.2 206.9 139C225.7 157.8 225.7 188.1 206.9 206.9C188.1 225.7 157.8 225.7 139 206.9C120.2 188.1 120.2 157.8 139 139zM501 433.1C519.8 451.9 519.8 482.2 501 501C482.2 519.8 451.9 519.8 433.1 501C414.3 482.2 414.3 451.9 433.1 433.1C451.9 414.3 482.2 414.3 501 433.1z"> </path>
  </symbol> 
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" id="xmark-solid-full">
    <path d="M183.1 137.4C170.6 124.9 150.3 124.9 137.8 137.4C125.3 149.9 125.3 170.2 137.8 182.7L275.2 320L137.9 457.4C125.4 469.9 125.4 490.2 137.9 502.7C150.4 515.2 170.7 515.2 183.2 502.7L320.5 365.3L457.9 502.6C470.4 515.1 490.7 515.1 503.2 502.6C515.7 490.1 515.7 469.8 503.2 457.3L365.8 320L503.1 182.6C515.6 170.1 515.6 149.8 503.1 137.3C490.6 124.8 470.3 124.8 457.8 137.3L320.5 274.7L183.1 137.4z"></path>
  </symbol>
</svg>
<div id="loading-overlay">
  <div class="loading-content">
    <h2>正在准备AI模型，请稍候...</h2>
    <p>
      首次访问需要下载约30MB的模型文件到浏览器，加载后便可长久使用，无需再次下载。<br>
      <strong>建议使用稳定网络或科学上网</strong>以获得更快的加载速度。
    </p>
    <div class="loading-progress-bar-container">
      <div class="loading-progress-bar" id="loading-progress-bar"></div>
    </div>
    <div class="loading-status" id="loading-status">正在初始化...</div>
    <div id="loading-error" class="hidden"></div>
  </div>
</div>

<div id="global-sidebar"></div>
  <div class="container">
    <header>
      <h1>AI一键抠图（支持批量）</h1>
      <p class="subtitle">无需上传云端，在浏览器中直接处理（首次使用需要加载30MB的模型）</p>
    </header>
    
    <div class="app-container">
      <div class="panel">
        <h2 class="panel-title"> 上传图片</h2>
        
        <div class="upload-area" id="drop-area">
          <svg class="icon"><use xlink:href="#cloud-arrow-up-solid-full"></use></svg>
          <h3>拖放图片到此处或点击上传</h3>
          <p>支持 JPG, PNG, WEBP 格式 | 单次最多处理 10 张图片</p>
          <input type="file" id="file-input" accept="image/*" multiple>
        </div>
        
        <button id="process-btn" class="btn" disabled>
          开始抠图
        </button>
        
        <div class="image-preview-container" id="preview-container">
          </div>
      </div>
      
      <div class="panel">
        <div class="panel-header-container">
          <h2 class="panel-title"> 抠图结果</h2>
          <div class="progress-header">
            <span id="completed-count-header">0</span>/<span id="total-count-header">0</span>
            <div class="header-progress">
              <div class="header-progress-bar" id="header-progress-bar"></div>
            </div>
          </div>
          <button class="clear-btn" id="clear-btn">
            <svg class="icon"><use xlink:href="#trash-solid-full"></use></svg>清空
          </button>
        </div>
        
        <div class="results-container" id="results-container">
          <div class="empty-state">
            <svg class="icon"><use xlink:href="#image-solid-full"></use></svg>
            <h3>暂无处理结果</h3>
            <p>上传图片并点击"开始抠图"</p>
          </div>
        </div>
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3983418855272291"
             crossorigin="anonymous"></script>
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-format="fluid"
             data-ad-layout-key="-hq-18-1y-3r+o2"
             data-ad-client="ca-pub-3983418855272291"
             data-ad-slot="1924175279"></ins>
        <script>
             (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      </div>
    </div>
    
    <div class="download-all-container">
	    <div class="batch-download-btn" id="batch-download">
        <svg class="icon"><use xlink:href="#download-solid-full"></use></svg>下载全部
	    </div>
    </div>
  </div>

  <div class="modal" id="image-modal">
    <div class="modal-content">
      <img id="modal-image" src="" alt="预览图">
      <div class="close-modal">
       <svg class="icon"><use xlink:href="#xmark-solid-full"></use></svg>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.17.1/dist/ort.min.js"></script>
  <script>
    // 设置从 CDN 自动加载 .wasm 文件
    ort.env.wasm.wasmPaths = 'https://cdn.jsdelivr.net/npm/onnxruntime-web@1.17.1/dist/';
    ort.env.wasm.numThreads = 1;

    // DOM 元素
    const fileInput = document.getElementById('file-input');
    const dropArea = document.getElementById('drop-area');
    const processBtn = document.getElementById('process-btn');
    const batchDownload = document.getElementById('batch-download');
    const previewContainer = document.getElementById('preview-container');
    const resultsContainer = document.getElementById('results-container');
    const completedCountHeader = document.getElementById('completed-count-header');
    const totalCountHeader = document.getElementById('total-count-header');
    const headerProgressBar = document.getElementById('header-progress-bar');
    const clearBtn = document.getElementById('clear-btn');
    const modal = document.getElementById('image-modal');
    const modalImage = document.getElementById('modal-image');
    const closeModal = document.querySelector('.close-modal');

    // 新增：加载蒙版相关DOM
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingProgressBar = document.getElementById('loading-progress-bar');
    const loadingStatus = document.getElementById('loading-status');
    const loadingError = document.getElementById('loading-error');

    let session = null; // 模型会话
    let files = []; // 存储用户选择的文件
    let processedFiles = []; // 存储处理后的文件

    // ========= 新增：模型加载与缓存逻辑 =========
    async function loadModelWithProgress() {
      // 【重要】请将下面的URL替换为您自己R2桶中u2netp.onnx文件的真实公开URL
const modelUrl = 'https://pub-c502804539294926b0c4f69f7b7faf38.r2.dev/u2netp.onnx';
      const cacheName = 'rembg-model-cache-v1';

      try {
        const cache = await caches.open(cacheName);
        const cachedResponse = await cache.match(modelUrl);

        let modelBuffer;

        if (cachedResponse) {
          // 从缓存加载
          loadingStatus.textContent = '从缓存加载模型...';
          modelBuffer = await cachedResponse.arrayBuffer();
          loadingProgressBar.style.width = '100%';
          loadingStatus.textContent = `加载完成 (来自缓存)`;
        } else {
          // 从网络加载并显示进度
          loadingStatus.textContent = '开始下载模型...';
          const response = await fetch(modelUrl);
          if (!response.ok) {
            throw new Error(`模型下载失败: ${response.status} ${response.statusText}`);
          }

          const contentLength = response.headers.get('content-length');
          if (!contentLength) {
            console.warn("无法获取Content-Length，无法显示下载进度。");
            modelBuffer = await response.arrayBuffer();
          } else {
            const total = parseInt(contentLength, 10);
            let loaded = 0;
            
            const reader = response.body.getReader();
            const chunks = [];
            while(true) {
              const { done, value } = await reader.read();
              if (done) {
                break;
              }
              chunks.push(value);
              loaded += value.length;
              const progress = Math.round((loaded / total) * 100);
              loadingProgressBar.style.width = `${progress}%`;
              loadingStatus.textContent = `下载中... ${formatFileSize(loaded)} / ${formatFileSize(total)}`;
            }

            modelBuffer = new Blob(chunks).arrayBuffer();

            // 将下载的响应存入缓存
            const responseToCache = new Response(new Blob(chunks), {
              headers: response.headers
            });
            await cache.put(modelUrl, responseToCache);
          }
        }
        
        loadingStatus.textContent = '正在创建AI会话...';
        session = await ort.InferenceSession.create(await modelBuffer);

        // 成功加载后，隐藏蒙版
        setTimeout(() => {
          loadingOverlay.classList.add('hidden');
        }, 500);

      } catch (error) {
        console.error('模型加载或初始化失败:', error);
        loadingError.textContent = `错误: ${error.message}。请检查网络连接，或在域名前缀加入"https://"后重试。`;
        loadingError.classList.remove('hidden');
      }
    }
    // ========= 模型加载逻辑结束 =========
    

    // 初始化事件监听器
    function initEventListeners() {
      dropArea.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', handleFileSelect);
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
      });
      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }
      ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, () => dropArea.classList.add('drag-over'), false);
      });
      ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, () => dropArea.classList.remove('drag-over'), false);
      });
      dropArea.addEventListener('drop', handleDrop, false);
      processBtn.addEventListener('click', processImages);
      batchDownload.addEventListener('click', downloadAllResults);
      clearBtn.addEventListener('click', clearResults);
      closeModal.addEventListener('click', () => modal.classList.remove('active'));
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.classList.remove('active');
      });
    }

    function handleFileSelect(e) {
      const selectedFiles = e.target.files;
      if (selectedFiles.length > 0) addFiles(selectedFiles);
    }

    function handleDrop(e) {
      const droppedFiles = e.dataTransfer.files;
      if (droppedFiles.length > 0) addFiles(droppedFiles);
    }

    function addFiles(fileList) {
      const maxFiles = 10;
      const remainingSlots = maxFiles - files.length;
      if (remainingSlots <= 0) {
        alert(`最多只能处理${maxFiles}张图片`);
        return;
      }
      const newFiles = Array.from(fileList).slice(0, remainingSlots);
      newFiles.forEach(file => {
        if (file.type.match('image.*')) {
          files.push(file);
          createPreviewCard(file);
        }
      });
      updateBatchInfo();
      // 改动：仅当有文件且模型已加载时才启用按钮
      if (session) {
        processBtn.disabled = files.length === 0;
      }
      fileInput.value = '';
    }

    function createPreviewCard(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const card = document.createElement('div');
        card.className = 'image-card';
        card.dataset.filename = file.name;
        card.innerHTML = `
          <div class="image-wrapper"><img src="${e.target.result}" alt="${file.name}"></div>
          <div class="image-meta">
            <div class="image-name">${file.name}</div>
            <div class="image-status">
              <span class="status-indicator">
                <span class="status-dot status-queued"></span>
                <span>等待处理</span>
              </span>
              <span>${formatFileSize(file.size)}</span>
            </div>
          </div>
          <button class="delete-btn" data-filename="${file.name}"> <svg class="icon"><use xlink:href="#xmark-solid-full"></use></svg></button>
        `;
        previewContainer.appendChild(card);
        const deleteBtn = card.querySelector('.delete-btn');
        deleteBtn.addEventListener('click', () => {
          removeFile(file.name);
          card.remove();
        });
      };
      reader.readAsDataURL(file);
    }

    function removeFile(filename) {
      files = files.filter(file => file.name !== filename);
      updateBatchInfo();
      // 改动：仅当有文件且模型已加载时才启用按钮
      if (session) {
        processBtn.disabled = files.length === 0;
      }
    }

    function updateBatchInfo() {
      const total = files.length;
      const completed = processedFiles.length; // 使用 processedFiles 数组长度更准确
      totalCountHeader.textContent = total;
      completedCountHeader.textContent = completed;
      const progress = total > 0 ? Math.round((completed / total) * 100) : 0;
      headerProgressBar.style.width = `${progress}%`;
      batchDownload.classList.toggle('visible', completed === total && total > 0);
    }

    async function processImages() {
      if (!session) {
        alert('模型尚未准备好，请稍等片刻。');
        return;
      }
      if (files.length === 0) return;
      
      processBtn.disabled = true;
      processBtn.innerHTML = '<svg class="icon spinning-icon"><use xlink:href="#spinner-solid-full"></use></svg> 处理中...';

      // --- 修改开始：将抠图循环放入setTimeout，以确保动画能够渲染 ---
      setTimeout(async () => {
        const filesToProcess = files.filter(f => !processedFiles.some(pf => pf.file.name === f.name));
        
        for (const file of filesToProcess) {
          const card = document.querySelector(`.image-card[data-filename="${file.name}"]`);
          if (card) {
            const statusDot = card.querySelector('.status-dot');
            const statusText = card.querySelector('.status-indicator span:last-child');
            statusDot.className = 'status-dot status-processing';
            statusText.textContent = '处理中';
            
            try {
              const processedImage = await processSingleImage(file);
              processedFiles.push({ file: file, result: processedImage });
              statusDot.className = 'status-dot status-completed';
              statusText.textContent = '已完成';
              displayResult(file, processedImage);
            } catch (error) {
              console.error(`图片处理失败: ${file.name}`, error);
              statusDot.className = 'status-dot status-error';
              statusText.textContent = '处理失败';
            }
            updateBatchInfo();
          }
        }
        
        resetProcessButton();
      }, 0); // 使用0毫秒延迟，将任务推到下一个事件循环
      // --- 修改结束 ---
    }

    function resetProcessButton() {
      processBtn.disabled = files.length === 0;
      // --- 修改开始：移除SVG图标，只保留文字 ---
      processBtn.innerHTML = '开始抠图';
      // --- 修改结束 ---
    }
    async function processSingleImage(file) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.src = URL.createObjectURL(file);
        img.onload = async () => {
          try {
            const width = img.width;
            const height = img.height;
            const inputTensor = imageToTensor(img);
            const inputName = session.inputNames[0];
            const feeds = { [inputName]: inputTensor };
            const results = await session.run(feeds);
            const outputData = results[session.outputNames[0]].data;
            const resizedMask = resizeMask(outputData, 320, width, height); 
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            const imgData = ctx.getImageData(0, 0, width, height);
            const data = imgData.data;
            for (let i = 0; i < width * height; i++) {
              data[i * 4 + 3] = Math.floor(resizedMask[i] * 255);
            }
            ctx.putImageData(imgData, 0, 0);
            canvas.toBlob(blob => resolve(URL.createObjectURL(blob)), 'image/png');
          } catch (error) {
            reject(error);
          }
        };
        img.onerror = () => reject(new Error('图片加载失败'));
      });
    }

    function displayResult(file, resultUrl) {
      const emptyState = resultsContainer.querySelector('.empty-state');
      if (emptyState) emptyState.remove();
      const resultItem = document.createElement('div');
      resultItem.className = 'result-item';
      resultItem.innerHTML = `
        <div class="preview-container">
          <img src="${resultUrl}" alt="${file.name} - 抠图结果">
          <div class="download-bt" data-url="${resultUrl}" data-filename="${file.name}">
            <svg class="icon"> <use xlink:href="#download-solid-full"></use></svg>
          </div>
        </div>
        <div class="image-name-result">${file.name}</div>
      `;
      resultsContainer.appendChild(resultItem);
      const downloadBtn = resultItem.querySelector('.download-bt');
      downloadBtn.addEventListener('click', (e) => {
        const url = e.currentTarget.dataset.url;
        const filename = e.currentTarget.dataset.filename || 'no-bg.png';
        downloadImage(url, filename);
      });
      const img = resultItem.querySelector('img');
      img.addEventListener('click', () => {
        modalImage.src = resultUrl;
        modal.classList.add('active');
      });
    }

    function downloadImage(url, filename) {
      const a = document.createElement('a');
      a.href = url;
      a.download = filename.replace(/\.[^/.]+$/, "") + '-nobg.png';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    function downloadAllResults() {
      processedFiles.forEach(file => {
        downloadImage(file.result, file.file.name);
      });
    }

    function clearResults() {
      resultsContainer.innerHTML = `
        <div class="empty-state">
          <svg class="icon"><use xlink:href="#image-solid-full"></use></svg>
          <h3>暂无处理结果</h3>
          <p>上传图片并点击"开始批量抠图"按钮处理图片</p>
        </div>
      `;
      processedFiles = [];
      updateBatchInfo(); // 更新头部计数和下载按钮状态
    }

    function imageToTensor(img, size = 320) {
      const canvas = document.createElement('canvas');
      canvas.width = size;
      canvas.height = size;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, size, size);
      const imgData = ctx.getImageData(0, 0, size, size).data;
      const float32Data = new Float32Array(size * size * 3);
      for (let i = 0; i < size * size; i++) {
        float32Data[i] = imgData[i * 4] / 255;
        float32Data[i + size * size] = imgData[i * 4 + 1] / 255;
        float32Data[i + size * size * 2] = imgData[i * 4 + 2] / 255;
      }
      return new ort.Tensor('float32', float32Data, [1, 3, size, size]);
    }

    function resizeMask(mask, fromSize, toW, toH) {
      const canvas = document.createElement('canvas');
      canvas.width = fromSize;
      canvas.height = fromSize;
      const ctx = canvas.getContext('2d');
      const imageData = ctx.createImageData(fromSize, fromSize);
      for (let i = 0; i < fromSize * fromSize; i++) {
        const value = Math.floor(mask[i] * 255);
        imageData.data[i * 4] = value;
        imageData.data[i * 4 + 1] = value;
        imageData.data[i * 4 + 2] = value;
        imageData.data[i * 4 + 3] = 255;
      }
      ctx.putImageData(imageData, 0, 0);
      const outputCanvas = document.createElement('canvas');
      outputCanvas.width = toW;
      outputCanvas.height = toH;
      const outCtx = outputCanvas.getContext('2d');
      outCtx.drawImage(canvas, 0, 0, toW, toH);
      const resized = outCtx.getImageData(0, 0, toW, toH).data;
      const resizedMask = new Float32Array(toW * toH);
      for (let i = 0; i < toW * toH; i++) {
        resizedMask[i] = resized[i * 4] / 255;
      }
      return resizedMask;
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    // 初始化
    window.addEventListener('DOMContentLoaded', () => {
      initEventListeners();
      // 改动：页面加载后立即开始加载模型
      loadModelWithProgress();
    });
  </script>
</body>
</html>